<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Deriv Accumulator ‚Äî AI Sniper Pro</title>
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<style>
:root{
  --green:#00e676;--red:#ff3d71;--blue:#00b0ff;
  --gold:#ffd600;--purple:#c084fc;--orange:#ff9800;
  --bg:#0a0d12;--card:#111620;--card2:#161c26;
  --border:#1e2736;--text:#e6edf3;--sub:#7d8fa3;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;display:flex;flex-direction:column;-webkit-text-size-adjust:100%;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:#2a3444;border-radius:4px;}

/* ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê */
.login-overlay{position:fixed;inset:0;background:linear-gradient(160deg,#0a0d12,#0d1020);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;overflow-y:auto;}
.login-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:28px 22px;max-width:400px;width:100%;text-align:center;box-shadow:0 20px 60px #00000080;}
.login-logo{font-size:44px;margin-bottom:10px;}
.login-title{font-size:20px;font-weight:800;margin-bottom:6px;background:linear-gradient(135deg,#00b0ff,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.login-sub{font-size:12px;color:var(--sub);margin-bottom:20px;line-height:1.6;}
.login-features{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px;text-align:left;}
.login-feat{background:#0a0d12;border:1px solid var(--border);border-radius:10px;padding:10px;display:flex;align-items:flex-start;gap:7px;}
.login-feat-icon{font-size:18px;flex-shrink:0;}
.login-feat-text .t{font-size:11px;font-weight:700;margin-bottom:2px;}
.login-feat-text .s{font-size:9px;color:var(--sub);}
.btn-login{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,#cc2936,#ff444f);color:#fff;font-size:14px;font-weight:800;cursor:pointer;transition:all .2s;margin-bottom:12px;letter-spacing:.3px;text-decoration:none;}
.btn-login:hover{transform:translateY(-2px);box-shadow:0 8px 28px #ff444f50;}
.btn-login svg{width:22px;height:22px;flex-shrink:0;}
.login-note{font-size:10px;color:var(--sub);line-height:1.6;}
.login-note a{color:var(--blue);text-decoration:none;}
.login-divider{display:flex;align-items:center;gap:10px;margin:12px 0;}
.login-divider span{font-size:10px;color:var(--sub);white-space:nowrap;}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--border);}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
header{height:48px;background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 10px;flex-shrink:0;z-index:20;gap:6px;}
.logo{display:flex;align-items:center;gap:5px;flex-shrink:0;}
.logo-icon{width:24px;height:24px;}
.logo-text{font-size:14px;font-weight:800;letter-spacing:-.3px;}
.logo-tag{font-size:7px;font-weight:800;letter-spacing:1px;padding:2px 5px;border-radius:20px;background:linear-gradient(135deg,#cc2936,#ff444f);color:#fff;}
.ai-tag{font-size:7px;font-weight:800;letter-spacing:1px;padding:2px 5px;border-radius:20px;background:linear-gradient(135deg,#6d28d9,#a855f7);color:#fff;animation:aiGlow 2s infinite;}
@keyframes aiGlow{0%,100%{box-shadow:0 0 8px #a855f760;}50%{box-shadow:0 0 20px #a855f7aa;}}
@media(max-width:400px){.logo-tag,.ai-tag{display:none;}}

.hdr-right{display:flex;align-items:center;gap:4px;flex-shrink:0;}
.hdr-badge{display:flex;align-items:center;gap:3px;background:#0a0d12;border:1px solid var(--border);border-radius:6px;padding:3px 7px;font-size:10px;white-space:nowrap;}
.hdr-badge .val{font-weight:700;font-size:11px;}
@media(max-width:480px){.hdr-badge-hide{display:none!important;}}
.ws-pill{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--sub);flex-shrink:0;}
.ws-dot{width:7px;height:7px;border-radius:50%;background:#333;transition:all .3s;flex-shrink:0;}
.ws-dot.on{background:var(--green);box-shadow:0 0 8px var(--green);animation:blink 2s infinite;}
.ws-dot.err{background:var(--red);box-shadow:0 0 8px var(--red);}
.ws-dot.rc{background:var(--gold);animation:rcBlink .5s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.5;}}
@keyframes rcBlink{0%,100%{opacity:1;}50%{opacity:.3;}}

/* ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê */
.layout{display:flex;flex:1;overflow:hidden;position:relative;}

/* ‚ïê‚ïê‚ïê LEFT PANEL ‚ïê‚ïê‚ïê */
.left{width:252px;min-width:252px;background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;transition:transform .28s cubic-bezier(.4,0,.2,1);z-index:15;}
@media(max-width:900px){
  .left{position:absolute;top:0;left:0;height:100%;transform:translateX(-100%);width:280px;min-width:280px;box-shadow:none;}
  .left.open{transform:translateX(0);box-shadow:6px 0 30px #00000090;}
}
.panel-overlay{display:none;position:absolute;inset:0;background:#00000065;z-index:14;backdrop-filter:blur(2px);}
@media(max-width:900px){.panel-overlay.on{display:block;}}

/* ‚ïê‚ïê‚ïê RIGHT PANEL ‚ïê‚ïê‚ïê */
.right{width:240px;min-width:240px;background:var(--card);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;transition:transform .28s cubic-bezier(.4,0,.2,1);z-index:15;}
@media(max-width:1100px){
  .right{position:absolute;top:0;right:0;height:100%;transform:translateX(100%);width:260px;}
  .right.open{transform:translateX(0);box-shadow:-6px 0 30px #00000090;}
}

/* ‚ïê‚ïê‚ïê MOBILE BAR ‚ïê‚ïê‚ïê */
.mobile-bar{display:none;height:42px;background:var(--card);border-bottom:1px solid var(--border);align-items:center;justify-content:space-between;padding:0 8px;flex-shrink:0;z-index:12;}
@media(max-width:900px){.mobile-bar{display:flex;}}
.mob-btn{background:#1e2736;border:none;color:var(--text);border-radius:7px;padding:5px 10px;font-size:11px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:4px;transition:all .2s;-webkit-tap-highlight-color:transparent;}
.mob-btn:active{background:#2a3444;}

.sec{padding:9px 11px;border-bottom:1px solid var(--border);}
.sec-title{font-size:9px;font-weight:700;letter-spacing:1.2px;color:var(--sub);text-transform:uppercase;margin-bottom:7px;}

/* USER CARD */
.user-card{background:linear-gradient(135deg,#0d1a2e,#111a2e);border:1px solid #1e3a5f;border-radius:10px;padding:11px;margin:9px 10px;}
.user-row{display:flex;align-items:center;gap:9px;}
.user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#6d28d9,#a855f7);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}
.user-info .name{font-size:12px;font-weight:700;}
.user-info .uid{font-size:9px;color:var(--sub);margin-top:1px;}
.user-bal{font-size:20px;font-weight:800;color:var(--gold);margin-top:7px;}
.user-bal-lbl{font-size:9px;color:var(--sub);}
.btn-logout{width:100%;margin-top:8px;padding:6px;border:1px solid var(--red);border-radius:7px;background:transparent;color:var(--red);font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;}
.btn-logout:hover{background:#ff3d7115;}

/* ACCOUNT SWITCHER */
.acct-switcher{margin-top:9px;}
.acct-switcher-lbl{font-size:9px;color:var(--sub);text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px;display:flex;align-items:center;gap:5px;}
.acct-drop-wrap{position:relative;}
.acct-drop-btn{width:100%;background:#0a0d12;border:1px solid var(--border);border-radius:7px;color:var(--text);padding:7px 10px;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:6px;transition:all .2s;-webkit-tap-highlight-color:transparent;}
.acct-drop-btn:hover{border-color:var(--blue);}
.acct-drop-btn .acct-cur{display:flex;align-items:center;gap:6px;min-width:0;}
.acct-drop-btn .acct-cur-tag{font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;flex-shrink:0;}
.acct-drop-btn .acct-cur-name{font-size:11px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.acct-drop-btn .acct-cur-bal{font-size:10px;color:var(--gold);font-weight:700;flex-shrink:0;}
.acct-arrow{font-size:10px;color:var(--sub);transition:transform .2s;flex-shrink:0;}
.acct-menu{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--card2);border:1px solid var(--border);border-radius:9px;z-index:200;overflow:hidden;box-shadow:0 8px 28px #00000080;display:none;}
.acct-menu.open{display:block;}
.acct-menu-item{display:flex;align-items:center;gap:8px;padding:9px 11px;cursor:pointer;transition:background .15s;border-bottom:1px solid var(--border);}
.acct-menu-item:last-child{border-bottom:none;}
.acct-menu-item:hover{background:#00b0ff0d;}
.acct-menu-item.active-acct{background:#00e67608;}
.acct-menu-tag{font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;flex-shrink:0;}
.acct-menu-tag.demo{background:#1e2736;color:var(--sub);}
.acct-menu-tag.real{background:#003d1a;color:var(--green);}
.acct-menu-tag.crypto{background:#1a0d2e;color:var(--purple);}
.acct-menu-info{flex:1;min-width:0;}
.acct-menu-id{font-size:11px;font-weight:700;}
.acct-menu-cur{font-size:9px;color:var(--sub);}
.acct-menu-bal{font-size:11px;font-weight:700;color:var(--gold);flex-shrink:0;}
.acct-menu-check{font-size:14px;color:var(--green);flex-shrink:0;opacity:0;}
.acct-menu-item.active-acct .acct-menu-check{opacity:1;}
.acct-switching{opacity:.6;pointer-events:none;}

/* AI ENGINE */
.ai-wrap{padding:11px;border-bottom:1px solid var(--border);background:linear-gradient(160deg,#0e0720,#0a0d12);position:relative;overflow:hidden;}
.ai-wrap::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at top left,#6d28d912,transparent 70%);pointer-events:none;}
.ai-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:9px;}
.ai-lbl{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:700;color:var(--purple);}
.toggle{position:relative;width:46px;height:25px;}
.toggle input{display:none;}
.tslider{position:absolute;inset:0;background:#1e2736;border-radius:25px;cursor:pointer;transition:background .3s;border:1px solid var(--border);}
.tslider:before{content:'';position:absolute;width:19px;height:19px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform .3s;box-shadow:0 1px 5px #0005;}
.toggle input:checked+.tslider{background:linear-gradient(135deg,#6d28d9,#a855f7);border-color:#a855f7;box-shadow:0 0 14px #a855f750;}
.toggle input:checked+.tslider:before{transform:translateX(21px);}
.ai-body{background:#08041a;border:1px solid #6d28d933;border-radius:9px;padding:9px;display:none;}
.ai-body.on{display:block;}
.ai-head-row{display:flex;align-items:center;gap:7px;margin-bottom:9px;padding-bottom:7px;border-bottom:1px solid #6d28d922;}
.brain{font-size:20px;animation:brainPulse 1.2s infinite;}
@keyframes brainPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.12);filter:brightness(1.4);}}
.brain-info .t{font-size:11px;font-weight:700;color:var(--purple);}
.brain-info .s{font-size:9px;color:var(--sub);margin-top:1px;}
.ind-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:7px;}
.ind-card{background:#0f0826;border:1px solid #6d28d920;border-radius:6px;padding:5px 7px;}
.ind-card .lbl{font-size:8px;color:var(--sub);text-transform:uppercase;letter-spacing:.8px;margin-bottom:2px;}
.ind-card .val{font-size:11px;font-weight:700;}
.sig-box{border-radius:7px;padding:8px;text-align:center;margin-bottom:7px;border:1px solid transparent;transition:all .3s;background:#0d1320;}
.sig-box.BUY{border-color:var(--green);background:#00e67612;}
.sig-box.WAIT{border-color:var(--gold);background:#ffd60012;}
.sig-box.SCAN{border-color:var(--purple);background:#a855f712;}
.sig-txt{font-size:14px;font-weight:800;letter-spacing:1px;}
.sig-txt.BUY{color:var(--green);}
.sig-txt.WAIT{color:var(--gold);}
.sig-txt.SCAN{color:var(--purple);}
.sig-sub{font-size:9px;color:var(--sub);margin-top:3px;}
.scan-bar{height:3px;background:#1e2736;border-radius:2px;overflow:hidden;margin-bottom:7px;}
.scan-fill{height:100%;border-radius:2px;width:0%;background:linear-gradient(90deg,#6d28d9,#a855f7,#00e676);background-size:200%;animation:scanGrad .6s linear infinite;transition:width .04s;}
@keyframes scanGrad{0%{background-position:0%;}100%{background-position:200%;}}
.ai-stats{display:flex;justify-content:space-between;}
.aistat .n{font-size:13px;font-weight:700;}
.aistat .l{font-size:8px;color:var(--sub);text-transform:uppercase;margin-top:1px;}

/* VOL SCANNER */
.vol-scanner{background:#060d18;border:1px solid #0060aa44;border-radius:8px;padding:9px;margin-bottom:7px;}
.vol-scan-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;}
.vol-scan-lbl{font-size:10px;font-weight:700;color:var(--blue);display:flex;align-items:center;gap:4px;}
.vol-scan-btn{background:linear-gradient(135deg,#003d6e,#0060aa);border:none;border-radius:5px;color:#fff;font-size:9px;font-weight:700;padding:3px 8px;cursor:pointer;transition:all .2s;}
.vol-item{display:flex;align-items:center;gap:5px;padding:5px 6px;margin-bottom:3px;border-radius:6px;border:1px solid transparent;cursor:pointer;transition:all .2s;background:#0a0d12;}
.vol-item:hover,.vol-item:active{border-color:var(--blue);}
.vol-item.best{border-color:var(--green);background:#00e67608;}
.vol-item.active-sym{border-color:var(--blue);background:#00b0ff10;}
.vol-name{font-size:10px;font-weight:700;flex:1;}
.vol-score-bar{width:44px;height:4px;background:#1e2736;border-radius:2px;overflow:hidden;}
.vol-score-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--red),var(--gold),var(--green));}
.vol-score-num{font-size:9px;font-weight:700;width:22px;text-align:right;}
.vol-badge{font-size:8px;padding:1px 4px;border-radius:3px;font-weight:700;}
.vol-badge.best{background:#00e67622;color:var(--green);}
.vol-badge.good{background:#ffd60022;color:var(--gold);}
.vol-badge.bad{background:#ff3d7122;color:var(--red);}

select,input[type=number]{width:100%;background:#0a0d12;border:1px solid var(--border);color:var(--text);border-radius:6px;padding:7px 9px;font-size:12px;outline:none;transition:border .2s;}
select:focus,input[type=number]:focus{border-color:var(--blue);}
input[type=range]{width:100%;height:4px;accent-color:var(--blue);cursor:pointer;margin-top:4px;padding:0;border:none;background:transparent;}

.sym-list{display:flex;flex-direction:column;gap:4px;}
.sym-btn{background:transparent;border:1px solid var(--border);color:var(--text);border-radius:6px;padding:7px 9px;font-size:11px;cursor:pointer;transition:all .2s;text-align:left;display:flex;align-items:center;justify-content:space-between;-webkit-tap-highlight-color:transparent;}
.sym-btn:hover,.sym-btn:active{border-color:#00b0ff55;background:#00b0ff0a;}
.sym-btn.active{border-color:var(--blue);background:#00b0ff15;color:#fff;font-weight:600;}
.sym-badge{font-size:9px;color:var(--sub);background:#ffffff0d;padding:1px 5px;border-radius:3px;}

.gr-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;}
.gr-btn{background:transparent;border:1px solid var(--border);color:var(--sub);border-radius:5px;padding:7px 0;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;text-align:center;-webkit-tap-highlight-color:transparent;}
.gr-btn:hover,.gr-btn:active{border-color:var(--green);color:var(--green);}
.gr-btn.active{border-color:var(--green);background:#00e67615;color:var(--green);}

.stake-row{display:flex;align-items:center;gap:5px;}
.stake-row input{flex:1;}
.sadj{background:var(--border);border:none;color:var(--text);width:30px;height:30px;border-radius:5px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .2s;-webkit-tap-highlight-color:transparent;}
.sadj:hover,.sadj:active{background:#2a3a4a;}

.tp-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.sw2{position:relative;width:36px;height:20px;}
.sw2 input{display:none;}
.sl2{position:absolute;inset:0;background:var(--border);border-radius:20px;cursor:pointer;transition:background .2s;}
.sl2:before{content:'';position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;top:3px;left:3px;transition:transform .2s;}
.sw2 input:checked+.sl2{background:var(--blue);}
.sw2 input:checked+.sl2:before{transform:translateX(16px);}

.buy-btn{width:100%;padding:12px;border:none;border-radius:8px;background:linear-gradient(135deg,#00a844,#00e676);color:#000;font-size:13px;font-weight:800;cursor:pointer;transition:all .2s;letter-spacing:.3px;-webkit-tap-highlight-color:transparent;}
.buy-btn:hover{transform:translateY(-1px);box-shadow:0 6px 22px #00e67640;}
.buy-btn:active{transform:translateY(0);}

/* ‚ïê‚ïê‚ïê CENTER ‚ïê‚ïê‚ïê */
.center{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
.chart-top{background:var(--card);border-bottom:1px solid var(--border);height:44px;display:flex;align-items:center;padding:0 10px;gap:8px;flex-shrink:0;overflow:hidden;}
.price-main{font-size:20px;font-weight:700;font-variant-numeric:tabular-nums;transition:color .1s;white-space:nowrap;}
@media(min-width:480px){.price-main{font-size:23px;}}
.price-chg{font-size:10px;font-weight:600;padding:2px 5px;border-radius:4px;white-space:nowrap;}
.up{color:var(--green);}.dn{color:var(--red);}
.ub{background:#00e67618;color:var(--green);}
.db{background:#ff3d7118;color:var(--red);}
.chart-meta{margin-left:auto;display:flex;gap:8px;font-size:9px;color:var(--sub);flex-shrink:0;}
@media(max-width:600px){.chart-meta{display:none;}}

.chart-wrap{flex:1;position:relative;overflow:hidden;}
#chart{width:100%;height:100%;}

/* AI OVERLAY */
.ai-ov{position:absolute;top:7px;left:7px;background:#0a0d12e8;backdrop-filter:blur(14px);border:1px solid #6d28d966;border-radius:9px;padding:9px 11px;min-width:155px;z-index:6;display:none;max-width:calc(50% - 14px);}
.ai-ov.on{display:block;}
.ai-ov h5{font-size:9px;color:var(--purple);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;display:flex;align-items:center;gap:5px;}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:livePulse 1s infinite;flex-shrink:0;}
@keyframes livePulse{0%,100%{transform:scale(1);opacity:1;}50%{transform:scale(.5);opacity:.4;}}
.ov-row{display:flex;justify-content:space-between;margin-bottom:3px;font-size:10px;gap:5px;}
.ov-row span:first-child{color:var(--sub);}
.ov-row span:last-child{font-weight:700;text-align:right;}
.ov-hr{border:none;border-top:1px solid #6d28d922;margin:5px 0;}
.sniper-st{font-size:9px;font-weight:700;letter-spacing:.8px;text-align:center;padding:4px 6px;border-radius:5px;margin-top:3px;}
.st-hunt{background:#6d28d920;color:var(--purple);}
.st-lock{background:#00e67618;color:var(--green);}
.st-exit{background:#ff3d7118;color:var(--red);animation:exitPulse .4s infinite;}
@keyframes exitPulse{0%,100%{opacity:1;}50%{opacity:.5;}}

/* BARRIER LEGEND */
.bar-leg{position:absolute;top:7px;right:7px;background:#0a0d12e8;backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:9px;padding:8px 10px;min-width:140px;z-index:6;max-width:calc(50% - 14px);}
.bar-leg h5{font-size:9px;color:var(--sub);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;}
.bar-item{display:flex;align-items:center;justify-content:space-between;margin-bottom:3px;gap:4px;}
.bar-dot{width:9px;height:3px;border-radius:2px;flex-shrink:0;}
.bar-lbl{color:var(--sub);flex:1;font-size:10px;}
.bar-val{font-weight:600;font-variant-numeric:tabular-nums;font-size:10px;}
.bar-sep{border:none;border-top:1px solid var(--border);margin:4px 0;}

/* EXIT METER */
.exit-meter{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:#0a0d12ee;backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:11px;padding:8px 14px;z-index:6;display:none;min-width:240px;max-width:88vw;text-align:center;}
.exit-meter.on{display:block;}
.em-title{font-size:9px;color:var(--sub);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;}
.em-bar{height:6px;background:var(--border);border-radius:4px;overflow:hidden;margin-bottom:4px;}
.em-fill{height:100%;border-radius:4px;transition:width .08s,background .08s;}
.em-labels{display:flex;justify-content:space-between;font-size:8px;color:var(--sub);}
.em-score{font-size:17px;font-weight:800;margin-top:2px;}

.chart-wrap.danger-high::after{content:'‚ö† BARRIER DANGER ‚Äî EXITING';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:var(--red);background:#ff3d7108;border:2px solid var(--red);border-radius:4px;animation:dangerFlash .25s infinite;z-index:5;pointer-events:none;opacity:0;}
.chart-wrap.danger-high.show-danger::after{opacity:1;}
@keyframes dangerFlash{0%,100%{border-color:#ff3d71;}50%{border-color:#ff3d7100;}}

/* ‚ïê‚ïê‚ïê RIGHT PANEL ‚ïê‚ïê‚ïê */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;padding:9px;}
.scard{background:#0a0d12;border:1px solid var(--border);border-radius:7px;padding:8px;}
.scard .sl{font-size:8px;color:var(--sub);margin-bottom:3px;text-transform:uppercase;letter-spacing:.8px;}
.scard .sv{font-size:14px;font-weight:700;font-variant-numeric:tabular-nums;}
.contract-box{margin:0 9px 7px;background:#0a0d12;border:1px solid var(--border);border-radius:9px;overflow:hidden;}
.con-hdr{background:#00e67610;border-bottom:1px solid #00e67628;padding:7px 11px;display:flex;align-items:center;justify-content:space-between;}
.con-hdr h4{font-size:12px;font-weight:700;color:var(--green);}
.con-body{padding:9px 11px;}
.con-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;font-size:11px;}
.con-row span:first-child{color:var(--sub);}
.pnl-bar{height:5px;background:var(--border);border-radius:3px;margin:5px 0;overflow:hidden;}
.pnl-fill{height:100%;border-radius:3px;transition:width .2s,background .2s;}
.sell-btn{background:linear-gradient(135deg,#b91c1c,#ff444f);color:#fff;border:none;border-radius:6px;padding:8px;font-size:12px;font-weight:700;cursor:pointer;width:100%;margin-top:6px;transition:all .2s;}
.sell-btn:hover{box-shadow:0 3px 14px #ff444f50;}
.no-con{text-align:center;color:var(--sub);padding:16px;font-size:11px;}
.no-con .ico{font-size:26px;margin-bottom:5px;}
.bal-flash{animation:balFlash .6s ease;}
@keyframes balFlash{0%{transform:scale(1.2);}50%{color:#fff;}100%{transform:scale(1);}}

/* AI HISTORY */
.ai-hist{padding:0 9px 7px;}
.hist-item{display:flex;align-items:center;gap:5px;padding:5px 7px;margin-bottom:3px;background:#0a0d12;border-radius:6px;border-left:3px solid transparent;font-size:10px;animation:fadeSlide .3s ease;}
.hist-item.w{border-left-color:var(--green);}
.hist-item.l{border-left-color:var(--red);}
.hist-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
@keyframes fadeSlide{from{opacity:0;transform:translateY(-4px);}to{opacity:1;transform:translateY(0);}}

/* TICK FEED */
.tick-wrap{padding:0 9px 9px;flex:1;}
.tick-box{background:#0a0d12;border:1px solid var(--border);border-radius:7px;overflow:hidden;}
.tick-hdr{display:grid;grid-template-columns:1fr 1fr 1fr;padding:5px 9px;font-size:9px;font-weight:700;color:var(--sub);letter-spacing:.8px;text-transform:uppercase;border-bottom:1px solid var(--border);}
.tick-row{display:grid;grid-template-columns:1fr 1fr 1fr;padding:4px 9px;font-size:10px;font-variant-numeric:tabular-nums;border-bottom:1px solid #ffffff03;animation:fadeSlide .2s ease;}

/* STATUS BAR */
.statusbar{height:25px;background:var(--card);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 10px;font-size:10px;color:var(--sub);flex-shrink:0;overflow:hidden;}
.sb-items{display:flex;gap:10px;overflow:hidden;}
.sb-items span{white-space:nowrap;flex-shrink:0;}
@media(max-width:480px){.sb-items span:nth-child(n+3){display:none;}}

/* TOAST */
#toast{position:fixed;bottom:54px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--card2);border:1px solid var(--border);border-radius:9px;padding:8px 16px;font-size:12px;font-weight:500;opacity:0;transition:all .25s;z-index:9999;pointer-events:none;white-space:nowrap;max-width:92vw;text-overflow:ellipsis;overflow:hidden;}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* FLASH BANNERS */
.flash{position:fixed;top:55px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#1a0835,#2d1a52);border:1px solid #a855f7;border-radius:10px;padding:8px 16px;font-size:12px;font-weight:700;color:var(--purple);opacity:0;transition:opacity .2s;z-index:9999;pointer-events:none;box-shadow:0 0 28px #a855f730;display:flex;align-items:center;gap:8px;max-width:92vw;}
.flash.show{opacity:1;}
.exit-flash{position:fixed;top:55px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#220505,#3d0a0a);border:2px solid #ff3d71;border-radius:10px;padding:9px 18px;font-size:13px;font-weight:800;color:#ff6b8a;opacity:0;transition:opacity .15s;z-index:10000;pointer-events:none;box-shadow:0 0 36px #ff3d7150;display:flex;align-items:center;gap:8px;max-width:92vw;}
.exit-flash.show{opacity:1;}
.win-flash{position:fixed;top:55px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#052210,#0a3d1a);border:2px solid #00e676;border-radius:10px;padding:9px 18px;font-size:13px;font-weight:800;color:#4dff9a;opacity:0;transition:opacity .15s;z-index:9998;pointer-events:none;box-shadow:0 0 36px #00e67650;display:flex;align-items:center;gap:8px;max-width:92vw;}
.win-flash.show{opacity:1;}
.pulse{display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulsing 1.5s infinite;}
@keyframes pulsing{0%{box-shadow:0 0 0 0 #00e67660;}70%{box-shadow:0 0 0 8px transparent;}100%{box-shadow:0 0 0 0 transparent;}}

/* VOICE PANEL */
.voice-panel{position:fixed;bottom:50px;right:10px;width:310px;max-width:calc(100vw - 20px);background:linear-gradient(160deg,#0d0820,#111620);border:2px solid #6d28d966;border-radius:16px;box-shadow:0 8px 40px #6d28d930;z-index:9990;overflow:hidden;display:none;flex-direction:column;}
.voice-panel.open{display:flex;}
@media(max-width:480px){.voice-panel{right:0;bottom:50px;width:100%;border-radius:16px 16px 0 0;max-height:60vh;}}
.vp-hdr{background:linear-gradient(135deg,#1a0835,#200d40);padding:9px 13px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #6d28d933;flex-shrink:0;}
.vp-hdr-left{display:flex;align-items:center;gap:7px;}
.vp-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#6d28d9,#a855f7);display:flex;align-items:center;justify-content:center;font-size:16px;position:relative;flex-shrink:0;}
.vp-avatar-ring{position:absolute;inset:-3px;border-radius:50%;border:2px solid transparent;animation:ringPulse 1.5s infinite;}
.vp-avatar-ring.listening{border-color:var(--green);box-shadow:0 0 10px var(--green);}
.vp-avatar-ring.speaking{border-color:var(--purple);box-shadow:0 0 10px var(--purple);animation:ringPulse .5s infinite;}
@keyframes ringPulse{0%,100%{opacity:1;}50%{opacity:.3;}}
.vp-name{font-size:11px;font-weight:800;color:#fff;}
.vp-status{font-size:9px;color:var(--sub);margin-top:1px;}
.vp-close{background:none;border:none;color:var(--sub);cursor:pointer;font-size:17px;padding:0;transition:color .2s;}
.vp-close:hover{color:var(--red);}
.vp-chat{height:160px;overflow-y:auto;padding:7px 11px;display:flex;flex-direction:column;gap:5px;}
.vp-msg{max-width:88%;padding:6px 10px;border-radius:10px;font-size:11px;line-height:1.5;animation:fadeSlide .2s ease;}
.vp-msg.ai{background:#1a0835;border:1px solid #6d28d933;color:#e0d0ff;border-radius:10px 10px 10px 0;}
.vp-msg.user{background:#0d3a6e;border:1px solid #00b0ff33;color:#cce8ff;margin-left:auto;border-radius:10px 10px 0 10px;}
.vp-msg-time{font-size:8px;color:var(--sub);margin-top:2px;}
.vp-wave{display:flex;align-items:center;gap:3px;padding:4px 11px;justify-content:center;min-height:28px;flex-shrink:0;}
.vp-bar{width:3px;border-radius:2px;background:var(--purple);animation:waveAnim .6s ease-in-out infinite;opacity:0;}
.vp-bar:nth-child(1){animation-delay:0s;height:7px;}
.vp-bar:nth-child(2){animation-delay:.1s;height:12px;}
.vp-bar:nth-child(3){animation-delay:.2s;height:18px;}
.vp-bar:nth-child(4){animation-delay:.3s;height:12px;}
.vp-bar:nth-child(5){animation-delay:.4s;height:7px;}
.vp-bar:nth-child(6){animation-delay:.2s;height:15px;}
.vp-bar:nth-child(7){animation-delay:.1s;height:10px;}
.vp-bar.active{opacity:1;}
@keyframes waveAnim{0%,100%{transform:scaleY(1);}50%{transform:scaleY(1.8);}}
.vp-input-row{display:flex;gap:6px;padding:8px 9px;border-top:1px solid #6d28d922;align-items:center;flex-shrink:0;}
.vp-text-input{flex:1;background:#0a0d12;border:1px solid #6d28d944;color:#fff;border-radius:8px;padding:7px 9px;font-size:11px;outline:none;transition:border .2s;}
.vp-text-input:focus{border-color:var(--purple);}
.vp-text-input::placeholder{color:#4a3566;}
.vp-send{background:linear-gradient(135deg,#6d28d9,#a855f7);border:none;border-radius:7px;color:#fff;padding:7px 10px;cursor:pointer;font-size:12px;transition:all .2s;flex-shrink:0;}
.vp-mic-btn{width:31px;height:31px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s;flex-shrink:0;background:#1e2736;}
.vp-mic-btn.listening{background:var(--green);animation:micPulse .5s infinite;}
@keyframes micPulse{0%,100%{box-shadow:0 0 0 0 #00e67660;}50%{box-shadow:0 0 0 7px #00e67600;}}

/* VOICE FAB */
.voice-fab{position:fixed;bottom:50px;right:10px;width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#6d28d9,#a855f7);border:none;cursor:pointer;font-size:19px;box-shadow:0 4px 18px #a855f750;z-index:9991;transition:all .3s;display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent;}
.voice-fab:hover{transform:scale(1.1);}
.voice-fab.active{animation:fabPulse 1s infinite;}
@keyframes fabPulse{0%,100%{box-shadow:0 4px 18px #a855f750;}50%{box-shadow:0 4px 28px #a855f7aa;}}

/* SCAN MODAL */
.scan-overlay{position:fixed;inset:0;background:#000000aa;z-index:8000;display:none;align-items:center;justify-content:center;padding:14px;}
.scan-overlay.open{display:flex;}
.scan-modal{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;width:370px;max-width:100%;max-height:90vh;overflow-y:auto;}
.scan-modal h3{font-size:13px;font-weight:800;color:var(--purple);margin-bottom:4px;display:flex;align-items:center;gap:7px;}
.scan-modal p{font-size:10px;color:var(--sub);margin-bottom:10px;}
.scan-progress{height:5px;background:var(--border);border-radius:3px;overflow:hidden;margin-bottom:10px;}
.scan-progress-fill{height:100%;background:linear-gradient(90deg,#6d28d9,#a855f7);width:0%;transition:width .2s;border-radius:3px;}
.scan-results{display:flex;flex-direction:column;gap:6px;}
.scan-result-item{background:#0a0d12;border:1px solid var(--border);border-radius:9px;padding:8px 10px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:all .2s;}
.scan-result-item:hover{border-color:var(--blue);}
.scan-result-item.winner{border-color:var(--green);background:#00e67608;}
.sri-bar-row{display:flex;align-items:center;gap:4px;margin-bottom:3px;}
.sri-bar-lbl{font-size:8px;color:var(--sub);width:48px;}
.sri-bar-bg{flex:1;height:4px;background:#1e2736;border-radius:2px;overflow:hidden;}
.sri-bar-fill{height:100%;border-radius:2px;}
.sri-score{font-size:15px;font-weight:800;width:34px;text-align:right;}
.scan-close{width:100%;margin-top:10px;padding:8px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--sub);cursor:pointer;font-size:12px;}
.scan-close:hover{border-color:var(--red);color:var(--red);}

/* BOTTOM NAV */
.bottom-nav{display:none;height:50px;background:var(--card);border-top:1px solid var(--border);align-items:center;justify-content:space-around;flex-shrink:0;z-index:16;}
@media(max-width:480px){.bottom-nav{display:flex;}}
.bnav-btn{background:none;border:none;color:var(--sub);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:2px;font-size:8px;padding:5px 8px;border-radius:8px;transition:all .2s;-webkit-tap-highlight-color:transparent;min-width:52px;}
.bnav-btn.active{color:var(--blue);}
.bnav-btn span:first-child{font-size:18px;}
@media(max-width:480px){.voice-fab{bottom:62px;}.voice-panel{bottom:62px;}}

/* Connection status overlay */
.conn-banner{position:fixed;top:50px;left:0;right:0;background:#ff3d71;color:#fff;text-align:center;font-size:11px;font-weight:700;padding:5px;z-index:8999;display:none;}
.conn-banner.show{display:block;}
</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-card">
    <div class="login-logo">üéØ</div>
    <div class="login-title">Deriv Accumulator AI Sniper</div>
    <div class="login-sub">Connect your Deriv account and let the AI Sniper auto-trade with ultra-precise barrier exit detection.</div>
    <div class="login-features">
      <div class="login-feat"><div class="login-feat-icon">ü§ñ</div><div class="login-feat-text"><div class="t">AI Sniper Engine</div><div class="s">100-tick neural barrier analysis</div></div></div>
      <div class="login-feat"><div class="login-feat-icon">üé§</div><div class="login-feat-text"><div class="t">Voice AI ‚Äî ARIA</div><div class="s">English & Kiswahili, always on</div></div></div>
      <div class="login-feat"><div class="login-feat-icon">üî≠</div><div class="login-feat-text"><div class="t">Volatility Scanner</div><div class="s">Auto-selects best market</div></div></div>
      <div class="login-feat"><div class="login-feat-icon">üí∞</div><div class="login-feat-text"><div class="t">Live Balance</div><div class="s">Real-time updates on every trade</div></div></div>
    </div>
    <a class="btn-login" id="loginBtn" href="#">
      <svg viewBox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="48" fill="#CC2936"/><path d="M28 72 L50 28 L72 72 Z" fill="white"/></svg>
      Login with Deriv Account
    </a>
    <div class="login-divider"><span>OR</span></div>
    <button class="btn-login" id="demoBtn" style="background:linear-gradient(135deg,#1e2736,#2a3444);font-size:13px;">
      üëÅ Demo Mode (Watch Only)
    </button>
    <div class="login-note">
      By connecting you agree to Deriv's <a href="https://deriv.com/terms-and-conditions" target="_blank">Terms</a>. Token never stored permanently. Powered by Deriv API.
    </div>
  </div>
</div>

<div class="conn-banner" id="connBanner">‚ö† Reconnecting to Deriv WebSocket‚Ä¶</div>

<header>
  <div class="logo">
    <button id="menuBtn" style="display:none;background:transparent;border:none;font-size:20px;color:var(--text);cursor:pointer;padding:4px;-webkit-tap-highlight-color:transparent;">‚ò∞</button>
    <svg class="logo-icon" viewBox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="48" fill="#CC2936"/><path d="M28 72 L50 28 L72 72 Z" fill="white"/></svg>
    <span class="logo-text">Deriv</span>
    <span class="logo-tag">ACCUMULATOR</span>
    <span class="ai-tag">üéØ AI</span>
  </div>
  <div class="hdr-right">
    <div class="hdr-badge" style="border-color:#ffd60044;">
      üí∞ <span class="val" id="hBalance" style="color:var(--gold);">‚Äî</span>
    </div>
    <div class="hdr-badge hdr-badge-hide" style="border-color:#00e67644;">
      ‚úÖ <span class="val" id="hWins" style="color:var(--green);">0W</span>
    </div>
    <div class="hdr-badge hdr-badge-hide" id="hPnlBadge" style="border-color:#00e67644;display:none;">
      üìà <span class="val" id="hPnl" style="color:var(--green);">$0</span>
    </div>
    <div class="ws-pill">
      <div class="ws-dot" id="wsDot"></div>
      <span id="wsLbl" style="display:none;"></span>
    </div>
    <button id="rightPanelBtn" style="display:none;" class="mob-btn">üìä</button>
  </div>
</header>

<div class="mobile-bar" id="mobileBar">
  <button class="mob-btn" id="mobLeft">‚ò∞ Controls</button>
  <div style="font-size:11px;font-weight:700;" id="mobPrice">‚Äî</div>
  <button class="mob-btn" id="mobRight">üìä Stats</button>
</div>

<div class="layout">
  <div class="panel-overlay" id="panelOverlay"></div>

  <!-- LEFT PANEL -->
  <div class="left" id="leftPanel">

    <div class="sec" id="userSection" style="display:none;">
      <div class="user-card">
        <div class="user-row">
          <div class="user-avatar" id="userAvatar">üë§</div>
          <div class="user-info">
            <div class="name" id="userName">‚Äî</div>
            <div class="uid" id="userUid">‚Äî</div>
          </div>
        </div>
        <div class="user-bal-lbl" style="margin-top:7px;">Live Balance</div>
        <div class="user-bal" id="userBal">‚Äî</div>

        <!-- ACCOUNT SWITCHER -->
        <div class="acct-switcher" id="acctSwitcher" style="display:none;">
          <div class="acct-switcher-lbl">üîÑ Account Type</div>
          <div class="acct-drop-wrap">
            <button class="acct-drop-btn" id="acctDropBtn" onclick="toggleAcctMenu()">
              <div class="acct-cur">
                <span class="acct-cur-tag" id="acctCurTag" style="background:#003d1a;color:var(--green);">REAL</span>
                <span class="acct-cur-name" id="acctCurName">Loading‚Ä¶</span>
              </div>
              <div style="display:flex;align-items:center;gap:5px;">
                <span class="acct-cur-bal" id="acctCurBal">‚Äî</span>
                <span class="acct-arrow" id="acctArrow">‚ñº</span>
              </div>
            </button>
            <div class="acct-menu" id="acctMenu"></div>
          </div>
        </div>

        <button class="btn-logout" id="logoutBtn">‚úï Logout</button>
      </div>
    </div>

    <div class="ai-wrap">
      <div class="ai-row">
        <div class="ai-lbl"><span style="font-size:15px;">ü§ñ</span> AI Sniper Engine</div>
        <label class="toggle"><input type="checkbox" id="aiToggle"><div class="tslider"></div></label>
      </div>
      <div class="ai-body" id="aiBody">
        <div class="ai-head-row">
          <div class="brain">üß†</div>
          <div class="brain-info">
            <div class="t">Neural Exit Sniper v6</div>
            <div class="s">100-tick ¬∑ Auto-volatility ¬∑ Voice AI</div>
          </div>
        </div>
        <div class="vol-scanner">
          <div class="vol-scan-hdr">
            <div class="vol-scan-lbl">üî≠ Volatility Scanner</div>
            <button class="vol-scan-btn" id="scanVolBtn">‚ö° SCAN</button>
          </div>
          <div id="volScanList"><div style="text-align:center;color:var(--sub);font-size:10px;padding:6px;">Scanning on AI start‚Ä¶</div></div>
        </div>
        <div class="ind-grid">
          <div class="ind-card"><div class="lbl">Trend</div><div class="val" id="iTrend" style="color:var(--sub);">‚Äî</div></div>
          <div class="ind-card"><div class="lbl">Momentum</div><div class="val" id="iMom" style="color:var(--sub);">‚Äî</div></div>
          <div class="ind-card"><div class="lbl">RSI-14</div><div class="val" id="iRsi" style="color:var(--sub);">‚Äî</div></div>
          <div class="ind-card"><div class="lbl">Volatility</div><div class="val" id="iVol" style="color:var(--sub);">‚Äî</div></div>
          <div class="ind-card"><div class="lbl">Exit Risk</div><div class="val" id="iExit" style="color:var(--sub);">‚Äî</div></div>
          <div class="ind-card"><div class="lbl">Hold Score</div><div class="val" id="iHold" style="color:var(--sub);">‚Äî</div></div>
        </div>
        <div class="sig-box SCAN" id="sigBox">
          <div class="sig-txt SCAN" id="sigTxt">SCANNING‚Ä¶</div>
          <div class="sig-sub" id="sigSub">Collecting tick data‚Ä¶</div>
        </div>
        <div class="scan-bar"><div class="scan-fill" id="scanFill"></div></div>
        <div class="ai-stats">
          <div class="aistat" style="text-align:center;"><div class="n" id="stWins" style="color:var(--green);">0</div><div class="l">Wins</div></div>
          <div class="aistat" style="text-align:center;"><div class="n" id="stLoss" style="color:var(--red);">0</div><div class="l">Loss</div></div>
          <div class="aistat" style="text-align:center;"><div class="n" id="stWR" style="color:var(--gold);">‚Äî</div><div class="l">Win%</div></div>
          <div class="aistat" style="text-align:center;"><div class="n" id="stPnl" style="color:var(--green);">$0</div><div class="l">P&L</div></div>
        </div>
      </div>
    </div>

    <div class="sec">
      <div class="sec-title">Volatility Index</div>
      <div class="sym-list" id="symList">
        <button class="sym-btn active" data-sym="R_10" data-dp="3">Volatility 10 <span class="sym-badge">V10</span></button>
        <button class="sym-btn" data-sym="R_25" data-dp="3">Volatility 25 <span class="sym-badge">V25</span></button>
        <button class="sym-btn" data-sym="R_50" data-dp="4">Volatility 50 <span class="sym-badge">V50</span></button>
        <button class="sym-btn" data-sym="R_75" data-dp="4">Volatility 75 <span class="sym-badge">V75</span></button>
        <button class="sym-btn" data-sym="R_100" data-dp="2">Volatility 100 <span class="sym-badge">V100</span></button>
      </div>
    </div>

    <div class="sec">
      <div class="sec-title">Growth Rate</div>
      <div class="gr-grid" id="grGrid">
        <button class="gr-btn" data-r="1">1%</button>
        <button class="gr-btn active" data-r="2">2%</button>
        <button class="gr-btn" data-r="3">3%</button>
        <button class="gr-btn" data-r="4">4%</button>
        <button class="gr-btn" data-r="5">5%</button>
      </div>
    </div>

    <div class="sec">
      <div class="sec-title">Stake Amount</div>
      <div class="stake-row">
        <button class="sadj" id="stkDn">‚àí</button>
        <input type="number" id="stkInput" value="10" min="1" max="50000" step="1"/>
        <button class="sadj" id="stkUp">+</button>
      </div>
      <input type="range" id="stkRange" min="1" max="1000" value="10"/>
    </div>

    <div class="sec">
      <div class="tp-hdr">
        <div class="sec-title" style="margin:0;">Take Profit</div>
        <label class="sw2"><input type="checkbox" id="tpToggle"><div class="sl2"></div></label>
      </div>
      <input type="number" id="tpInput" value="50" min="1" disabled style="opacity:.4;"/>
    </div>

    <div class="sec">
      <div class="sec-title">Contract Info</div>
      <div style="display:flex;flex-direction:column;gap:5px;">
        <div style="display:flex;justify-content:space-between;font-size:11px;"><span style="color:var(--sub);">Barrier dist.</span><span id="infoBarrier">‚Äî</span></div>
        <div style="display:flex;justify-content:space-between;font-size:11px;"><span style="color:var(--sub);">Buffer</span><span id="infoBuf" style="color:var(--blue);">0/100</span></div>
        <div style="display:flex;justify-content:space-between;font-size:11px;"><span style="color:var(--sub);">Hold Score</span><span id="infoHold" style="color:var(--green);">‚Äî</span></div>
      </div>
    </div>

    <div class="sec" style="border-bottom:none;">
      <button class="buy-btn" id="buyBtn">‚ñ≤ Buy Accumulator</button>
    </div>
  </div>

  <!-- CENTER -->
  <div class="center">
    <div class="chart-top">
      <div style="display:flex;align-items:center;gap:6px;min-width:0;">
        <span class="price-main" id="priceEl">‚Äî</span>
        <span class="price-chg" id="priceChg">‚Äî</span>
      </div>
      <div class="chart-meta">
        <span id="metaH">H:‚Äî</span><span>|</span>
        <span id="metaL">L:‚Äî</span><span>|</span>
        <span id="metaLat" style="color:var(--green);">‚Äîms</span>
      </div>
    </div>
    <div class="chart-wrap" id="chartWrap">
      <div id="chart"></div>
      <div class="ai-ov" id="aiOv">
        <h5><div class="live-dot"></div> SNIPER AI</h5>
        <div class="ov-row"><span>Trend</span><span id="ovTrend">‚Äî</span></div>
        <div class="ov-row"><span>RSI</span><span id="ovRsi">‚Äî</span></div>
        <div class="ov-row"><span>Exit Risk</span><span id="ovExitRisk">‚Äî</span></div>
        <div class="ov-row"><span>Hold</span><span id="ovHold">‚Äî</span></div>
        <div class="ov-row"><span>Signal</span><span id="ovSig" style="font-weight:800;">‚Äî</span></div>
        <hr class="ov-hr"/>
        <div class="sniper-st st-hunt" id="sniperSt">üéØ HUNTING</div>
      </div>
      <div class="bar-leg">
        <h5>Barriers</h5>
        <div class="bar-item"><div class="bar-dot" style="background:var(--green);"></div><span class="bar-lbl">Upper</span><span class="bar-val" id="bUpper">‚Äî</span></div>
        <div class="bar-item"><div class="bar-dot" style="background:var(--red);"></div><span class="bar-lbl">Lower</span><span class="bar-val" id="bLower">‚Äî</span></div>
        <div class="bar-item"><div class="bar-dot" style="background:var(--blue);opacity:.6;"></div><span class="bar-lbl">Entry</span><span class="bar-val" id="bEntry">‚Äî</span></div>
        <hr class="bar-sep"/>
        <div class="bar-item"><span style="font-size:9px;color:var(--sub);">Safety</span><span class="bar-val" id="bSafety" style="font-size:11px;">‚Äî</span></div>
      </div>
      <div class="exit-meter" id="exitMeter">
        <div class="em-title">‚ö° SNIPER EXIT SENSOR</div>
        <div class="em-bar"><div class="em-fill" id="emFill" style="width:0%;background:var(--green);"></div></div>
        <div class="em-labels"><span>SAFE</span><span id="emPct" style="font-weight:700;font-size:10px;">0%</span><span>EXIT!</span></div>
        <div class="em-score" id="emScore" style="color:var(--green);">HOLD</div>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right" id="rightPanel">
    <div class="stat-grid">
      <div class="scard"><div class="sl">Ticks</div><div class="sv" id="sTicks" style="color:var(--blue);">0</div></div>
      <div class="scard"><div class="sl">Growth</div><div class="sv" id="sGrowth" style="color:var(--green);">2%</div></div>
      <div class="scard"><div class="sl">P&L</div><div class="sv" id="sPnl">$0.00</div></div>
      <div class="scard"><div class="sl">Payout</div><div class="sv" id="sPayout" style="color:var(--gold);">$0.00</div></div>
    </div>
    <div style="padding:0 9px 5px;"><div class="sec-title">Active Contract</div></div>
    <div id="conPanel"></div>
    <div style="padding:0 9px 5px;display:flex;align-items:center;gap:5px;">
      <span class="pulse" id="feedPulse" style="opacity:0;"></span>
      <div class="sec-title" style="margin:0;">AI Trade Log</div>
    </div>
    <div class="ai-hist" id="aiHist"><div style="text-align:center;color:var(--sub);font-size:11px;padding:8px;">No trades yet‚Ä¶</div></div>
    <div class="tick-wrap">
      <div class="sec-title" style="margin-bottom:5px;">Live Ticks</div>
      <div class="tick-box">
        <div class="tick-hdr"><span>Price</span><span>Change</span><span>Time</span></div>
        <div id="tickFeed" style="max-height:150px;overflow-y:auto;"></div>
      </div>
    </div>
  </div>
</div>

<div class="statusbar">
  <div class="sb-items">
    <span id="sbSym">R_10</span>
    <span id="sbPing">Ping:‚Äî</span>
    <span id="sbAuth" style="color:var(--sub);">Demo</span>
    <span id="sbAI" style="color:var(--sub);">AI:OFF</span>
  </div>
  <span id="sbTime">‚Äî</span>
</div>

<div class="bottom-nav" id="bottomNav">
  <button class="bnav-btn" id="bnLeft"><span>‚ò∞</span><span>Controls</span></button>
  <button class="bnav-btn active" id="bnChart"><span>üìà</span><span>Chart</span></button>
  <button class="bnav-btn" id="bnRight"><span>üìä</span><span>Stats</span></button>
  <button class="bnav-btn" id="bnVoice"><span>üé§</span><span>ARIA</span></button>
</div>

<!-- VOICE PANEL -->
<div class="voice-panel" id="voicePanel">
  <div class="vp-hdr">
    <div class="vp-hdr-left">
      <div class="vp-avatar">ü§ñ<div class="vp-avatar-ring" id="avatarRing"></div></div>
      <div><div class="vp-name">ARIA üü¢ Always Listening</div><div class="vp-status" id="vpStatus">Starting‚Ä¶</div></div>
    </div>
    <button class="vp-close" id="vpClose">‚úï</button>
  </div>
  <div class="vp-chat" id="vpChat"></div>
  <div class="vp-wave">
    <div class="vp-bar" id="vb1"></div><div class="vp-bar" id="vb2"></div><div class="vp-bar" id="vb3"></div>
    <div class="vp-bar" id="vb4"></div><div class="vp-bar" id="vb5"></div><div class="vp-bar" id="vb6"></div>
    <div class="vp-bar" id="vb7"></div>
  </div>
  <div class="vp-input-row">
    <button class="vp-mic-btn" id="micBtn">üé§</button>
    <input class="vp-text-input" id="vpTextInput" placeholder="Type in English or Kiswahili‚Ä¶" autocomplete="off"/>
    <button class="vp-send" id="vpSend">Send</button>
  </div>
</div>
<button class="voice-fab" id="voiceFab">üé§</button>

<!-- SCAN MODAL -->
<div class="scan-overlay" id="scanOverlay">
  <div class="scan-modal">
    <h3>üî≠ Scanning Volatility Indices‚Ä¶</h3>
    <p>Analyzing stability, barrier longevity & momentum for each market</p>
    <div class="scan-progress"><div class="scan-progress-fill" id="scanProgressFill"></div></div>
    <div class="scan-results" id="scanResults"></div>
    <button class="scan-close" id="scanClose">‚úï Close</button>
  </div>
</div>

<div id="toast"></div>
<div class="flash" id="flashBuy"><span>üéØ</span><span id="flashBuyTxt">AI ENTERING‚Ä¶</span></div>
<div class="exit-flash" id="flashExit"><span>üö®</span><span id="flashExitTxt">SNIPER EXIT!</span></div>
<div class="win-flash" id="flashWin"><span>‚úÖ</span><span id="flashWinTxt">WIN!</span></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const APP_ID = '129093';
const WS_URL = 'wss://ws.binaryws.com/websockets/v3?app_id=' + APP_ID;
const TICK_BUF = 100;
const MAX_FEED = 40;
const ALL_SYMS = [
  {sym:'R_10',dp:3,name:'V10'},{sym:'R_25',dp:3,name:'V25'},
  {sym:'R_50',dp:4,name:'V50'},{sym:'R_75',dp:4,name:'V75'},
  {sym:'R_100',dp:2,name:'V100'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ws=null, wsAlive=false, pingTimer=null, pingT=0, lat=0;
let reconnDelay=1000, reconnTimer=null, connTO=null, appReady=false;
let sym='R_10', dp=3, gr=2, stake=10, tp=null;
let token='', authed=false, userInfo={}, userCurrency='USD';
let isBuying=false;
// Multi-account
let allTokens={}; // {loginid: token}
let accountList=[]; // [{loginid, currency, account_type, balance, token}]
let activeLoginid='';
let priceHist=[], tickBuf=[], prevP=null;
let hi=-Infinity, lo=Infinity;
let symBufs={};
let chart=null, area=null, lineU=null, lineL=null, lineE=null;
let con=null, exitingNow=false;
let realBalance=null;
let aiOn=false, aiWins=0, aiLoss=0, aiTrades=0, aiPnl=0;
let aiCool=false, phase='IDLE', scanAnim=0, exitProbability=0;
let volScores={}, lastVolAutoSwitch=0;
let ticksHeldAfterEntry=0;
const MIN_HOLD_TICKS=6;
const EXIT_THRESHOLD=50;
let voiceRunning=false, voiceOpen=false, isSpeaking=false, isListening=false;
let recognition=null, ariaVoice=null, voiceRestartTimer=null;
const synth=window.speechSynthesis;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const $=id=>document.getElementById(id);
const now=()=>Date.now();

function toast(msg,col,dur){
  const t=$('toast');t.textContent=msg;
  t.style.borderColor=col==='g'?'var(--green)':col==='r'?'var(--red)':col==='p'?'var(--purple)':col==='y'?'var(--gold)':'var(--border)';
  t.classList.add('show');clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.classList.remove('show'),dur||3800);
}
function showFlash(id,msg,dur){
  const el=$(id);el.querySelector('span:last-child').textContent=msg;
  el.classList.add('show');clearTimeout(el._t);
  el._t=setTimeout(()=>el.classList.remove('show'),dur||2200);
}
function flashBalance(){
  const el=$('hBalance');el.classList.remove('bal-flash');void el.offsetWidth;el.classList.add('bal-flash');
  setTimeout(()=>el.classList.remove('bal-flash'),700);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OAUTH ‚Äî Parse token from URL redirect
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getOAuthURL(){
  return 'https://oauth.deriv.com/oauth2/authorize?app_id='+APP_ID+'&l=EN&brand=deriv';
}
function parseOAuthToken(){
  const p=new URLSearchParams(window.location.search);
  // Collect all tokens (Deriv sends token1, account1, token2, account2, etc.)
  allTokens={};
  for(let i=1;i<=10;i++){
    const t=p.get('token'+i);
    const a=p.get('acct'+i);
    const c=p.get('cur'+i);
    if(t&&a){allTokens[a]={token:t,currency:c||'USD'};}
  }
  // Return first token found
  for(let i=1;i<=10;i++){const t=p.get('token'+i);if(t)return t;}
  return null;
}

function parseStoredTokens(){
  try{
    const s=localStorage.getItem('deriv_accounts');
    if(s){allTokens=JSON.parse(s);}
  }catch(e){}
}
function initLogin(){
  const urlTok=parseOAuthToken();
  if(urlTok){
    token=urlTok;
    try{window.history.replaceState({},'',window.location.pathname);}catch(e){}
    hideLogin();return;
  }
  const saved=localStorage.getItem('deriv_tk');
  if(saved){token=saved;hideLogin();return;}
  showLogin();
}
function showLogin(){
  $('loginOverlay').style.display='flex';
  $('loginBtn').href=getOAuthURL();
}
function hideLogin(){
  $('loginOverlay').style.display='none';
  bootApp();
}
function logout(){
  localStorage.removeItem('deriv_tk');
  token='';authed=false;userInfo={};realBalance=null;
  if(con)closeContract('Logout',false);
  if(ws){try{ws.onopen=ws.onmessage=ws.onerror=ws.onclose=null;ws.close();}catch(e){}}
  ws=null;wsAlive=false;
  $('loginOverlay').style.display='flex';
  $('userSection').style.display='none';
  $('hBalance').textContent='‚Äî';
  $('sbAuth').textContent='Demo';$('sbAuth').style.color='var(--sub)';
  setDot('rc');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHART
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initChart(){
  const el=$('chart');
  if(chart){try{chart.remove();}catch(e){}}
  chart=LightweightCharts.createChart(el,{
    layout:{background:{color:'#0a0d12'},textColor:'#7d8fa3'},
    grid:{vertLines:{color:'#1e273606'},horzLines:{color:'#1e273614'}},
    crosshair:{mode:LightweightCharts.CrosshairMode.Normal,vertLine:{color:'#ffffff18',width:1},horzLine:{color:'#ffffff18',width:1}},
    rightPriceScale:{borderColor:'#1e2736',scaleMargins:{top:0.1,bottom:0.1}},
    timeScale:{borderColor:'#1e2736',timeVisible:true,secondsVisible:true,rightOffset:10},
    handleScroll:true,handleScale:true,
  });
  area=chart.addAreaSeries({
    lineColor:'#00b0ff',topColor:'#00b0ff22',bottomColor:'#00b0ff00',lineWidth:2,
    priceFormat:{type:'price',precision:dp,minMove:Math.pow(10,-dp)},
    lastValueVisible:true,priceLineVisible:true,
  });
  const ro=new ResizeObserver(()=>{
    if(chart)chart.applyOptions({width:el.clientWidth,height:el.clientHeight});
  });
  ro.observe(el);
  setTimeout(()=>{if(chart)chart.applyOptions({width:el.clientWidth,height:el.clientHeight});},100);
}
function mkLine(color,title,style,width){
  return chart.addLineSeries({
    color,lineWidth:width||1,
    lineStyle:style!==undefined?style:LightweightCharts.LineStyle.Solid,
    lastValueVisible:true,priceLineVisible:false,crosshairMarkerVisible:false,title,
    priceFormat:{type:'price',precision:dp,minMove:Math.pow(10,-dp)},
  });
}
function drawBarriers(){
  clearBarriers();if(!con||!chart)return;
  lineU=mkLine('#00e676','Upper',LightweightCharts.LineStyle.Solid,2);
  lineL=mkLine('#ff3d71','Lower',LightweightCharts.LineStyle.Solid,2);
  lineE=mkLine('#00b0ff55','Entry',LightweightCharts.LineStyle.Dashed,1);
  if(priceHist.length>0){
    const last50=priceHist.slice(-50);
    lineU.setData(last50.map(p=>({time:p.time,value:con.upper})));
    lineL.setData(last50.map(p=>({time:p.time,value:con.lower})));
    lineE.setData(last50.map(p=>({time:p.time,value:con.entry})));
  }
}
function appendBarrierPts(t){
  if(!con)return;
  try{if(lineU)lineU.update({time:t,value:con.upper});}catch(e){}
  try{if(lineL)lineL.update({time:t,value:con.lower});}catch(e){}
  try{if(lineE)lineE.update({time:t,value:con.entry});}catch(e){}
}
function clearBarriers(){
  [lineU,lineL,lineE].forEach(s=>{if(s)try{chart.removeSeries(s);}catch(e){}});
  lineU=lineL=lineE=null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEBSOCKET ‚Äî Robust connection
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function connect(){
  // Close existing
  if(ws){
    try{ws.onopen=ws.onmessage=ws.onerror=ws.onclose=null;ws.close();}catch(e){}
    ws=null;
  }
  clearTimeout(reconnTimer);clearTimeout(connTO);clearInterval(pingTimer);
  wsAlive=false;setDot('rc');
  $('connBanner').classList.add('show');

  try{ws=new WebSocket(WS_URL);}catch(e){schedReconn();return;}

  connTO=setTimeout(()=>{
    if(ws&&ws.readyState!==1){
      try{ws.close();}catch(e){}
      schedReconn();
    }
  },9000);

  ws.onopen=()=>{
    clearTimeout(connTO);
    wsAlive=true;reconnDelay=1000;
    setDot('on');
    $('connBanner').classList.remove('show');

    // 1. Authorize if we have a token
    if(token){
      ws.send(JSON.stringify({authorize:token}));
    }

    // 2. Subscribe to ticks for current symbol
    ws.send(JSON.stringify({ticks:sym,subscribe:1}));

    // 3. Subscribe to all other symbols for scanner (background)
    ALL_SYMS.forEach(s=>{
      if(s.sym!==sym)ws.send(JSON.stringify({ticks:s.sym,subscribe:1}));
    });

    // 4. Ping keepalive
    pingTimer=setInterval(()=>{
      if(ws&&ws.readyState===1){pingT=now();ws.send(JSON.stringify({ping:1}));}
      else{clearInterval(pingTimer);}
    },4000);
  };

  ws.onmessage=e=>{
    try{handle(JSON.parse(e.data));}catch(err){console.warn('WS parse error',err);}
  };

  ws.onerror=e=>{
    clearTimeout(connTO);
    console.warn('WS error',e);
  };

  ws.onclose=e=>{
    clearTimeout(connTO);clearInterval(pingTimer);
    wsAlive=false;setDot('rc');
    $('connBanner').classList.add('show');
    console.log('WS closed, code:',e.code,'reason:',e.reason);
    schedReconn();
  };
}

function schedReconn(){
  clearTimeout(reconnTimer);
  reconnTimer=setTimeout(()=>{
    reconnDelay=Math.min(reconnDelay*1.6,18000);
    connect();
  },reconnDelay);
}

function send(obj){
  if(ws&&ws.readyState===1){ws.send(JSON.stringify(obj));return true;}
  return false;
}

function setDot(state){
  const d=$('wsDot');
  d.className='ws-dot '+(state==='on'?'on':state==='err'?'err':'rc');
  $('wsLbl').textContent=state==='on'?'Live':state==='err'?'Error':'‚Ä¶';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MESSAGE HANDLER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handle(d){
  if(!d||!d.msg_type)return;
  const t=d.msg_type;

  if(t==='pong'){
    lat=now()-pingT;
    $('metaLat').textContent=lat+'ms';
    $('metaLat').style.color=lat<120?'var(--green)':lat<350?'var(--gold)':'var(--red)';
    $('sbPing').textContent='Ping:'+lat+'ms';
    return;
  }

  if(t==='authorize'){
    if(d.error){
      toast('‚ùå Auth failed: '+(d.error.message||'bad token'),'r',5000);
      authed=false;return;
    }
    authed=true;
    const a=d.authorize;
    localStorage.setItem('deriv_tk',token);
    userCurrency=a.currency||'USD';
    activeLoginid=a.loginid||'';
    userInfo={
      name:a.fullname||a.loginid||'Trader',
      loginid:a.loginid||'',
      currency:userCurrency,
    };
    realBalance=a.balance!==undefined?parseFloat(a.balance):null;

    // ‚òÖ Build account list from account_list in authorize response
    if(a.account_list&&a.account_list.length){
      // Merge Deriv's account_list with our stored tokens
      accountList=a.account_list.map(ac=>{
        const stored=allTokens[ac.loginid];
        return{
          loginid:ac.loginid,
          currency:ac.currency||'USD',
          account_type:ac.account_type||'real',
          is_disabled:ac.is_disabled||false,
          is_virtual:ac.is_virtual||false,
          token:stored?stored.token:(ac.loginid===activeLoginid?token:''),
          balance:ac.loginid===activeLoginid?realBalance:null,
        };
      });
      // Save all tokens we know about
      accountList.forEach(ac=>{
        if(ac.token)allTokens[ac.loginid]={token:ac.token,currency:ac.currency};
      });
      try{localStorage.setItem('deriv_accounts',JSON.stringify(allTokens));}catch(e){}
    } else if(accountList.length===0){
      // Fallback: just show the current account
      accountList=[{loginid:activeLoginid,currency:userCurrency,account_type:a.is_virtual?'virtual':'real',is_virtual:a.is_virtual||false,token,balance:realBalance}];
    }

    updateBalanceUI();
    updateUserCard();
    renderAccountMenu();
    $('sbAuth').textContent=(a.is_virtual?'Demo':'Live')+':'+a.loginid;
    $('sbAuth').style.color=a.is_virtual?'var(--gold)':'var(--green)';
    $('hPnlBadge').style.display='flex';
    // Subscribe to balance updates
    send({balance:1,subscribe:1});
    // Fetch balances for all accounts
    send({get_account_status:1});
    // Check open positions
    send({portfolio:1,contract_type:['ACCU']});
    const balStr=realBalance!==null?userCurrency+' '+realBalance.toFixed(2):'unknown';
    toast('‚úÖ '+(a.is_virtual?'Demo':'Live')+' ‚Äî '+userInfo.name+' | '+balStr,'g');
    ariaSpeak('Welcome '+userInfo.name.split(' ')[0]+'! Balance is '+balStr+'. AI Sniper ready.');
    return;
  }

  // ‚òÖ BALANCE ‚Äî live update from Deriv on every trade settlement
  if(t==='balance'){
    if(d.balance&&d.balance.balance!==undefined){
      const nb=parseFloat(d.balance.balance);
      const ob=realBalance;
      realBalance=nb;
      // Update balance in account list too
      const acct=accountList.find(a=>a.loginid===activeLoginid);
      if(acct)acct.balance=nb;
      updateBalanceUI();
      flashBalance();
      // Update dropdown display
      if(accountList.length>1)renderAccountMenu();
      if(ob!==null&&ob!==undefined&&Math.abs(nb-ob)>0.001){
        const diff=+(nb-ob).toFixed(2);
        toast((diff>0?'üí∞ +':'üí∏ ')+diff+' | Balance: '+userCurrency+' '+nb.toFixed(2),diff>0?'g':'y',5000);
      }
    }
    return;
  }

  if(t==='tick'){
    const tick=d.tick;
    if(!tick)return;
    const tsym=tick.symbol;
    if(!symBufs[tsym])symBufs[tsym]=[];
    symBufs[tsym].push(parseFloat(tick.quote));
    if(symBufs[tsym].length>TICK_BUF)symBufs[tsym].shift();
    if(tsym===sym)processTick(tick);
    return;
  }

  if(t==='portfolio'){
    if(d.error)return;
    const contracts=(d.portfolio&&d.portfolio.contracts)||[];
    const open=contracts.filter(c=>c.contract_type==='ACCU');
    if(open.length>0){
      toast('‚ö† Found '+open.length+' open Accumulator ‚Äî clearing for AI‚Ä¶','y',5000);
      open.forEach(c=>send({sell:c.contract_id,price:0}));
      con=null;clearBarriers();renderNoContract();isBuying=false;aiCool=false;
    }
    return;
  }

  if(t==='buy'){
    isBuying=false;
    if(d.error){
      const ec=d.error.code||'',em=d.error.message||'Unknown error';
      if(ec==='TooManyOpenPositions'||em.toLowerCase().includes('too many')){
        toast('‚ö† Existing position ‚Äî clearing‚Ä¶','y',4000);
        if(con){con=null;clearBarriers();renderNoContract();exitProbability=0;updateExitMeter(0);}
        aiCool=true;
        send({portfolio:1,contract_type:['ACCU']});
        setTimeout(()=>{aiCool=false;isBuying=false;},7000);
      } else {
        toast('‚ùå Buy error: '+em,'r',5000);
        con=null;clearBarriers();renderNoContract();
      }
      return;
    }
    const bd=d.buy;
    if(bd&&con){
      con.realId=bd.contract_id;
      // ‚òÖ Use REAL barriers from Deriv API response
      if(bd.barrier)con.upper=parseFloat(bd.barrier);
      if(bd.low_barrier)con.lower=parseFloat(bd.low_barrier);
      // Subscribe to live contract updates
      send({proposal_open_contract:1,contract_id:con.realId,subscribe:1});
      drawBarriers();
      toast('‚úÖ Trade open! ID:'+bd.contract_id,'g',3000);
    }
    return;
  }

  if(t==='sell'){
    isBuying=false;
    if(d.error){
      const ec=d.error.code||'';
      if(ec==='InvalidSellContractProposal'||ec==='AlreadySold'||ec==='ContractAlreadySold'){
        // Contract was already closed by Deriv (barrier hit)
        if(con){
          const lost=con.stake;
          if(con.byAI){aiLoss++;aiTrades++;aiPnl-=lost;addHistItem({won:false,pnl:-lost,reason:'KO by barrier',ticks:con.ticks});}
          con=null;clearBarriers();renderNoContract();exitProbability=0;updateExitMeter(0);
          $('exitMeter').classList.remove('on');
        }
      } else {
        toast('‚ö† Sell error: '+d.error.message,'y',4000);
      }
    } else {
      // ‚òÖ Sell success ‚Äî sold_for is the payout received
      const sf=d.sell&&d.sell.sold_for!==undefined?parseFloat(d.sell.sold_for):null;
      if(sf!==null){
        const profit=+(sf-stake).toFixed(2);
        toast('‚úÖ Sold for '+userCurrency+' '+sf.toFixed(2)+' | P&L: '+(profit>=0?'+':'')+profit,'g',5000);
        // Balance will auto-update via balance subscription
      }
    }
    return;
  }

  if(t==='proposal_open_contract'){
    const poc=d.proposal_open_contract;
    if(!poc||!con)return;
    // Update P&L from Deriv's own calculation
    if(poc.profit!==undefined)con.pnl=parseFloat(poc.profit);
    if(poc.bid_price!==undefined)con.payout=parseFloat(poc.bid_price);
    // ‚òÖ Update REAL barriers from live contract
    if(poc.barrier)con.upper=parseFloat(poc.barrier);
    if(poc.low_barrier)con.lower=parseFloat(poc.low_barrier);
    // Contract ended on Deriv's side
    if(poc.status==='lost'||poc.status==='sold'||poc.exit_tick){
      const fp=poc.profit?parseFloat(poc.profit):0;
      if(con){con.pnl=fp;closeContract('Deriv settled: '+poc.status,con.byAI);}
    }
    return;
  }

  if(t==='forget_all'||t==='forget')return;
}

function updateBalanceUI(){
  const v=realBalance!==null?userCurrency+' '+realBalance.toFixed(2):'‚Äî';
  $('hBalance').textContent=v;
  $('userBal').textContent=v;
}
function updateUserCard(){
  $('userSection').style.display='block';
  $('userName').textContent=userInfo.name||'Trader';
  $('userUid').textContent=userInfo.loginid||'Demo';
}

function renderAccountMenu(){
  if(!accountList||accountList.length<=1){$('acctSwitcher').style.display='none';return;}
  $('acctSwitcher').style.display='block';
  const cur=accountList.find(a=>a.loginid===activeLoginid)||accountList[0];
  // Update button display
  const isVirt=cur.is_virtual||cur.account_type==='virtual';
  const isCrypto=cur.currency&&['BTC','ETH','USDT','tUSDT','eUSDT','LTC'].includes(cur.currency);
  const tagBg=isVirt?'#1e2736':isCrypto?'#1a0d2e':'#003d1a';
  const tagCl=isVirt?'#7d8fa3':isCrypto?'#c084fc':'#00e676';
  const tagLbl=isVirt?'DEMO':isCrypto?'CRYPTO':'REAL';
  $('acctCurTag').textContent=tagLbl;
  $('acctCurTag').style.background=tagBg;
  $('acctCurTag').style.color=tagCl;
  $('acctCurName').textContent=cur.loginid;
  $('acctCurBal').textContent=cur.balance!==null&&cur.balance!==undefined?cur.currency+' '+parseFloat(cur.balance).toFixed(2):'‚Äî';
  // Build dropdown items
  $('acctMenu').innerHTML=accountList.map(a=>{
    const virt=a.is_virtual||a.account_type==='virtual';
    const crypto=['BTC','ETH','USDT','tUSDT','eUSDT','LTC'].includes(a.currency);
    const tagC=virt?'demo':crypto?'crypto':'real';
    const tagN=virt?'DEMO':crypto?'CRYPTO':'REAL';
    const isActive=a.loginid===activeLoginid;
    const bal=a.balance!==null&&a.balance!==undefined?a.currency+' '+parseFloat(a.balance).toFixed(2):'‚Äî';
    const hasToken=!!a.token;
    return`<div class="acct-menu-item${isActive?' active-acct':''}" onclick="switchAccount('${a.loginid}')" style="${!hasToken?'opacity:.5;':''}">
      <span class="acct-menu-tag ${tagC}">${tagN}</span>
      <div class="acct-menu-info">
        <div class="acct-menu-id">${a.loginid}</div>
        <div class="acct-menu-cur">${a.currency||'‚Äî'}${!hasToken?' ¬∑ Login again to use':''}</div>
      </div>
      <span class="acct-menu-bal">${bal}</span>
      <span class="acct-menu-check">‚úì</span>
    </div>`;
  }).join('');
}

function toggleAcctMenu(){
  const m=$('acctMenu'),a=$('acctArrow');
  m.classList.toggle('open');
  a.textContent=m.classList.contains('open')?'‚ñ≤':'‚ñº';
  if(m.classList.contains('open')){
    setTimeout(()=>document.addEventListener('click',closeAcctMenu,{once:true}),10);
  }
}
function closeAcctMenu(){
  $('acctMenu').classList.remove('open');
  $('acctArrow').textContent='‚ñº';
}

function switchAccount(loginid){
  closeAcctMenu();
  if(loginid===activeLoginid){toast('Already on this account','');return;}
  const acct=accountList.find(a=>a.loginid===loginid);
  if(!acct){toast('‚ö† Account not found','r');return;}
  if(!acct.token){
    toast('‚ö† Please log in again to access this account ‚Äî tokens expired','r',6000);
    ariaSpeak('Please log in again to switch accounts. Your session tokens have expired.');
    return;
  }
  // Close any open trade
  if(con)closeContract('Account switch',false);
  // Switch token and re-authorize
  token=acct.token;
  activeLoginid=loginid;
  authed=false;realBalance=null;
  $('hBalance').textContent='Switching‚Ä¶';
  toast('üîÑ Switching to '+loginid+'‚Ä¶','p',3000);
  ariaSpeak('Switching to account '+loginid+'. Please wait.');
  // Re-authorize with new token on existing WS connection
  if(ws&&ws.readyState===1){
    ws.send(JSON.stringify({authorize:token}));
  } else {
    connect();
  }
}

function fetchOpenPositions(){send({portfolio:1,contract_type:['ACCU']});}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BARRIER DISTANCE (Deriv formula approximation)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function barrierDist(p){
  const m={1:0.01516,2:0.02326,3:0.03121,4:0.03900,5:0.04663};
  return p*(m[gr]||0.02326);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TICK PROCESSING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function processTick(tick){
  const p=parseFloat(tick.quote),t=tick.epoch;
  if(p>hi)hi=p;if(p<lo)lo=p;
  const chg=prevP!==null?p-prevP:0;
  const pct=prevP!==null?(chg/prevP)*100:0;
  const up=chg>=0;

  $('priceEl').textContent=p.toFixed(dp);
  $('priceEl').className='price-main '+(up?'up':'dn');
  $('priceChg').textContent=(up?'+':'')+pct.toFixed(4)+'%';
  $('priceChg').className='price-chg '+(up?'ub':'db');
  $('metaH').textContent='H:'+hi.toFixed(dp);
  $('metaL').textContent='L:'+lo.toFixed(dp);
  $('mobPrice').textContent=sym+' '+p.toFixed(dp);

  const pt={time:t,value:p};
  priceHist.push(pt);if(priceHist.length>TICK_BUF*5)priceHist.shift();
  try{area.update(pt);}catch(e){}
  appendBarrierPts(t);

  tickBuf.push({p,t,chg,up});
  if(tickBuf.length>TICK_BUF)tickBuf.shift();
  $('infoBuf').textContent=tickBuf.length+'/100';
  $('feedPulse').style.opacity='1';
  setTimeout(()=>$('feedPulse').style.opacity='0.3',150);

  if(!con&&prevP!==null){
    const bd=barrierDist(p);
    $('bUpper').textContent=(p+bd).toFixed(dp);
    $('bLower').textContent=(p-bd).toFixed(dp);
    $('bEntry').textContent='‚Äî';
    $('infoBarrier').textContent='¬±'+bd.toFixed(dp);
  }

  if(con&&!exitingNow){
    con.ticks++;ticksHeldAfterEntry++;
    // Local P&L estimate (overridden by proposal_open_contract)
    if(con.pnl===0||!con.realId){
      const mult=Math.pow(1+gr/100,con.ticks)-1;
      con.pnl=+(con.stake*mult).toFixed(2);
      con.payout=+(con.stake+con.pnl).toFixed(2);
    }

    const dU=con.upper-p,dL=p-con.lower;
    const half=(con.upper-con.lower)/2;
    const nearDist=Math.min(dU,dL);
    const nearBar=dU<dL?con.upper:con.lower;
    const safetyPct=(nearDist/half*100);

    $('bUpper').textContent=con.upper.toFixed(dp);
    $('bLower').textContent=con.lower.toFixed(dp);
    $('bEntry').textContent=con.entry.toFixed(dp);
    $('bSafety').textContent=safetyPct.toFixed(1)+'%';
    $('bSafety').style.color=safetyPct>55?'var(--green)':safetyPct>25?'var(--gold)':'var(--red)';

    const ep=computeExitProb(p,con,tickBuf);
    exitProbability=ep;updateExitMeter(ep);

    const holdScore=computeHoldScore(p,con,tickBuf);
    $('iHold').textContent=holdScore+'%';$('iHold').style.color=holdScore>60?'var(--green)':holdScore>30?'var(--gold)':'var(--red)';
    $('ovHold').textContent=holdScore+'%';$('ovHold').style.color=holdScore>60?'var(--green)':holdScore>30?'var(--gold)':'var(--red)';
    $('infoHold').textContent=holdScore+'% safe';

    const proxPct=(nearDist/half)*100;
    const pastMin=ticksHeldAfterEntry>=MIN_HOLD_TICKS;

    // ‚òÖ 7-LAYER SNIPER EXIT SYSTEM
    // L1: EMERGENCY ‚Äî imminent barrier touch (any time)
    const emergency=p>=con.upper*0.9990||p<=con.lower*1.0010;

    // L2: EMERGENCY VELOCITY ‚Äî fast single tick toward very near barrier
    let emergVel=false;
    if(tickBuf.length>=2&&proxPct<12){
      const fv=tickBuf[tickBuf.length-1].p-tickBuf[tickBuf.length-2].p;
      emergVel=(nearBar===con.upper&&fv>0)||(nearBar===con.lower&&fv<0);
    }

    // L3: PROXIMITY ‚Äî dangerously close after min hold
    const proximity=pastMin&&proxPct<15;

    // L4: AI PROBABILITY THRESHOLD
    const aiProb=pastMin&&ep>=EXIT_THRESHOLD;

    // L5: VELOCITY + ACCELERATION toward barrier
    let velDanger=false;
    if(pastMin&&tickBuf.length>=4){
      const v1=tickBuf[tickBuf.length-1].p-tickBuf[tickBuf.length-2].p;
      const v2=tickBuf[tickBuf.length-2].p-tickBuf[tickBuf.length-3].p;
      const v3=tickBuf[tickBuf.length-3].p-tickBuf[tickBuf.length-4].p;
      const towardU=nearBar===con.upper;
      const t1=towardU?v1>0:v1<0;
      const t2=towardU?v2>0:v2<0;
      const accel=towardU?(v1>v2&&v2>v3):(v1<v2&&v2<v3);
      const magUp=Math.abs(v1)>=Math.abs(v2)*0.85;
      velDanger=t1&&t2&&(accel||magUp)&&proxPct<50;
    }

    // L6: TICK STREAK ‚Äî 3+ consecutive ticks toward barrier in danger zone
    let streak=false;
    if(pastMin&&tickBuf.length>=4&&proxPct<55){
      let sc=0;
      for(let i=tickBuf.length-1;i>=Math.max(0,tickBuf.length-4);i--){
        const tw=(nearBar===con.upper&&tickBuf[i].up)||(nearBar===con.lower&&!tickBuf[i].up);
        if(tw)sc++;else break;
      }
      streak=sc>=3;
    }

    // L7: HOLD SCORE CRITICAL
    const holdDanger=pastMin&&holdScore<20&&proxPct<40;

    const shouldExit=aiOn&&con.byAI&&(emergency||emergVel||proximity||aiProb||velDanger||streak||holdDanger);

    if(shouldExit){
      const reason=emergency||emergVel?'‚ö° Barrier edge!':
                   proximity?'Proximity '+proxPct.toFixed(0)+'%':
                   streak?'3-tick streak toward barrier':
                   velDanger?'Velocity+accel toward barrier':
                   holdDanger?'Hold critical '+holdScore+'%':
                   'Exit prob '+ep+'%';
      sniperExit(p,ep,reason);
      prevP=p;addTickRow(p,chg,t);
      $('sbTime').textContent=new Date(t*1000).toLocaleTimeString();
      return;
    }

    updateConUI();
    // KO check ‚Äî barrier breach
    if(p>=con.upper||p<=con.lower){onKO(p);prevP=p;addTickRow(p,chg,t);return;}
    if(tp&&con.pnl>=tp)sniperExit(p,0,'Take Profit ‚úÖ');
  }

  addTickRow(p,chg,t);prevP=p;
  $('sbTime').textContent=new Date(t*1000).toLocaleTimeString();
  if(aiOn&&tickBuf.length>=15)runAI(p);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXIT PROBABILITY ENGINE v6
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function computeExitProb(price,contract,buf){
  if(!contract||buf.length<3)return 0;
  let score=0;const n=buf.length;
  const upper=contract.upper,lower=contract.lower;
  const half=(upper-lower)/2;
  const dU=upper-price,dL=price-lower;
  const nearDist=Math.min(dU,dL);
  const nearBar=dU<dL?upper:lower;

  // F1: PROXIMITY (0-45pts) ‚Äî exponential
  const proxRatio=1-(nearDist/half);
  score+=Math.max(0,Math.pow(proxRatio,1.5)*45);

  // F2: VELOCITY over 5 ticks toward barrier (0-18pts)
  const vp=Math.min(5,n-1);
  const vel=buf[n-1].p-buf[n-1-vp].p;
  const movToward=(nearBar===upper&&vel>0)||(nearBar===lower&&vel<0);
  if(movToward)score+=Math.min(18,Math.abs(vel)/half*800);

  // F3: ACCELERATION (0-15pts)
  if(n>=4){
    const v1=buf[n-1].p-buf[n-2].p;
    const v2=buf[n-2].p-buf[n-3].p;
    const v3=buf[n-3].p-buf[n-4].p;
    const acc=v1-v2;
    const accToward=(nearBar===upper&&acc>0)||(nearBar===lower&&acc<0);
    if(accToward)score+=Math.min(10,Math.abs(acc)/half*450);
    const accGrowing=(nearBar===upper&&acc>v2-v3)||(nearBar===lower&&acc<v2-v3);
    if(accGrowing)score+=5;
  }

  // F4: TICK STREAK (0-12pts)
  let streak=0;
  for(let i=n-1;i>=Math.max(0,n-8);i--){
    const toward=(nearBar===upper&&buf[i].up)||(nearBar===lower&&!buf[i].up);
    if(toward)streak++;else break;
  }
  score+=streak*(12/8);

  // F5: RECENT BARRIER TEST (0-8pts)
  if(n>=5){
    const r5=buf.slice(n-5).map(b=>b.p);
    const rMax=Math.max(...r5),rMin=Math.min(...r5);
    if(nearBar===upper&&(rMax/upper)>0.9988)score+=8;
    if(nearBar===lower&&(lower/rMin)>0.9988)score+=8;
  }

  // F6: MOMENTUM CONVERGENCE (0-6pts)
  if(n>=12){
    const m1=buf.slice(n-6).reduce((a,b)=>a+b.p,0)/6;
    const m2=buf.slice(n-12,n-6).reduce((a,b)=>a+b.p,0)/6;
    if((nearBar===upper&&m1>m2)||(nearBar===lower&&m1<m2))score+=6;
  }

  // DAMPEN if far from barrier
  if(nearDist>half*0.78)score=Math.min(score,16);
  if(nearDist>half*0.90)score=Math.min(score,4);

  return Math.min(100,Math.max(0,Math.round(score)));
}

function computeHoldScore(price,contract,buf){
  if(!contract||buf.length<3)return 50;
  const n=buf.length;
  const upper=contract.upper,lower=contract.lower;
  const half=(upper-lower)/2;
  const dU=upper-price,dL=price-lower;
  const nearDist=Math.min(dU,dL);
  const nearBar=dU<dL?upper:lower;
  let score=100;
  score-=(1-(nearDist/half))*60;
  if(n>=3){
    const v1=buf[n-1].p-buf[n-2].p;
    const toward=(nearBar===upper&&v1>0)||(nearBar===lower&&v1<0);
    if(toward)score-=Math.min(22,Math.abs(v1)/half*800);
  }
  if(n>=10){
    const recent=buf.slice(n-10).map(b=>b.p);
    const mean=recent.reduce((a,b)=>a+b,0)/10;
    const std=Math.sqrt(recent.reduce((a,b)=>a+Math.pow(b-mean,2),0)/10);
    const rv=(std/price)*100;
    if(rv<0.06)score+=10;else if(rv>0.22)score-=12;
  }
  return Math.min(100,Math.max(0,Math.round(score)));
}

function updateExitMeter(ep){
  const fill=$('emFill'),pct=$('emPct'),sc=$('emScore'),cw=$('chartWrap');
  fill.style.width=ep+'%';
  fill.style.background=ep<30?'var(--green)':ep<50?'var(--gold)':ep<70?'var(--orange)':'var(--red)';
  pct.textContent=ep+'%';
  if(ep<30){sc.textContent='HOLD SAFE';sc.style.color='var(--green)';}
  else if(ep<50){sc.textContent='CAUTION';sc.style.color='var(--gold)';}
  else if(ep<70){sc.textContent='‚ö† DANGER';sc.style.color='var(--orange)';}
  else{sc.textContent='üö® EXIT!';sc.style.color='var(--red)';}
  $('exitMeter').classList.toggle('on',!!con);
  cw.classList.toggle('danger-high',ep>=70);
  cw.classList.toggle('show-danger',ep>=75);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VOLATILITY SCANNER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function scoreVol(symKey,buf){
  if(!buf||buf.length<12)return{score:0,stability:0,momentum:0,trend:0};
  const m=Math.min(70,buf.length);
  const prices=buf.slice(-m);
  const mean=prices.reduce((a,b)=>a+b,0)/m;
  const std=Math.sqrt(prices.reduce((a,b)=>a+Math.pow(b-mean,2),0)/m);
  const relStd=(std/mean)*100;
  const stability=Math.max(0,Math.min(100,100-relStd*480));
  let sameDir=0;
  for(let i=1;i<m;i++){
    if((prices[i]>prices[i-1])===(i>=2?(prices[i-1]>prices[i-2]):true))sameDir++;
  }
  const trend=Math.round((sameDir/(m-1))*100);
  const recent=prices.slice(-10).reduce((a,b)=>a+b,0)/10;
  const older=prices.slice(0,10).reduce((a,b)=>a+b,0)/10;
  const momentum=Math.max(0,Math.min(100,100-Math.abs(((recent-older)/older)*100)*22));
  const score=Math.round(stability*0.50+trend*0.30+momentum*0.20);
  return{score:Math.min(100,score),stability:Math.round(stability),momentum:Math.round(momentum),trend};
}

function runVolScan(silent){
  if(!silent){$('scanOverlay').classList.add('open');}
  $('scanResults').innerHTML='';$('scanProgressFill').style.width='0%';
  let prog=0;
  const pi=setInterval(()=>{prog=Math.min(95,prog+5);$('scanProgressFill').style.width=prog+'%';},160);
  setTimeout(()=>{
    clearInterval(pi);$('scanProgressFill').style.width='100%';
    const results=ALL_SYMS.map(s=>{
      const buf=symBufs[s.sym]||[];
      const sc=scoreVol(s.sym,buf);
      volScores[s.sym]=sc;
      return{...s,...sc};
    }).sort((a,b)=>b.score-a.score);

    if(!silent){
      $('scanResults').innerHTML='';
      results.forEach((r,i)=>{
        const isW=i===0;
        const el=document.createElement('div');
        el.className='scan-result-item'+(isW?' winner':'');
        el.innerHTML=`
          <div style="min-width:48px;">
            <div style="font-size:12px;font-weight:800;color:${isW?'var(--green)':'var(--text)'};">${isW?'üèÜ ':''}${r.name}</div>
            <div style="font-size:9px;color:var(--sub);">${r.sym}</div>
          </div>
          <div style="flex:1;padding:0 7px;">
            <div class="sri-bar-row"><span class="sri-bar-lbl">Stability</span><div class="sri-bar-bg"><div class="sri-bar-fill" style="width:${r.stability}%;background:var(--green);"></div></div><span style="font-size:9px;margin-left:3px;">${r.stability}%</span></div>
            <div class="sri-bar-row"><span class="sri-bar-lbl">Trend</span><div class="sri-bar-bg"><div class="sri-bar-fill" style="width:${r.trend}%;background:var(--blue);"></div></div><span style="font-size:9px;margin-left:3px;">${r.trend}%</span></div>
            <div class="sri-bar-row"><span class="sri-bar-lbl">Momentum</span><div class="sri-bar-bg"><div class="sri-bar-fill" style="width:${r.momentum}%;background:var(--purple);"></div></div><span style="font-size:9px;margin-left:3px;">${r.momentum}%</span></div>
          </div>
          <div style="text-align:right;">
            <div class="sri-score" style="color:${isW?'var(--green)':r.score>60?'var(--gold)':'var(--red)'};">${r.score}</div>
            <div class="vol-badge ${isW?'best':r.score>60?'good':'bad'}">${isW?'BEST':r.score>60?'GOOD':'WEAK'}</div>
          </div>`;
        el.addEventListener('click',()=>{
          switchSym(r.sym,r.dp);
          $('scanOverlay').classList.remove('open');
          toast('Switched to '+r.name+' (score:'+r.score+')','g');
          ariaSpeak('Switched to '+r.name+'. Score '+r.score+'.');
        });
        $('scanResults').appendChild(el);
      });
    }

    renderVolSide(results);

    // Auto-switch if AI on and no active trade
    if(aiOn&&!con){
      const best=results[0];
      const now2=Date.now();
      if(best&&best.sym!==sym&&best.score>55&&now2-lastVolAutoSwitch>90000){
        lastVolAutoSwitch=now2;
        switchSym(best.sym,best.dp);
        toast('ü§ñ AI switched ‚Üí '+best.name+' (score:'+best.score+')','p');
        if(!silent)ariaSpeak('Auto-switching to '+best.name+'. Stability '+best.stability+'%.');
      }
    }
  },3200);
}

function renderVolSide(results){
  const el=$('volScanList');
  if(!results||!results.length){el.innerHTML='<div style="text-align:center;color:var(--sub);font-size:10px;padding:6px;">Click SCAN to analyze‚Ä¶</div>';return;}
  el.innerHTML=results.map((r,i)=>`
    <div class="vol-item${i===0?' best':''}${r.sym===sym?' active-sym':''}" onclick="switchSym('${r.sym}',${r.dp});closeAllPanels();">
      <span class="vol-name">${i===0?'üèÜ ':''}<span style="color:${i===0?'var(--green)':r.sym===sym?'var(--blue)':'var(--text)'};">${r.name}</span></span>
      <div class="vol-score-bar"><div class="vol-score-fill" style="width:${r.score}%;"></div></div>
      <span class="vol-score-num" style="color:${i===0?'var(--green)':r.score>60?'var(--gold)':'var(--red)'};">${r.score}</span>
      <span class="vol-badge ${i===0?'best':r.score>60?'good':'bad'}">${i===0?'BEST':r.score>60?'OK':'WEAK'}</span>
    </div>`).join('');
}

function switchSym(newSym,newDp){
  sym=newSym;dp=newDp||3;
  document.querySelectorAll('.sym-btn').forEach(b=>b.classList.toggle('active',b.dataset.sym===sym));
  if(area)area.applyOptions({priceFormat:{type:'price',precision:dp,minMove:Math.pow(10,-dp)}});
  if(con)closeContract('Symbol switch',false);
  tickBuf=[];priceHist=[];prevP=null;hi=-Infinity;lo=Infinity;
  $('tickFeed').innerHTML='';$('sbSym').textContent=sym;
  // Re-subscribe
  if(ws&&ws.readyState===1){
    ws.send(JSON.stringify({forget_all:'ticks'}));
    setTimeout(()=>{
      if(ws&&ws.readyState===1){
        ws.send(JSON.stringify({ticks:sym,subscribe:1}));
        ALL_SYMS.forEach(s=>{if(s.sym!==sym)ws.send(JSON.stringify({ticks:s.sym,subscribe:1}));});
      }
    },400);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function runAI(price){
  const buf=tickBuf,n=buf.length;
  const sh=Math.min(8,n),lg=Math.min(50,n);
  const shAvg=buf.slice(n-sh).reduce((a,b)=>a+b.p,0)/sh;
  const lgAvg=buf.slice(n-lg).reduce((a,b)=>a+b.p,0)/lg;
  const trendUp=shAvg>lgAvg;
  const trendStr=Math.abs((shAvg-lgAvg)/lgAvg)*100;
  const rocP=Math.min(5,n-1);
  const roc=((buf[n-1].p-buf[n-1-rocP].p)/buf[n-1-rocP].p)*100;
  const momUp=roc>0;
  const rsiP=Math.min(14,n-1);let g=0,l=0;
  for(let i=n-rsiP;i<n;i++){const c=buf[i].p-buf[i-1].p;if(c>0)g+=c;else l+=Math.abs(c);}
  const rs=(g/rsiP)/((l/rsiP)||0.0001);
  const rsi=100-100/(1+rs);
  const rsiOS=rsi<35,rsiOB=rsi>65;
  const vp=Math.min(20,n);
  const vPrices=buf.slice(n-vp).map(b=>b.p);
  const mean=vPrices.reduce((a,b)=>a+b,0)/vp;
  const stdDev=Math.sqrt(vPrices.reduce((a,b)=>a+Math.pow(b-mean,2),0)/vp);
  const relVol=(stdDev/price)*100;
  const lowVol=relVol<0.14;
  const holdScore=con?computeHoldScore(price,con,buf):0;
  const exitRisk=con?exitProbability:0;

  let entryScore=0;
  if(trendUp)entryScore+=25;if(momUp)entryScore+=20;
  if(!rsiOB)entryScore+=20;if(lowVol)entryScore+=20;if(rsiOS)entryScore+=15;

  let sig='WAIT',reason='Analyzing‚Ä¶';
  if(con&&con.byAI){sig='IN TRADE';reason='Hold:'+holdScore+'% Exit:'+exitRisk+'%';}
  else if(!con&&!aiCool&&entryScore>=50&&n>=15&&!rsiOB){sig='BUY';reason='Score:'+entryScore+'/100';}
  else{sig='WAIT';reason='Score:'+entryScore+'/100';}

  const tl=trendUp?'‚ñ≤ BULL':'‚ñº BEAR';
  $('iTrend').textContent=tl;$('iTrend').style.color=trendUp?'var(--green)':'var(--red)';
  $('iMom').textContent=(roc>=0?'+':'')+roc.toFixed(3)+'%';$('iMom').style.color=momUp?'var(--green)':'var(--red)';
  const rl=rsi.toFixed(1)+(rsiOS?' OS':rsiOB?' OB':'');
  $('iRsi').textContent=rl;$('iRsi').style.color=rsiOS?'var(--green)':rsiOB?'var(--red)':'var(--gold)';
  $('iVol').textContent=lowVol?'LOW ‚úì':relVol>0.20?'HIGH ‚ö†':'MED';$('iVol').style.color=lowVol?'var(--green)':'var(--red)';
  $('iExit').textContent=exitRisk+'%';$('iExit').style.color=exitRisk<30?'var(--green)':exitRisk<65?'var(--gold)':'var(--red)';

  const boxCls=sig==='BUY'||sig==='IN TRADE'?'BUY':'WAIT';
  $('sigBox').className='sig-box '+boxCls;$('sigTxt').className='sig-txt '+boxCls;
  $('sigTxt').textContent=sig;$('sigSub').textContent=reason;

  scanAnim=(scanAnim+10)%105;$('scanFill').style.width=Math.min(100,scanAnim)+'%';

  const wr=aiTrades>0?((aiWins/aiTrades)*100).toFixed(0)+'%':'‚Äî';
  $('stWins').textContent=aiWins;$('stLoss').textContent=aiLoss;
  $('stWR').textContent=wr;
  $('stPnl').textContent=(aiPnl>=0?'+':'')+aiPnl.toFixed(2);
  $('stPnl').style.color=aiPnl>=0?'var(--green)':'var(--red)';
  $('hWins').textContent=aiWins+'W';
  $('hPnl').textContent=(aiPnl>=0?'+$':'-$')+Math.abs(aiPnl).toFixed(2);
  $('hPnl').style.color=aiPnl>=0?'var(--green)':'var(--red)';

  $('ovTrend').textContent=tl;$('ovTrend').style.color=trendUp?'var(--green)':'var(--red)';
  $('ovRsi').textContent=rl;$('ovRsi').style.color=rsiOS?'var(--green)':rsiOB?'var(--red)':'var(--gold)';
  $('ovExitRisk').textContent=exitRisk+'%';$('ovExitRisk').style.color=exitRisk<30?'var(--green)':exitRisk<65?'var(--gold)':'var(--red)';
  $('ovSig').textContent=sig;$('ovSig').style.color=sig==='BUY'||sig==='IN TRADE'?'var(--green)':'var(--gold)';
  $('sbAI').textContent='AI:'+aiTrades+'t';$('sbAI').style.color=aiOn?'var(--green)':'var(--sub)';

  if(sig==='BUY'&&!con&&!aiCool&&!isBuying)doEntry(price,entryScore);

  // Auto vol scan every 4 min
  if(Date.now()-lastVolAutoSwitch>4*60*1000)runVolScan(true);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENTRY & SNIPER EXIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doEntry(price,score){
  if(con||aiCool||exitingNow||isBuying)return;
  aiCool=true;ticksHeldAfterEntry=0;phase='FIRE';updatePhaseUI();
  showFlash('flashBuy','üéØ AI ENTRY @ '+price.toFixed(dp)+' Score:'+score,2000);
  toast('ü§ñ AI entering @ '+price.toFixed(dp),'p');
  ariaSpeak('Entering trade. I will exit before the barrier breaks.');
  buyContract(true);phase='IN_TRADE';updatePhaseUI();
  setTimeout(()=>{aiCool=false;},5000);
}

function sniperExit(price,ep,reason){
  if(!con||exitingNow)return;
  exitingNow=true;phase='EXITING';updatePhaseUI();
  showFlash('flashExit','üö® EXIT @ '+price.toFixed(dp)+' | '+reason,2500);
  $('chartWrap').classList.add('show-danger');
  ariaSpeak('Exiting now. '+reason.replace(/[^\w\s%]/g,''));
  closeContract(reason,true);
  phase='HUNTING';exitingNow=false;
  setTimeout(()=>$('chartWrap').classList.remove('show-danger'),700);
  updatePhaseUI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUY CONTRACT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buyContract(fromAI){
  if(!wsAlive){toast('‚ö† Not connected to Deriv','r');return;}
  if(con){toast('‚ö† Already in a trade','r');return;}
  if(!prevP){toast('‚ö† Waiting for price data‚Ä¶','y');return;}
  if(isBuying){toast('‚è≥ Buy pending‚Ä¶','y');return;}
  const p=prevP,d=barrierDist(p);
  con={
    entry:p,
    upper:parseFloat((p+d).toFixed(dp+2)),
    lower:parseFloat((p-d).toFixed(dp+2)),
    ticks:0,stake,pnl:0,payout:stake,
    start:now(),byAI:!!fromAI,realId:null,
    isReal:authed&&!!token,
  };
  ticksHeldAfterEntry=0;
  drawBarriers();updateConUI();
  $('exitMeter').classList.add('on');
  if(!fromAI)toast('‚úÖ Contract opened @ '+p.toFixed(dp)+(con.isReal?' [REAL]':' [SIM]'),'g');
  if(con.isReal){
    isBuying=true;
    setTimeout(()=>{isBuying=false;},10000);
    send({
      buy:'1',
      price:stake,
      parameters:{
        contract_type:'ACCU',
        symbol:sym,
        amount:stake,
        basis:'stake',
        growth_rate:gr/100,
        currency:userCurrency,
      }
    });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOSE CONTRACT ‚Äî ‚òÖ Balance correctly updated here
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function closeContract(reason,fromAI){
  if(!con)return;
  const pnl=con.pnl,tks=con.ticks,won=pnl>0,byAI=con.byAI;
  const realId=con.realId,isReal=con.isReal,stk=con.stake,payout=con.payout;

  if(byAI||fromAI){
    if(won)aiWins++;else aiLoss++;
    aiTrades++;aiPnl=+(aiPnl+pnl).toFixed(2);
    addHistItem({won,pnl,reason,ticks:tks});
    if(won)showFlash('flashWin','‚úÖ WIN +$'+pnl.toFixed(2)+' ('+tks+'t)',2500);
  }

  // ‚òÖ For real accounts: send sell ‚Üí Deriv balance subscription updates balance automatically
  if(isReal&&realId){
    send({sell:realId,price:0});
    // Balance will update via 'balance' message from subscription ‚Äî no manual update needed
  } else if(isReal&&!realId){
    // Buy was placed but we don't have realId yet ‚Äî still send sell if possible
    // Balance subscription will handle it
  } else {
    // SIMULATION ‚Äî update balance locally
    if(realBalance!==null){
      realBalance=+(realBalance-stk+payout).toFixed(2);
      updateBalanceUI();flashBalance();
    }
  }

  isBuying=false;con=null;clearBarriers();exitProbability=0;updateExitMeter(0);
  $('exitMeter').classList.remove('on');renderNoContract();resetBarrierUI();
  $('sTicks').textContent='0';$('sPnl').textContent='$0.00';$('sPnl').style.color='var(--text)';$('sPayout').textContent='$0.00';

  const label=(won?'‚úÖ WIN +$':pnl===0?'‚ö™ ':'‚ùå -$')+Math.abs(pnl).toFixed(2);
  toast(label+' | '+reason+(isReal?' [REAL]':' [SIM]'),won?'g':'y',4000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KNOCK OUT (Barrier hit)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onKO(price){
  if(!con)return;
  const dir=price>=con.upper?'UPPER ‚ñ≤':'LOWER ‚ñº';
  const loss=con.stake,isReal=con.isReal;
  showFlash('flashExit','‚ùå KO! '+dir+' -$'+loss.toFixed(2),3500);
  $('chartWrap').classList.add('show-danger');
  setTimeout(()=>$('chartWrap').classList.remove('show-danger'),2500);
  toast('‚ùå Barrier hit! '+dir+' -$'+loss.toFixed(2)+(isReal?' [REAL]':' [SIM]'),'r',6000);
  ariaSpeak('Barrier hit. Will analyze next opportunity.');
  if(con.byAI){
    aiLoss++;aiTrades++;aiPnl=+(aiPnl-loss).toFixed(2);
    addHistItem({won:false,pnl:-loss,reason:'BARRIER HIT '+dir,ticks:con.ticks});
    aiCool=true;setTimeout(()=>{aiCool=false;},9000);
  }
  // ‚òÖ For real accounts: Deriv auto-handles KO ‚Äî balance subscription will push update
  if(isReal&&con.realId){
    send({sell:con.realId,price:0}); // attempt sell (may already be closed)
  } else if(!isReal&&realBalance!==null){
    realBalance=+(realBalance-loss).toFixed(2);
    updateBalanceUI();flashBalance();
  }
  isBuying=false;con=null;clearBarriers();exitProbability=0;updateExitMeter(0);
  $('exitMeter').classList.remove('on');renderNoContract();resetBarrierUI();
  $('sTicks').textContent='0';$('sPnl').textContent='$0.00';$('sPayout').textContent='$0.00';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTRACT UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateConUI(){
  if(!con){renderNoContract();return;}
  const pnlColor=con.pnl>=0?'var(--green)':'var(--red)';
  const elapsed=Math.round((now()-con.start)/1000);
  const barW=Math.min(100,Math.abs(con.pnl/con.stake)*200);
  const ep=exitProbability;
  const riskColor=ep<30?'var(--green)':ep<65?'var(--gold)':'var(--red)';
  const holdScore=prevP?computeHoldScore(prevP,con,tickBuf):50;
  $('sTicks').textContent=con.ticks;
  $('sPnl').textContent=(con.pnl>=0?'+$':'-$')+Math.abs(con.pnl).toFixed(2);$('sPnl').style.color=pnlColor;
  $('sPayout').textContent='$'+con.payout.toFixed(2);
  $('conPanel').innerHTML=`
    <div class="contract-box">
      <div class="con-hdr"><h4>‚ö° ${con.byAI?'ü§ñ AI ':''}ACTIVE ${con.isReal?'[REAL]':'[SIM]'}</h4><span class="pulse"></span></div>
      <div class="con-body">
        <div class="con-row"><span>Entry</span><span style="color:var(--blue);">${con.entry.toFixed(dp)}</span></div>
        <div class="con-row"><span>Upper ‚ñ≤</span><span style="color:var(--green);">${con.upper.toFixed(dp)}</span></div>
        <div class="con-row"><span>Lower ‚ñº</span><span style="color:var(--red);">${con.lower.toFixed(dp)}</span></div>
        <div class="con-row"><span>Ticks</span><span style="color:var(--blue);">${con.ticks}</span></div>
        <div class="con-row"><span>Hold Safety</span><span style="color:${holdScore>60?'var(--green)':holdScore>30?'var(--gold)':'var(--red)'};font-weight:800;">${holdScore}%</span></div>
        <div class="con-row"><span>Exit Risk</span><span style="color:${riskColor};font-weight:800;">${ep}%</span></div>
        <div class="pnl-bar"><div class="pnl-fill" style="width:${barW}%;background:${pnlColor};"></div></div>
        <div class="con-row"><span>P&L</span><span style="color:${pnlColor};font-size:14px;font-weight:800;">${con.pnl>=0?'+':'-'}$${Math.abs(con.pnl).toFixed(2)}</span></div>
        <div class="con-row"><span>Payout</span><span style="color:var(--gold);font-weight:700;">$${con.payout.toFixed(2)}</span></div>
        <div class="con-row"><span>Time</span><span>${elapsed}s</span></div>
        <button class="sell-btn" onclick="closeContract('Manual close',false)">‚ñ† Sell Now</button>
      </div>
    </div>`;
}
function renderNoContract(){
  $('conPanel').innerHTML=`<div class="no-con"><div class="ico">üéØ</div><div>${aiOn?'AI Sniper hunting‚Ä¶':'No active contract'}</div><div style="font-size:10px;margin-top:3px;">${aiOn?'Analyzing market‚Ä¶':'Click Buy Accumulator'}</div></div>`;
}
function resetBarrierUI(){
  if(prevP){const bd=barrierDist(prevP);$('bUpper').textContent=(prevP+bd).toFixed(dp);$('bLower').textContent=(prevP-bd).toFixed(dp);}
  $('bEntry').textContent='‚Äî';$('bSafety').textContent='‚Äî';$('infoHold').textContent='‚Äî';
}

function updatePhaseUI(){
  const el=$('sniperSt');el.className='sniper-st';
  switch(phase){
    case 'HUNTING':el.classList.add('st-hunt');el.textContent='üéØ HUNTING';break;
    case 'FIRE':el.classList.add('st-lock');el.textContent='‚ö° FIRING';break;
    case 'IN_TRADE':el.classList.add('st-lock');el.textContent='üìà IN TRADE';break;
    case 'EXITING':el.classList.add('st-exit');el.textContent='üö® EXITING!';break;
    default:el.classList.add('st-hunt');el.textContent='‚óè IDLE';
  }
}

function addHistItem({won,pnl,reason,ticks}){
  const h=$('aiHist'),empty=h.querySelector('div[style]');if(empty)empty.remove();
  const el=document.createElement('div');el.className='hist-item '+(won?'w':'l');
  el.innerHTML=`<div class="hist-dot" style="background:${won?'var(--green)':'var(--red)'};"></div>
    <div style="flex:1;"><div style="font-weight:700;color:${won?'var(--green)':'var(--red)'};">${pnl>=0?'+':'-'}$${Math.abs(pnl).toFixed(2)}</div>
    <div style="color:var(--sub);font-size:9px;">${reason.substring(0,34)} ¬∑ ${ticks}t</div></div>
    <div style="font-size:9px;color:var(--sub);">${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'})}</div>`;
  h.insertBefore(el,h.firstChild);
  const all=h.querySelectorAll('.hist-item');if(all.length>20)all[all.length-1].remove();
}

function addTickRow(price,chg,epoch){
  const up=chg>=0;
  const time=new Date(epoch*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const row=document.createElement('div');row.className='tick-row';
  row.innerHTML=`<span class="${up?'up':'dn'}">${price.toFixed(dp)}</span><span class="${up?'up':'dn'}">${up?'+':''}${chg.toFixed(dp)}</span><span style="color:var(--sub);">${time}</span>`;
  const feed=$('tickFeed');feed.insertBefore(row,feed.firstChild);
  const rows=feed.querySelectorAll('.tick-row');if(rows.length>MAX_FEED)rows[rows.length-1].remove();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VOICE AI ‚Äî ARIA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initVoice(){
  function loadVoice(){
    const vs=synth.getVoices();
    ariaVoice=vs.find(v=>v.name.includes('Samantha')||v.name.includes('Google UK English Female')||
      v.name.includes('Microsoft Zira')||v.name.includes('Karen')||v.name.includes('Moira'))
      ||vs.find(v=>v.lang.startsWith('en')&&v.localService)||vs[0]||null;
  }
  loadVoice();
  if(synth.onvoiceschanged!==undefined)synth.onvoiceschanged=loadVoice;
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){$('vpStatus').textContent='No mic ‚Äî use Chrome/Edge';return;}
  recognition=new SR();
  recognition.continuous=true;recognition.interimResults=false;recognition.lang='en-US';
  recognition.onstart=()=>{
    isListening=true;voiceRunning=true;
    $('micBtn').classList.add('listening');
    $('vpStatus').textContent='Always listening ‚Äî EN / Kiswahili‚Ä¶';
    $('avatarRing').className='vp-avatar-ring listening';
    $('voiceFab').classList.add('active');
    setWave(true);
  };
  recognition.onresult=e=>{
    const r=e.results[e.results.length-1];
    if(!r.isFinal)return;
    const text=r[0].transcript.trim();
    if(!text)return;
    addVpMsg(text,'user');processVoiceCmd(text);
  };
  recognition.onerror=e=>{
    if(e.error==='not-allowed'){
      voiceRunning=false;isListening=false;
      $('micBtn').classList.remove('listening');
      $('vpStatus').textContent='Mic blocked ‚Äî allow access';
      setWave(false);
    }
  };
  recognition.onend=()=>{
    isListening=false;
    if(voiceRunning){
      clearTimeout(voiceRestartTimer);
      voiceRestartTimer=setTimeout(()=>{
        if(voiceRunning&&!isSpeaking)try{recognition.start();}catch(e){}
      },350);
    } else {
      $('micBtn').classList.remove('listening');
      $('avatarRing').className='vp-avatar-ring';
      $('voiceFab').classList.remove('active');
      setWave(false);
      $('vpStatus').textContent='Paused ‚Äî tap üé§ to resume';
    }
  };
}

function startListen(){
  if(!recognition){ariaSpeak('Speech recognition needs Chrome or Edge browser.');return;}
  voiceRunning=true;
  try{recognition.abort();setTimeout(()=>recognition.start(),200);}catch(e){try{recognition.start();}catch(e2){}}
  $('vpStatus').textContent='Always listening‚Ä¶';
}
function stopListen(){
  voiceRunning=false;clearTimeout(voiceRestartTimer);
  try{recognition.abort();}catch(e){}
  isListening=false;
  $('micBtn').classList.remove('listening');
  $('avatarRing').className='vp-avatar-ring';
  $('voiceFab').classList.remove('active');
  setWave(false);
  $('vpStatus').textContent='Stopped ‚Äî tap üé§ to resume';
}

function ariaSpeak(text){
  if(!synth||!text)return;
  synth.cancel();
  const utt=new SpeechSynthesisUtterance(text);
  if(ariaVoice)utt.voice=ariaVoice;
  utt.rate=1.05;utt.pitch=1.1;utt.volume=1.0;
  utt.onstart=()=>{
    isSpeaking=true;
    $('vpStatus').textContent='Speaking‚Ä¶';
    $('avatarRing').className='vp-avatar-ring speaking';
    setWave(true);
    if(voiceRunning)try{recognition.abort();}catch(e){}
  };
  utt.onend=utt.onerror=()=>{
    isSpeaking=false;
    $('avatarRing').className='vp-avatar-ring listening';
    setWave(false);
    if(voiceRunning){
      clearTimeout(voiceRestartTimer);
      voiceRestartTimer=setTimeout(()=>{
        $('vpStatus').textContent='Listening‚Ä¶';
        try{recognition.start();}catch(e){}
      },450);
    } else {
      $('vpStatus').textContent='Ready‚Ä¶';
    }
  };
  synth.speak(utt);
  addVpMsg(text,'ai');
}

function setWave(on){for(let i=1;i<=7;i++){const b=$('vb'+i);if(b)b.classList.toggle('active',on);}}

function addVpMsg(text,who){
  const chat=$('vpChat');
  const el=document.createElement('div');el.className='vp-msg '+who;
  el.innerHTML=`<div>${text}</div><div class="vp-msg-time">${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'})}</div>`;
  chat.appendChild(el);chat.scrollTop=chat.scrollHeight;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ARIA ‚Äî Smart bilingual processor
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function processVoiceCmd(text){
  const t=text.toLowerCase().trim();
  const sw=isSW(t);
  let reply='';

  if(/\b(stop|pause|disable|turn off|shut|simama|zima|acha|sitisha)\b.*(ai|bot|sniper|trading|biashara)/i.test(t)){
    if(aiOn){$('aiToggle').checked=false;$('aiToggle').dispatchEvent(new Event('change'));}
    reply=sw?'AI imesimamishwa.':'AI Sniper stopped.';
  }
  else if(/\b(start|resume|enable|turn on|activate|anza|washa|amsha|anzisha)\b.*(ai|bot|sniper|trading|biashara)/i.test(t)){
    if(!aiOn){$('aiToggle').checked=true;$('aiToggle').dispatchEvent(new Event('change'));}
    reply=sw?'AI Sniper imeanzishwa!':'AI Sniper activated!';
  }
  else if(/\b(scan|search|find|best|check|angalia|tafuta|bora|badilisha|linganisha)\b.*(market|volatil|soko|index)/i.test(t)){
    reply=sw?'Ninachunguza masoko yote.':'Scanning all volatility indices now.';
    setTimeout(()=>runVolScan(false),400);
  }
  else if(/\b(balance|salio|pesa|how much|kuna ngapi|ninayo)\b/i.test(t)){
    const bal=realBalance!==null?userCurrency+' '+realBalance.toFixed(2):'not connected';
    const pnlTxt=aiPnl>=0?'up $'+aiPnl.toFixed(2):'down $'+Math.abs(aiPnl).toFixed(2);
    reply=sw?'Salio lako ni '+(realBalance!==null?userCurrency+' '+realBalance.toFixed(2):'haijaunganishwa')+'. AI: '+(aiPnl>=0?'chanya':'hasi')+' $'+Math.abs(aiPnl).toFixed(2)+'.':
      'Your balance is '+bal+'. AI P&L is '+pnlTxt+'.';
  }
  else if(/\b(profit|pnl|performance|stats|faida|takwimu|mapato)\b/i.test(t)){
    const wr=aiTrades>0?((aiWins/aiTrades)*100).toFixed(0)+'%':'no trades';
    reply=sw?'Biashara:'+aiTrades+'. Ushindi:'+aiWins+'. Asilimia:'+wr+'. Faida:$'+aiPnl.toFixed(2)+'.':
      'Trades:'+aiTrades+' Wins:'+aiWins+' Rate:'+wr+' P&L:$'+aiPnl.toFixed(2)+'.';
  }
  else if(/\b(current|active|holding|open|inayoendelea|sasa|shikilia)\b/i.test(t)){
    if(con){
      const hs=prevP?computeHoldScore(prevP,con,tickBuf):50;
      reply=sw?'Ninashikilia '+sym+'. Tiki:'+con.ticks+'. P&L:$'+con.pnl.toFixed(2)+'. Usalama:'+hs+'%.':
        'Holding '+sym+'. '+con.ticks+' ticks. P&L $'+con.pnl.toFixed(2)+'. Safety '+hs+'%.';
    } else {
      reply=sw?'Hakuna biashara inayoendelea.':'No active trade right now.';
    }
  }
  else if(/\b(sell|close|exit|uza|funga|toka)\b/i.test(t)){
    if(con){closeContract('Voice command',false);reply=sw?'Ninafunga biashara.':'Closing trade now.';}
    else{reply=sw?'Hakuna biashara ya kufunga.':'No active trade to close.';}
  }
  else if(/\b(buy|open|nunua|ingiza|fungua)\b/i.test(t)){
    if(con){reply=sw?'Biashara iko hai.':'Already in a trade.';}
    else{buyContract(false);reply=sw?'Ninaweka mkopo.':'Placing accumulator trade.';}
  }
  else if(/\b(stake|kiasi)\b.*\b(\d+)\b/i.test(t)||/\b(\d+)\b.*(stake|kiasi)\b/i.test(t)){
    const m=t.match(/\d+(\.\d+)?/);
    if(m){stake=Math.min(50000,Math.max(1,parseFloat(m[0])));$('stkInput').value=stake;$('stkRange').value=Math.min(stake,1000);reply=sw?'Kiasi kimewekwa $'+stake+'.':'Stake set to $'+stake+'.';}
    else{reply=sw?'Sema nambari.':'Please say a number.';}
  }
  else if(/\b(increase|ongeza|zaidi)\b.*(stake|kiasi)/i.test(t)){
    const m=t.match(/\d+(\.\d+)?/);const ns=m?parseFloat(m[0]):stake+10;
    stake=Math.min(50000,ns);$('stkInput').value=stake;$('stkRange').value=Math.min(stake,1000);
    reply=sw?'Kiasi cha $'+stake+'.':'Stake $'+stake+'.';
  }
  else if(/\b(decrease|reduce|punguza|chini)\b.*(stake|kiasi)/i.test(t)){
    const m=t.match(/\d+(\.\d+)?/);const ns=m?parseFloat(m[0]):Math.max(1,stake-5);
    stake=Math.max(1,ns);$('stkInput').value=stake;$('stkRange').value=Math.min(stake,1000);
    reply=sw?'Kiasi cha $'+stake+'.':'Stake $'+stake+'.';
  }
  else if(/\b(what|how|doing|explain|unafanya|hali|eleza)\b/i.test(t)){
    if(aiOn){
      if(con){const hs=prevP?computeHoldScore(prevP,con,tickBuf):50;reply=sw?'Ninashikilia biashara kwenye '+sym+'. Usalama:'+hs+'%. Ninaangalia vizuizi kila sekunde.':'Holding on '+sym+'. Safety '+hs+'%. Monitoring every tick for barrier threat.';}
      else{reply=sw?'Ninatafuta fursa nzuri kwenye '+sym+'. Tiki '+tickBuf.length+'/100.':'Hunting for entry on '+sym+'. '+tickBuf.length+' of 100 ticks collected.';}
    }else{reply=sw?'AI imezimwa.':'AI Sniper is off. Say start AI.';}
  }
  else if(/\b(price|bei|thamani)\b/i.test(t)){
    reply=sw?'Bei ya '+sym+' ni '+(prevP?prevP.toFixed(dp):'‚Äî')+'.':'Price of '+sym+' is '+(prevP?prevP.toFixed(dp):'unknown')+'.';
  }
  else if(/\b(hello|hi|hey|habari|mambo|salama|vipi|niaje|hujambo)\b/i.test(t)){
    reply=sw?'Habari! Mimi ni ARIA, msaidizi wako wa AI. Ninakusikia kila wakati!':'Hello! I am ARIA your AI trading assistant. Always listening!';
  }
  else if(/\b(help|msaada|amri|commands)\b/i.test(t)){
    reply=sw?'Unaweza kusema: anza AI, simama AI, salio langu, tafuta soko bora, uza biashara, au chochote!':'Say: start AI, stop AI, my balance, scan markets, sell trade, current status, or just chat!';
  }
  else if(/\b(thanks|asante|sawa|nzuri|vizuri|good|great)\b/i.test(t)){
    reply=sw?'Karibu sana! Ninaendelea kufanya kazi.':'You are welcome! Always here for you.';
  }
  else if(t.includes('?')){
    reply=sw?'Swali zuri! Ninaendelea kuchunguza soko la '+sym+'. Unaweza kuniuliza chochote.':'Great question! Currently watching '+sym+'. Ask me anything about trading.';
  }
  else{
    reply=sw?'Ninakusikia! Endelea kunisemea kuhusu biashara yako.':'I am always listening! Tell me what you need ‚Äî trading help, balance, stats, or just chat.';
  }

  setTimeout(()=>ariaSpeak(reply),250);
}

function isSW(t){
  const kw=['habari','mambo','salama','vipi','sawa','asante','tafadhali','ndiyo','hapana','anza','simama','acha','weka','ongeza','punguza','badilisha','angalia','tafuta','biashara','faida','salio','pesa','kiasi','kiwango','soko','mstari','ninafanya','ninashikilia','ninatoka','ninachunguza','karibu','naelewa','nimesikia','hujambo','shikamoo'];
  return kw.some(w=>t.includes(w));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOBILE UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openLeft(){$('leftPanel').classList.add('open');$('panelOverlay').classList.add('on');}
function closeLeft(){$('leftPanel').classList.remove('open');$('panelOverlay').classList.remove('on');}
function openRight(){$('rightPanel').classList.add('open');$('panelOverlay').classList.add('on');}
function closeRight(){$('rightPanel').classList.remove('open');$('panelOverlay').classList.remove('on');}
function closeAllPanels(){closeLeft();closeRight();}

function setupMobile(){
  const mq900=window.matchMedia('(max-width:900px)');
  const mq1100=window.matchMedia('(max-width:1100px)');
  function apply(){
    const m9=mq900.matches,m11=mq1100.matches;
    $('menuBtn').style.display=m9?'block':'none';
    $('rightPanelBtn').style.display=m11?'flex':'none';
  }
  apply();mq900.addEventListener('change',apply);mq1100.addEventListener('change',apply);

  $('menuBtn').addEventListener('click',()=>{
    $('leftPanel').classList.contains('open')?closeLeft():openLeft();
  });
  $('mobLeft').addEventListener('click',()=>openLeft());
  $('mobRight').addEventListener('click',()=>openRight());
  $('rightPanelBtn').addEventListener('click',()=>{
    $('rightPanel').classList.contains('open')?closeRight():openRight();
  });
  $('panelOverlay').addEventListener('click',closeAllPanels);

  $('bnLeft').addEventListener('click',()=>openLeft());
  $('bnChart').addEventListener('click',()=>closeAllPanels());
  $('bnRight').addEventListener('click',()=>openRight());
  $('bnVoice').addEventListener('click',()=>toggleVP());
}

function toggleVP(){
  voiceOpen=!voiceOpen;
  $('voicePanel').classList.toggle('open',voiceOpen);
  if(voiceOpen){
    $('voiceFab').style.display='none';
    if(!voiceRunning){
      setTimeout(()=>{
        startListen();
        if($('vpChat').children.length===0)
          setTimeout(()=>ariaSpeak('Hello! I am ARIA, always listening in English and Kiswahili. Just talk to me!'),600);
      },300);
    }
  } else {
    $('voiceFab').style.display='flex';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT ‚Äî Called after login
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function bootApp(){
  if(appReady)return;
  appReady=true;
  initChart();
  initVoice();
  renderNoContract();
  $('sGrowth').textContent=gr+'%';
  updatePhaseUI();
  setupMobile();

  // ‚òÖ Connect WebSocket ONCE
  connect();

  // AI toggle
  $('aiToggle').addEventListener('change',function(){
    aiOn=this.checked;
    $('aiBody').classList.toggle('on',aiOn);
    $('aiOv').classList.toggle('on',aiOn);
    if(aiOn){
      phase='HUNTING';aiCool=false;exitingNow=false;
      updatePhaseUI();$('sbAI').style.color='var(--purple)';
      toast('ü§ñ AI Sniper ACTIVE','p');
      lastVolAutoSwitch=0;
      setTimeout(()=>runVolScan(false),1500);
    } else {
      phase='IDLE';updatePhaseUI();
      $('sbAI').textContent='AI:OFF';$('sbAI').style.color='var(--sub)';
      if(con&&con.byAI)closeContract('AI disabled',false);
    }
  });

  $('symList').addEventListener('click',e=>{
    const b=e.target.closest('.sym-btn');if(!b)return;
    switchSym(b.dataset.sym,parseInt(b.dataset.dp));
    closeLeft();
    toast('Switched to '+b.textContent.trim(),'');
  });
  $('grGrid').addEventListener('click',e=>{
    const b=e.target.closest('.gr-btn');if(!b)return;
    document.querySelectorAll('.gr-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');gr=parseInt(b.dataset.r);$('sGrowth').textContent=gr+'%';
  });
  $('stkInput').addEventListener('input',()=>{stake=parseFloat($('stkInput').value)||10;$('stkRange').value=Math.min(stake,1000);});
  $('stkRange').addEventListener('input',()=>{stake=parseInt($('stkRange').value);$('stkInput').value=stake;});
  $('stkUp').addEventListener('click',()=>{stake=Math.min(50000,stake+1);$('stkInput').value=stake;$('stkRange').value=Math.min(stake,1000);});
  $('stkDn').addEventListener('click',()=>{stake=Math.max(1,stake-1);$('stkInput').value=stake;$('stkRange').value=stake;});
  $('tpToggle').addEventListener('change',function(){
    const on=this.checked;$('tpInput').disabled=!on;$('tpInput').style.opacity=on?'1':'.4';
    tp=on?parseFloat($('tpInput').value):null;
  });
  $('tpInput').addEventListener('input',()=>{tp=$('tpToggle').checked?parseFloat($('tpInput').value):null;});
  $('buyBtn').addEventListener('click',()=>{if(con){toast('‚ö† Sell current contract first','r');return;}buyContract(false);});
  $('scanVolBtn').addEventListener('click',()=>runVolScan(false));
  $('scanClose').addEventListener('click',()=>$('scanOverlay').classList.remove('open'));
  $('scanOverlay').addEventListener('click',e=>{if(e.target===$('scanOverlay'))$('scanOverlay').classList.remove('open');});
  $('logoutBtn').addEventListener('click',logout);

  // Voice
  $('voiceFab').addEventListener('click',toggleVP);
  $('vpClose').addEventListener('click',()=>{voiceOpen=false;$('voicePanel').classList.remove('open');$('voiceFab').style.display='flex';});
  $('micBtn').addEventListener('click',()=>{
    if(voiceRunning){stopListen();$('micBtn').textContent='üé§';toast('üîá Voice paused','y');}
    else{startListen();$('micBtn').textContent='üî¥';toast('üé§ ARIA always listening','p');}
  });
  $('vpSend').addEventListener('click',sendText);
  $('vpTextInput').addEventListener('keydown',e=>{if(e.key==='Enter')sendText();});

  // Timers
  setInterval(()=>{if(con)updateConUI();},900);
  setInterval(()=>$('sbTime').textContent=new Date().toLocaleTimeString(),1000);

  // Network events
  window.addEventListener('online',()=>{toast('üåê Network restored','');connect();});
  window.addEventListener('offline',()=>{toast('‚ö† Network offline!','r');setDot('err');$('connBanner').classList.add('show');});
  document.addEventListener('visibilitychange',()=>{
    if(!document.hidden&&!wsAlive){reconnDelay=1000;connect();}
  });

  // Auto vol scan every 4 min if AI on
  setInterval(()=>{
    if(!aiOn||con)return;
    if(Date.now()-lastVolAutoSwitch>4*60*1000){lastVolAutoSwitch=Date.now();runVolScan(true);}
  },60000);

  // Start ARIA after 2s
  setTimeout(()=>{
    startListen();
    toast('üé§ ARIA always listening ‚Äî EN & Kiswahili','p',5000);
  },2000);
}

function sendText(){
  const v=$('vpTextInput').value.trim();if(!v)return;
  addVpMsg(v,'user');$('vpTextInput').value='';processVoiceCmd(v);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
$('loginBtn').href=getOAuthURL();
$('demoBtn').addEventListener('click',()=>{
  token='';
  $('loginOverlay').style.display='none';
  bootApp();
  toast('üëÅ Demo Mode ‚Äî simulated trades only','',5000);
  setTimeout(()=>ariaSpeak('Welcome to demo mode! I am ARIA, your AI trading assistant. Enable the AI Sniper to start.'),1000);
});

// Check for OAuth token in URL or localStorage
(function(){
  const urlTok=parseOAuthToken();
  if(urlTok){
    token=urlTok;
    try{window.history.replaceState({},'',window.location.pathname);}catch(e){}
    // Save all tokens found in URL
    try{localStorage.setItem('deriv_accounts',JSON.stringify(allTokens));}catch(e){}
    $('loginOverlay').style.display='none';
    bootApp();
  } else {
    parseStoredTokens(); // Load stored multi-account tokens
    const saved=localStorage.getItem('deriv_tk');
    if(saved){
      token=saved;
      $('loginOverlay').style.display='none';
      bootApp();
    }
    // else: login overlay stays visible
  }
})();
</script>
</body>
</html>
