<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Deriv Accumulator â€” AI Sniper Pro</title>
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<style>
:root{
  --green:#00e676;--red:#ff3d71;--blue:#00b0ff;
  --gold:#ffd600;--purple:#c084fc;--orange:#ff9800;
  --bg:#0a0d12;--card:#111620;--card2:#161c26;
  --border:#1e2736;--text:#e6edf3;--sub:#7d8fa3;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;display:flex;flex-direction:column;-webkit-text-size-adjust:100%;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:#2a3444;border-radius:4px;}

/* LOGIN */
.login-overlay{position:fixed;inset:0;background:linear-gradient(160deg,#0a0d12,#0d1020);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;overflow-y:auto;}
.login-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:28px 22px;max-width:400px;width:100%;text-align:center;box-shadow:0 20px 60px #00000080;}
.login-logo{font-size:44px;margin-bottom:10px;}
.login-title{font-size:20px;font-weight:800;margin-bottom:6px;background:linear-gradient(135deg,#00b0ff,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.login-sub{font-size:12px;color:var(--sub);margin-bottom:20px;line-height:1.6;}
.login-sub-msg{font-size:10px;color:var(--sub);margin-top:4px;font-style:italic;}
.login-features{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px;text-align:left;}
.login-feat{background:#0a0d12;border:1px solid var(--border);border-radius:10px;padding:10px;display:flex;align-items:flex-start;gap:7px;}
.login-feat-icon{font-size:18px;flex-shrink:0;}
.login-feat-text .t{font-size:11px;font-weight:700;margin-bottom:2px;}
.login-feat-text .s{font-size:9px;color:var(--sub);}
.btn-login{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:16px;border:none;border-radius:12px;background:linear-gradient(135deg,#cc2936,#ff444f);color:#fff;font-size:15px;font-weight:800;cursor:pointer;transition:all .2s;margin-bottom:12px;letter-spacing:.3px;text-decoration:none;-webkit-tap-highlight-color:transparent;touch-action:manipulation;box-shadow:0 4px 20px #cc293650;user-select:none;}
.btn-login:active{transform:scale(0.97);opacity:.9;}
.btn-login svg{width:22px;height:22px;flex-shrink:0;}
.login-note{font-size:10px;color:var(--sub);line-height:1.6;}
.login-note a{color:var(--blue);text-decoration:none;}
.login-divider{display:flex;align-items:center;gap:10px;margin:12px 0;}
.login-divider span{font-size:10px;color:var(--sub);white-space:nowrap;}
.login-divider::before,.login-divider::after{content:'';flex:1;height:1px;background:var(--border);}

/* HEADER */
header{height:48px;background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 8px;flex-shrink:0;z-index:20;gap:4px;}
.logo{display:flex;align-items:center;gap:4px;flex-shrink:0;min-width:0;}
.logo-icon{width:22px;height:22px;flex-shrink:0;}
.logo-text{font-size:13px;font-weight:800;letter-spacing:-.3px;white-space:nowrap;}
.logo-tag{font-size:7px;font-weight:800;letter-spacing:1px;padding:2px 5px;border-radius:20px;background:linear-gradient(135deg,#cc2936,#ff444f);color:#fff;white-space:nowrap;}
.ai-tag{font-size:7px;font-weight:800;letter-spacing:1px;padding:2px 5px;border-radius:20px;background:linear-gradient(135deg,#6d28d9,#a855f7);color:#fff;animation:aiGlow 2s infinite;white-space:nowrap;}
@keyframes aiGlow{0%,100%{box-shadow:0 0 8px #a855f760;}50%{box-shadow:0 0 20px #a855f7aa;}}
@media(max-width:480px){.logo-tag,.ai-tag{display:none;}}
@media(max-width:360px){.logo-text{display:none;}}
.hdr-right{display:flex;align-items:center;gap:4px;flex-shrink:0;}
.hdr-badge{display:flex;align-items:center;gap:3px;background:#0a0d12;border:1px solid var(--border);border-radius:6px;padding:3px 6px;font-size:10px;white-space:nowrap;flex-shrink:0;}
.hdr-badge .val{font-weight:700;font-size:11px;}
@media(max-width:540px){.hdr-badge-hide{display:none!important;}}
.ws-pill{display:flex;align-items:center;gap:3px;flex-shrink:0;}
.ws-dot{width:7px;height:7px;border-radius:50%;background:#333;transition:all .3s;flex-shrink:0;}
.ws-dot.on{background:var(--green);box-shadow:0 0 8px var(--green);animation:blink 2s infinite;}
.ws-dot.err{background:var(--red);box-shadow:0 0 8px var(--red);}
.ws-dot.rc{background:var(--gold);animation:rcBlink .5s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.5;}}
@keyframes rcBlink{0%,100%{opacity:1;}50%{opacity:.3;}}

/* LAYOUT */
.layout{display:flex;flex:1;overflow:hidden;position:relative;}

/* LEFT PANEL */
.left{width:230px;min-width:230px;background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;transition:transform .28s cubic-bezier(.4,0,.2,1);z-index:15;}
.left-scroll{flex:1;overflow-y:auto;overflow-x:hidden;}
@media(max-width:860px){
  .left{position:absolute;top:0;left:0;height:100%;transform:translateX(-100%);width:85vw;min-width:0;max-width:320px;}
  .left.open{transform:translateX(0);box-shadow:6px 0 30px #00000090;}
}

/* RIGHT PANEL */
.right{width:210px;min-width:210px;background:var(--card);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;transition:transform .28s;z-index:15;}
@media(max-width:1060px){
  .right{position:absolute;top:0;right:0;height:100%;transform:translateX(100%);width:85vw;min-width:0;max-width:300px;}
  .right.open{transform:translateX(0);box-shadow:-6px 0 30px #00000090;}
}

/* PANEL OVERLAY */
.panel-overlay{display:none;position:absolute;inset:0;background:#00000070;z-index:14;backdrop-filter:blur(2px);}
.panel-overlay.on{display:block;}

/* CENTER */
.center{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}

/* MOBILE TOP BAR */
.mob-topbar{display:none;height:42px;background:var(--card2);border-bottom:1px solid var(--border);align-items:center;justify-content:space-between;padding:0 8px;flex-shrink:0;gap:6px;}
@media(max-width:860px){.mob-topbar{display:flex;}}
.mob-btn{background:#1e2736;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 11px;font-size:11px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:4px;transition:all .15s;-webkit-tap-highlight-color:transparent;white-space:nowrap;flex-shrink:0;}
.mob-btn:active{background:#2a3444;transform:scale(.97);}
.mob-price{font-size:14px;font-weight:800;font-variant-numeric:tabular-nums;text-align:center;flex:1;}

/* BOTTOM NAV */
.bottom-nav{display:none;height:56px;background:var(--card);border-top:1px solid var(--border);align-items:stretch;justify-content:space-around;flex-shrink:0;z-index:16;padding:0;}
@media(max-width:600px){.bottom-nav{display:flex;}}
.bnav-btn{background:none;border:none;color:var(--sub);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-size:9px;font-weight:700;padding:4px 2px;border-radius:0;transition:all .2s;-webkit-tap-highlight-color:transparent;flex:1;border-top:2px solid transparent;}
.bnav-btn.active{color:var(--blue);border-top-color:var(--blue);}
.bnav-btn .bnav-ico{font-size:22px;line-height:1;}
@media(max-width:600px){
  .voice-fab{bottom:68px!important;}
  .voice-panel{bottom:58px!important;}
  #toast{bottom:72px!important;}
}

/* SECTIONS */
.sec{padding:8px 10px;border-bottom:1px solid var(--border);flex-shrink:0;}
.sec-title{font-size:9px;font-weight:700;letter-spacing:1.2px;color:var(--sub);text-transform:uppercase;margin-bottom:6px;}

/* USER CARD */
.user-card{background:linear-gradient(135deg,#0d1a2e,#111a2e);border:1px solid #1e3a5f;border-radius:10px;padding:10px;margin:8px 9px;flex-shrink:0;}
.user-row{display:flex;align-items:center;gap:8px;}
.user-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#6d28d9,#a855f7);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.user-info .name{font-size:12px;font-weight:700;}
.user-info .uid{font-size:9px;color:var(--sub);margin-top:1px;}
.user-bal{font-size:18px;font-weight:800;color:var(--gold);margin-top:6px;}
.user-bal-lbl{font-size:9px;color:var(--sub);}
.btn-logout{width:100%;margin-top:7px;padding:6px;border:1px solid var(--red);border-radius:7px;background:transparent;color:var(--red);font-size:11px;font-weight:700;cursor:pointer;-webkit-tap-highlight-color:transparent;}

/* ACCOUNT SWITCHER */
.acct-switcher{margin-top:8px;}
.acct-switcher-lbl{font-size:9px;color:var(--sub);text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px;}
.acct-drop-wrap{position:relative;}
.acct-drop-btn{width:100%;background:#0a0d12;border:1px solid var(--border);border-radius:7px;color:var(--text);padding:7px 10px;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:6px;-webkit-tap-highlight-color:transparent;-webkit-appearance:none;appearance:none;touch-action:manipulation;}
.acct-cur{display:flex;align-items:center;gap:6px;min-width:0;}
.acct-cur-tag{font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;flex-shrink:0;}
.acct-cur-name{font-size:11px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.acct-cur-bal{font-size:10px;color:var(--gold);font-weight:700;flex-shrink:0;}
.acct-arrow{font-size:10px;color:var(--sub);flex-shrink:0;transition:transform .2s;}
.acct-arrow.open{transform:rotate(180deg);}
.acct-menu{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--card2);border:1px solid var(--border);border-radius:9px;z-index:500;overflow:hidden;box-shadow:0 8px 28px #00000080;display:none;}
.acct-menu.open{display:block;}
.acct-menu-item{display:flex;align-items:center;gap:8px;padding:10px 11px;cursor:pointer;transition:background .15s;border-bottom:1px solid var(--border);-webkit-tap-highlight-color:transparent;touch-action:manipulation;}
.acct-menu-item:last-child{border-bottom:none;}
.acct-menu-item:hover{background:#00b0ff08;}
.acct-menu-item:active{background:#00b0ff18;}
.acct-menu-item.active-acct{background:#00e67608;}
.acct-menu-tag{font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;flex-shrink:0;}
.tag-demo{background:#1e2736;color:var(--sub);}
.tag-real{background:#003d1a;color:var(--green);}
.tag-crypto{background:#1a0d2e;color:var(--purple);}
.acct-menu-info{flex:1;min-width:0;}
.acct-menu-id{font-size:11px;font-weight:700;}
.acct-menu-cur{font-size:9px;color:var(--sub);}
.acct-menu-bal{font-size:11px;font-weight:700;color:var(--gold);flex-shrink:0;}
.acct-check{font-size:14px;color:var(--green);flex-shrink:0;visibility:hidden;}
.acct-menu-item.active-acct .acct-check{visibility:visible;}

/* AI TOGGLE ROW */
.ai-wrap{border-bottom:1px solid var(--border);background:linear-gradient(160deg,#0e0720,#0a0d12);flex-shrink:0;}
.ai-toggle-row{display:flex;align-items:center;justify-content:space-between;padding:10px 11px;flex-shrink:0;}
.ai-lbl{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:700;color:var(--purple);}
.toggle{position:relative;width:46px;height:25px;flex-shrink:0;}
.toggle input{display:none;}
.tslider{position:absolute;inset:0;background:#1e2736;border-radius:25px;cursor:pointer;transition:background .3s;border:1px solid var(--border);}
.tslider:before{content:'';position:absolute;width:19px;height:19px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform .3s;}
.toggle input:checked+.tslider{background:linear-gradient(135deg,#6d28d9,#a855f7);border-color:#a855f7;box-shadow:0 0 14px #a855f750;}
.toggle input:checked+.tslider:before{transform:translateX(21px);}

/* AI BODY */
.ai-body{background:#08041a;border-top:1px solid #6d28d922;padding:8px;display:none;overflow-y:auto;max-height:calc(100vh - 280px);}
.ai-body.on{display:block;}
.ai-head-row{display:flex;align-items:center;gap:7px;margin-bottom:8px;padding-bottom:7px;border-bottom:1px solid #6d28d922;}
.brain{font-size:18px;animation:brainPulse 1.2s infinite;flex-shrink:0;}
@keyframes brainPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.12);filter:brightness(1.4);}}
.brain-info .t{font-size:10px;font-weight:700;color:var(--purple);}
.brain-info .s{font-size:8px;color:var(--sub);margin-top:1px;}
.ind-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:6px;}
.ind-card{background:#0f0826;border:1px solid #6d28d920;border-radius:6px;padding:5px 7px;}
.ind-card .lbl{font-size:8px;color:var(--sub);text-transform:uppercase;letter-spacing:.8px;margin-bottom:2px;}
.ind-card .val{font-size:11px;font-weight:700;}
.sig-box{border-radius:7px;padding:7px;text-align:center;margin-bottom:6px;border:1px solid transparent;transition:all .3s;background:#0d1320;}
.sig-box.BUY{border-color:var(--green);background:#00e67612;}
.sig-box.WAIT{border-color:var(--gold);background:#ffd60012;}
.sig-box.SCAN{border-color:var(--purple);background:#a855f712;}
.sig-txt{font-size:13px;font-weight:800;letter-spacing:1px;}
.sig-txt.BUY{color:var(--green);}
.sig-txt.WAIT{color:var(--gold);}
.sig-txt.SCAN{color:var(--purple);}
.sig-sub{font-size:9px;color:var(--sub);margin-top:2px;}
.scan-bar{height:3px;background:#1e2736;border-radius:2px;overflow:hidden;margin-bottom:6px;}
.scan-fill{height:100%;border-radius:2px;width:0%;background:linear-gradient(90deg,#6d28d9,#a855f7,#00e676);background-size:200%;animation:scanGrad .6s linear infinite;transition:width .04s;}
@keyframes scanGrad{0%{background-position:0%;}100%{background-position:200%;}}
.ai-stats{display:flex;justify-content:space-between;margin-bottom:6px;}
.aistat .n{font-size:12px;font-weight:700;}
.aistat .l{font-size:8px;color:var(--sub);text-transform:uppercase;margin-top:1px;}

/* PATTERN BOX */
.pattern-box{background:#060d18;border:1px solid #ffd60033;border-radius:8px;padding:7px;margin-bottom:6px;}
.pattern-box .lbl{font-size:9px;color:var(--gold);font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px;}
.pattern-row{display:flex;justify-content:space-between;font-size:10px;margin-bottom:2px;}
.pattern-row span:first-child{color:var(--sub);}
.pattern-row span:last-child{font-weight:700;}

/* VOL SCANNER */
.vol-scanner{background:#060d18;border:1px solid #0060aa44;border-radius:8px;padding:8px;margin-bottom:6px;}
.vol-scan-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.vol-scan-lbl{font-size:10px;font-weight:700;color:var(--blue);display:flex;align-items:center;gap:4px;}
.vol-scan-btn{background:linear-gradient(135deg,#003d6e,#0060aa);border:none;border-radius:5px;color:#fff;font-size:9px;font-weight:700;padding:3px 8px;cursor:pointer;-webkit-tap-highlight-color:transparent;}
.vol-list{display:flex;flex-direction:column;gap:3px;max-height:130px;overflow-y:auto;}
.vol-item{display:flex;align-items:center;gap:5px;padding:4px 6px;border-radius:6px;border:1px solid transparent;cursor:pointer;transition:all .15s;background:#0a0d12;-webkit-tap-highlight-color:transparent;}
.vol-item:active{border-color:var(--blue);}
.vol-item.best{border-color:var(--green);background:#00e67608;}
.vol-item.active-sym{border-color:var(--blue);background:#00b0ff10;}
.vol-name{font-size:10px;font-weight:700;flex:1;}
.vol-score-bar{width:40px;height:4px;background:#1e2736;border-radius:2px;overflow:hidden;}
.vol-score-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--red),var(--gold),var(--green));}
.vol-score-num{font-size:9px;font-weight:700;width:22px;text-align:right;}
.vol-badge{font-size:8px;padding:1px 4px;border-radius:3px;font-weight:700;}
.vol-badge.best{background:#00e67622;color:var(--green);}
.vol-badge.good{background:#ffd60022;color:var(--gold);}
.vol-badge.bad{background:#ff3d7122;color:var(--red);}

/* CONTROLS */
select,input[type=number]{width:100%;background:#0a0d12;border:1px solid var(--border);color:var(--text);border-radius:6px;padding:7px 9px;font-size:12px;outline:none;transition:border .2s;}
select:focus,input[type=number]:focus{border-color:var(--blue);}
input[type=range]{width:100%;height:4px;accent-color:var(--blue);cursor:pointer;margin-top:4px;padding:0;border:none;background:transparent;}
.sym-list{display:flex;flex-direction:column;gap:4px;}
.sym-btn{background:transparent;border:1px solid var(--border);color:var(--text);border-radius:6px;padding:7px 9px;font-size:11px;cursor:pointer;transition:all .15s;text-align:left;display:flex;align-items:center;justify-content:space-between;-webkit-tap-highlight-color:transparent;}
.sym-btn:active{background:#00b0ff0a;}
.sym-btn.active{border-color:var(--blue);background:#00b0ff15;color:#fff;font-weight:600;}
.sym-badge{font-size:9px;color:var(--sub);background:#ffffff0d;padding:1px 5px;border-radius:3px;}
.gr-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;}
.gr-btn{background:transparent;border:1px solid var(--border);color:var(--sub);border-radius:5px;padding:7px 0;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;text-align:center;-webkit-tap-highlight-color:transparent;}
.gr-btn:active{border-color:var(--green);color:var(--green);}
.gr-btn.active{border-color:var(--green);background:#00e67615;color:var(--green);}
.stake-row{display:flex;align-items:center;gap:5px;}
.stake-row input{flex:1;}
.sadj{background:var(--border);border:none;color:var(--text);width:32px;height:32px;border-radius:5px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;-webkit-tap-highlight-color:transparent;}
.sadj:active{background:#2a3a4a;}
.tp-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.sw2{position:relative;width:36px;height:20px;flex-shrink:0;}
.sw2 input{display:none;}
.sl2{position:absolute;inset:0;background:var(--border);border-radius:20px;cursor:pointer;transition:background .2s;}
.sl2:before{content:'';position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;top:3px;left:3px;transition:transform .2s;}
.sw2 input:checked+.sl2{background:var(--blue);}
.sw2 input:checked+.sl2:before{transform:translateX(16px);}
.buy-btn{width:100%;padding:14px;border:none;border-radius:8px;background:linear-gradient(135deg,#00a844,#00e676);color:#000;font-size:14px;font-weight:800;cursor:pointer;transition:all .2s;-webkit-tap-highlight-color:transparent;}
.buy-btn:active{transform:scale(.98);}

/* CHART TOP */
.chart-top{background:var(--card);border-bottom:1px solid var(--border);height:44px;display:flex;align-items:center;padding:0 10px;gap:8px;flex-shrink:0;overflow:hidden;}
.price-main{font-size:20px;font-weight:700;font-variant-numeric:tabular-nums;white-space:nowrap;}
@media(max-width:400px){.price-main{font-size:16px;}}
.price-chg{font-size:10px;font-weight:600;padding:2px 5px;border-radius:4px;white-space:nowrap;}
.up{color:var(--green);}.dn{color:var(--red);}
.ub{background:#00e67618;color:var(--green);}
.db{background:#ff3d7118;color:var(--red);}
.chart-meta{margin-left:auto;display:flex;gap:8px;font-size:9px;color:var(--sub);flex-shrink:0;}
@media(max-width:600px){.chart-meta{display:none;}}

/* CHART */
.chart-wrap{flex:1;position:relative;overflow:hidden;}
#chart{width:100%;height:100%;}

/* AI OVERLAY */
.ai-ov{position:absolute;top:7px;left:7px;background:#0a0d12ee;backdrop-filter:blur(14px);border:1px solid #6d28d966;border-radius:9px;padding:8px 10px;min-width:130px;z-index:6;display:none;max-width:44%;}
.ai-ov.on{display:block;}
.ai-ov h5{font-size:9px;color:var(--purple);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;display:flex;align-items:center;gap:4px;}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:livePulse 1s infinite;flex-shrink:0;}
@keyframes livePulse{0%,100%{transform:scale(1);opacity:1;}50%{transform:scale(.5);opacity:.4;}}
.ov-row{display:flex;justify-content:space-between;margin-bottom:2px;font-size:9px;gap:4px;}
.ov-row span:first-child{color:var(--sub);}
.ov-row span:last-child{font-weight:700;text-align:right;}
.ov-hr{border:none;border-top:1px solid #6d28d922;margin:4px 0;}
.sniper-st{font-size:9px;font-weight:700;letter-spacing:.8px;text-align:center;padding:3px 5px;border-radius:5px;margin-top:2px;}
.st-hunt{background:#6d28d920;color:var(--purple);}
.st-lock{background:#00e67618;color:var(--green);}
.st-exit{background:#ff3d7118;color:var(--red);animation:exitPulse .4s infinite;}
@keyframes exitPulse{0%,100%{opacity:1;}50%{opacity:.4;}}

/* BARRIER LEGEND */
.bar-leg{position:absolute;top:7px;right:7px;background:#0a0d12ee;backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:9px;padding:7px 9px;min-width:110px;z-index:6;max-width:44%;}
.bar-leg h5{font-size:9px;color:var(--sub);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;}
.bar-item{display:flex;align-items:center;justify-content:space-between;margin-bottom:2px;gap:4px;}
.bar-dot{width:8px;height:3px;border-radius:2px;flex-shrink:0;}
.bar-lbl{color:var(--sub);flex:1;font-size:9px;}
.bar-val{font-weight:600;font-variant-numeric:tabular-nums;font-size:9px;}
.bar-sep{border:none;border-top:1px solid var(--border);margin:3px 0;}

/* EXIT METER */
.exit-meter{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);background:#0a0d12ee;backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:11px;padding:7px 13px;z-index:6;display:none;min-width:190px;max-width:75vw;text-align:center;}
.exit-meter.on{display:block;}
.em-title{font-size:8px;color:var(--sub);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px;}
.em-bar{height:6px;background:var(--border);border-radius:4px;overflow:hidden;margin-bottom:3px;}
.em-fill{height:100%;border-radius:4px;transition:width .08s,background .08s;}
.em-labels{display:flex;justify-content:space-between;font-size:8px;color:var(--sub);}
.em-score{font-size:16px;font-weight:800;margin-top:2px;}

/* DANGER FLASH */
.chart-wrap.danger::after{content:'BARRIER DANGER';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:var(--red);border:2px solid var(--red);border-radius:4px;animation:dangerFlash .25s infinite;z-index:5;pointer-events:none;}
@keyframes dangerFlash{0%,100%{opacity:1;}50%{opacity:.4;}}

/* RIGHT PANEL */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;padding:8px;}
.scard{background:#0a0d12;border:1px solid var(--border);border-radius:7px;padding:7px;}
.scard .sl{font-size:8px;color:var(--sub);margin-bottom:2px;text-transform:uppercase;letter-spacing:.8px;}
.scard .sv{font-size:14px;font-weight:700;font-variant-numeric:tabular-nums;}
.contract-box{margin:0 8px 7px;background:#0a0d12;border:1px solid var(--border);border-radius:9px;overflow:hidden;}
.con-hdr{background:#00e67610;border-bottom:1px solid #00e67628;padding:7px 10px;display:flex;align-items:center;justify-content:space-between;}
.con-hdr h4{font-size:11px;font-weight:700;color:var(--green);}
.con-body{padding:8px 10px;}
.con-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;font-size:11px;}
.con-row span:first-child{color:var(--sub);}
.pnl-bar{height:5px;background:var(--border);border-radius:3px;margin:4px 0;overflow:hidden;}
.pnl-fill{height:100%;border-radius:3px;transition:width .2s,background .2s;}
.sell-btn{background:linear-gradient(135deg,#b91c1c,#ff444f);color:#fff;border:none;border-radius:6px;padding:9px;font-size:12px;font-weight:700;cursor:pointer;width:100%;margin-top:5px;-webkit-tap-highlight-color:transparent;}
.sell-btn:active{transform:scale(.98);}
.no-con{text-align:center;color:var(--sub);padding:14px;font-size:11px;}
.no-con .ico{font-size:24px;margin-bottom:4px;}
.bal-flash{animation:balFlash .6s ease;}
@keyframes balFlash{0%{transform:scale(1.2);}50%{color:#fff;}100%{transform:scale(1);}}

/* AI HISTORY */
.ai-hist{padding:0 8px 7px;}
.hist-item{display:flex;align-items:center;gap:5px;padding:4px 7px;margin-bottom:3px;background:#0a0d12;border-radius:6px;border-left:3px solid transparent;font-size:10px;animation:fadeSlide .3s ease;}
.hist-item.w{border-left-color:var(--green);}
.hist-item.l{border-left-color:var(--red);}
.hist-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
@keyframes fadeSlide{from{opacity:0;transform:translateY(-4px);}to{opacity:1;transform:translateY(0);}}

/* TICK FEED */
.tick-wrap{padding:0 8px 8px;flex:1;}
.tick-box{background:#0a0d12;border:1px solid var(--border);border-radius:7px;overflow:hidden;}
.tick-hdr{display:grid;grid-template-columns:1fr 1fr 1fr;padding:5px 8px;font-size:9px;font-weight:700;color:var(--sub);letter-spacing:.8px;text-transform:uppercase;border-bottom:1px solid var(--border);}
.tick-row{display:grid;grid-template-columns:1fr 1fr 1fr;padding:4px 8px;font-size:10px;font-variant-numeric:tabular-nums;border-bottom:1px solid #ffffff03;animation:fadeSlide .2s ease;}

/* STATUS BAR */
.statusbar{height:24px;background:var(--card);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 10px;font-size:9px;color:var(--sub);flex-shrink:0;overflow:hidden;}
.sb-items{display:flex;gap:8px;overflow:hidden;}
.sb-items span{white-space:nowrap;flex-shrink:0;}
@media(max-width:480px){.sb-items span:nth-child(n+3){display:none;}}

/* TOAST */
#toast{position:fixed;bottom:60px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--card2);border:1px solid var(--border);border-radius:9px;padding:8px 16px;font-size:12px;font-weight:500;opacity:0;transition:all .25s;z-index:9999;pointer-events:none;white-space:nowrap;max-width:92vw;text-overflow:ellipsis;overflow:hidden;}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* FLASH BANNERS */
.flash{position:fixed;top:52px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#1a0835,#2d1a52);border:1px solid #a855f7;border-radius:10px;padding:8px 16px;font-size:12px;font-weight:700;color:var(--purple);opacity:0;transition:opacity .2s;z-index:9999;pointer-events:none;box-shadow:0 0 28px #a855f730;display:flex;align-items:center;gap:8px;max-width:92vw;}
.flash.show{opacity:1;}
.exit-flash{position:fixed;top:52px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#220505,#3d0a0a);border:2px solid #ff3d71;border-radius:10px;padding:9px 18px;font-size:13px;font-weight:800;color:#ff6b8a;opacity:0;transition:opacity .15s;z-index:10000;pointer-events:none;box-shadow:0 0 36px #ff3d7150;display:flex;align-items:center;gap:8px;max-width:92vw;}
.exit-flash.show{opacity:1;}
.win-flash{position:fixed;top:52px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#052210,#0a3d1a);border:2px solid #00e676;border-radius:10px;padding:9px 18px;font-size:13px;font-weight:800;color:#4dff9a;opacity:0;transition:opacity .15s;z-index:9998;pointer-events:none;box-shadow:0 0 36px #00e67650;display:flex;align-items:center;gap:8px;max-width:92vw;}
.win-flash.show{opacity:1;}
.pulse{display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulsing 1.5s infinite;}
@keyframes pulsing{0%{box-shadow:0 0 0 0 #00e67660;}70%{box-shadow:0 0 0 8px transparent;}100%{box-shadow:0 0 0 0 transparent;}}

/* VOICE PANEL */
.voice-panel{position:fixed;bottom:56px;right:10px;width:310px;max-width:calc(100vw - 16px);background:linear-gradient(160deg,#0d0820,#111620);border:2px solid #6d28d966;border-radius:16px;box-shadow:0 8px 40px #6d28d930;z-index:9990;display:none;flex-direction:column;max-height:70vh;}
.voice-panel.open{display:flex;}
@media(max-width:600px){
  .voice-panel{right:0;left:0;width:100%;border-radius:16px 16px 0 0;bottom:56px;}
}
.vp-hdr{background:linear-gradient(135deg,#1a0835,#200d40);padding:9px 13px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #6d28d933;flex-shrink:0;}
.vp-hdr-left{display:flex;align-items:center;gap:7px;}
.vp-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#6d28d9,#a855f7);display:flex;align-items:center;justify-content:center;font-size:16px;position:relative;flex-shrink:0;}
.vp-avatar-ring{position:absolute;inset:-3px;border-radius:50%;border:2px solid transparent;}
.vp-avatar-ring.listening{border-color:var(--green);box-shadow:0 0 10px var(--green);animation:ringPulse 1.5s infinite;}
.vp-avatar-ring.speaking{border-color:var(--purple);box-shadow:0 0 10px var(--purple);animation:ringPulse .5s infinite;}
@keyframes ringPulse{0%,100%{opacity:1;}50%{opacity:.3;}}
.vp-name{font-size:11px;font-weight:800;color:#fff;}
.vp-status{font-size:9px;color:var(--sub);margin-top:1px;}
.vp-close{background:none;border:none;color:var(--sub);cursor:pointer;font-size:18px;padding:0;-webkit-tap-highlight-color:transparent;}
.vp-chat{flex:1;overflow-y:auto;padding:7px 11px;display:flex;flex-direction:column;gap:5px;min-height:100px;}
.vp-msg{max-width:88%;padding:6px 10px;border-radius:10px;font-size:11px;line-height:1.5;animation:fadeSlide .2s ease;}
.vp-msg.ai{background:#1a0835;border:1px solid #6d28d933;color:#e0d0ff;border-radius:10px 10px 10px 0;}
.vp-msg.user{background:#0d3a6e;border:1px solid #00b0ff33;color:#cce8ff;margin-left:auto;border-radius:10px 10px 0 10px;}
.vp-msg-time{font-size:8px;color:var(--sub);margin-top:2px;}
.vp-wave{display:flex;align-items:center;gap:3px;padding:4px 11px;justify-content:center;min-height:22px;flex-shrink:0;}
.vp-bar{width:3px;border-radius:2px;background:var(--purple);animation:waveAnim .6s ease-in-out infinite;opacity:0;}
.vp-bar:nth-child(1){animation-delay:0s;height:7px;}
.vp-bar:nth-child(2){animation-delay:.1s;height:12px;}
.vp-bar:nth-child(3){animation-delay:.2s;height:18px;}
.vp-bar:nth-child(4){animation-delay:.3s;height:12px;}
.vp-bar:nth-child(5){animation-delay:.4s;height:7px;}
.vp-bar:nth-child(6){animation-delay:.2s;height:15px;}
.vp-bar:nth-child(7){animation-delay:.1s;height:10px;}
.vp-bar.active{opacity:1;}
@keyframes waveAnim{0%,100%{transform:scaleY(1);}50%{transform:scaleY(1.8);}}
.vp-input-row{display:flex;gap:6px;padding:8px 9px;border-top:1px solid #6d28d922;align-items:center;flex-shrink:0;}
.vp-text-input{flex:1;background:#0a0d12;border:1px solid #6d28d944;color:#fff;border-radius:8px;padding:7px 9px;font-size:11px;outline:none;}
.vp-text-input::placeholder{color:#4a3566;}
.vp-send{background:linear-gradient(135deg,#6d28d9,#a855f7);border:none;border-radius:7px;color:#fff;padding:7px 11px;cursor:pointer;font-size:12px;flex-shrink:0;-webkit-tap-highlight-color:transparent;}
.vp-mic-btn{width:32px;height:32px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .2s;flex-shrink:0;background:#1e2736;-webkit-tap-highlight-color:transparent;}
.vp-mic-btn.listening{background:var(--green);animation:micPulse .8s infinite;}
@keyframes micPulse{0%,100%{box-shadow:0 0 0 0 #00e67660;}50%{box-shadow:0 0 0 7px #00e67600;}}

/* VOICE FAB */
.voice-fab{position:fixed;bottom:66px;right:10px;width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#6d28d9,#a855f7);border:none;cursor:pointer;font-size:20px;box-shadow:0 4px 18px #a855f750;z-index:9991;display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent;}
.voice-fab:active{transform:scale(.93);}
.voice-fab.listening{animation:fabPulse 1s infinite;}
@keyframes fabPulse{0%,100%{box-shadow:0 4px 18px #a855f750;}50%{box-shadow:0 4px 28px #a855f7cc;}}
@media(max-width:600px){.voice-fab{bottom:72px;right:8px;width:44px;height:44px;font-size:18px;}}

/* SCAN MODAL */
.scan-overlay{position:fixed;inset:0;background:#000000aa;z-index:8000;display:none;align-items:center;justify-content:center;padding:14px;}
.scan-overlay.open{display:flex;}
.scan-modal{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;width:360px;max-width:100%;max-height:88vh;overflow-y:auto;}
.scan-modal h3{font-size:13px;font-weight:800;color:var(--purple);margin-bottom:4px;display:flex;align-items:center;gap:7px;}
.scan-modal p{font-size:10px;color:var(--sub);margin-bottom:10px;}
.scan-progress{height:5px;background:var(--border);border-radius:3px;overflow:hidden;margin-bottom:10px;}
.scan-progress-fill{height:100%;background:linear-gradient(90deg,#6d28d9,#a855f7);width:0%;transition:width .2s;border-radius:3px;}
.scan-results{display:flex;flex-direction:column;gap:6px;}
.scan-result-item{background:#0a0d12;border:1px solid var(--border);border-radius:9px;padding:8px 10px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:all .2s;}
.scan-result-item:active{border-color:var(--blue);}
.scan-result-item.winner{border-color:var(--green);background:#00e67608;}
.sri-bar-row{display:flex;align-items:center;gap:4px;margin-bottom:2px;}
.sri-bar-lbl{font-size:8px;color:var(--sub);width:50px;}
.sri-bar-bg{flex:1;height:4px;background:#1e2736;border-radius:2px;overflow:hidden;}
.sri-bar-fill{height:100%;border-radius:2px;}
.sri-score{font-size:15px;font-weight:800;width:34px;text-align:right;}
.scan-close{width:100%;margin-top:10px;padding:8px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--sub);cursor:pointer;font-size:12px;}

/* CONN BANNER */
.conn-banner{position:fixed;top:48px;left:0;right:0;background:#b91c1c;color:#fff;text-align:center;font-size:11px;font-weight:700;padding:5px;z-index:8999;display:none;}
.conn-banner.show{display:block;animation:connPulse 1s infinite;}
@keyframes connPulse{0%,100%{opacity:1;}50%{opacity:.7;}}

/* MOBILE COMPREHENSIVE */
@media(max-width:600px){
  .statusbar{display:none;}
  .chart-top{height:40px;padding:0 7px;gap:5px;}
  .chart-top .price-main{font-size:16px;}
  .chart-meta{display:none;}
  .login-card{padding:20px 14px;}
  .login-features{grid-template-columns:1fr;gap:6px;}
  .login-title{font-size:17px;}
  .left{width:88vw!important;max-width:320px;}
  .ai-body{max-height:55vh;padding:6px;}
  .ind-grid{grid-template-columns:1fr 1fr;gap:3px;}
  .ind-card{padding:4px 6px;}
  .ind-card .val{font-size:10px;}
  .pattern-box{padding:6px;}
  /* Chart overlays: tighter on mobile */
  .ai-ov{max-width:48%;padding:6px 8px;}
  .bar-leg{max-width:40%;padding:5px 7px;}
  .bar-val{font-size:8px;}
  /* Exit meter: wider, closer to bottom nav */
  .exit-meter{min-width:160px;max-width:88vw;padding:5px 10px;bottom:66px;}
  .em-score{font-size:13px;}
  /* Right panel: full width slide-in */
  .right{width:92vw!important;max-width:360px;}
  /* Stats grid: 2 columns, comfortable */
  .stat-grid{grid-template-columns:1fr 1fr;gap:4px;padding:6px;}
  .scard{padding:8px 6px;}
  .scard .sl{font-size:9px;}
  .scard .sv{font-size:15px;}
  /* Contract box: bigger touch targets */
  .con-row{font-size:12px;margin-bottom:5px;}
  .sell-btn{padding:12px;font-size:13px;margin-top:8px;}
  /* Bottom nav */
  .bottom-nav{height:58px;}
  .bnav-btn .bnav-ico{font-size:20px;}
  .bnav-btn{font-size:8px;}
  /* Mobile topbar */
  .mob-topbar{height:44px;gap:5px;}
  .mob-btn{padding:6px 10px;font-size:10px;}
  .mob-price{font-size:13px;}
  /* Left panel sections */
  .sec{padding:7px 9px;}
  .gr-grid{gap:3px;}
  .gr-btn{padding:7px 0;font-size:11px;}
  .buy-btn{padding:14px;font-size:14px;}
  /* Header */
  header{padding:0 6px;gap:3px;}
  .hdr-badge{padding:3px 5px;}
  .hdr-badge .val{font-size:10px;}
  /* Scan modal */
  .scan-modal{padding:12px;}
  /* Voice panel */
  .voice-panel{max-height:65vh;}
  .vp-chat{min-height:80px;max-height:32vh;}
  /* AI hist items: bigger touch area */
  .hist-item{padding:6px 8px;margin-bottom:4px;}
  /* Tick feed: slightly bigger */
  .tick-row{padding:5px 8px;font-size:11px;}
  /* Stake input: bigger */
  .stake-row input{font-size:14px;padding:8px 9px;}
  .sadj{width:36px;height:36px;font-size:20px;}
  /* User card balance: prominent */
  .user-bal{font-size:20px;}
}
@media(max-width:380px){
  .login-title{font-size:15px;}
  .btn-login{font-size:12px;padding:13px;}
  .ai-ov{display:none;}
  .mob-price{font-size:12px;}
  .chart-top .price-main{font-size:14px;}
  .mob-topbar{height:42px;}
  .mob-btn{padding:5px 8px;font-size:9px;}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-card">
    <div class="login-logo">ðŸŽ¯</div>
    <div class="login-title">Deriv Accumulator AI Sniper</div>
    <div class="login-sub">Connect your Deriv account (Real or Demo). AI Sniper analyzes every tick and executes real trades on your Deriv account.</div>
    <div class="login-sub-msg" style="color:var(--gold);font-size:10px;margin-bottom:8px;">âš¡ All trades execute on your actual Deriv account</div>
    <div class="login-features">
      <div class="login-feat"><div class="login-feat-icon">ðŸ¤–</div><div class="login-feat-text"><div class="t">AI Sniper Engine</div><div class="s">100-tick pattern analysis</div></div></div>
      <div class="login-feat"><div class="login-feat-icon">ðŸŽ¤</div><div class="login-feat-text"><div class="t">Voice AI â€” ARIA</div><div class="s">English & Kiswahili</div></div></div>
      <div class="login-feat"><div class="login-feat-icon">ðŸ”­</div><div class="login-feat-text"><div class="t">Volatility Scanner</div><div class="s">Auto-selects best market</div></div></div>
      <div class="login-feat"><div class="login-feat-icon">ðŸ’°</div><div class="login-feat-text"><div class="t">Zero Loss Target</div><div class="s">Sniper exit before break</div></div></div>
    </div>
    <a class="btn-login" id="loginBtn" href="https://oauth.deriv.com/oauth2/authorize?app_id=129093&l=EN&brand=deriv" target="_top">
      <svg viewBox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="48" fill="#CC2936"/><path d="M28 72 L50 28 L72 72 Z" fill="white"/></svg>
      Login with Deriv Real Account
    </a>
    <div class="login-divider"><span>OR</span></div>
    <a class="btn-login" id="demoBtn" href="https://oauth.deriv.com/oauth2/authorize?app_id=129093&l=EN&brand=deriv" target="_top" style="background:linear-gradient(135deg,#1e3a5f,#1a2a4a);font-size:13px;text-decoration:none;">
      ðŸŽ® Login with Deriv Demo Account
    </a>
    <div class="login-note">
      Both Real and Demo accounts are supported. By connecting you agree to Deriv's <a href="https://deriv.com/terms-and-conditions" target="_blank">Terms</a>. App ID 129093
    </div>
  </div>
</div>

<div class="conn-banner" id="connBanner">âš¡ Reconnectingâ€¦</div>

<!-- HEADER -->
<header>
  <div class="logo">
    <button id="menuBtn" style="display:none;background:transparent;border:none;font-size:22px;color:var(--text);cursor:pointer;padding:2px 6px;-webkit-tap-highlight-color:transparent;margin-right:2px;">â˜°</button>
    <svg class="logo-icon" viewBox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="48" fill="#CC2936"/><path d="M28 72 L50 28 L72 72 Z" fill="white"/></svg>
    <span class="logo-text">Deriv</span>
    <span class="logo-tag">ACCU</span>
    <span class="ai-tag">ðŸŽ¯ AI</span>
  </div>
  <div class="hdr-right">
    <div class="hdr-badge" style="border-color:#ffd60044;">
      ðŸ’° <span class="val" id="hBalance" style="color:var(--gold);">â€”</span>
    </div>
    <div class="hdr-badge hdr-badge-hide" style="border-color:#00e67644;">
      âœ… <span class="val" id="hWins" style="color:var(--green);">0W</span>
    </div>
    <div class="hdr-badge hdr-badge-hide" id="hPnlBadge" style="display:none;">
      ðŸ“ˆ <span class="val" id="hPnl" style="color:var(--green);">$0</span>
    </div>
    <div class="ws-pill"><div class="ws-dot" id="wsDot"></div></div>
    <button id="rightBtn" class="mob-btn" style="display:none;padding:4px 8px;font-size:13px;">ðŸ“Š</button>
  </div>
</header>

<!-- MOBILE TOP BAR -->
<div class="mob-topbar" id="mobTopbar">
  <button class="mob-btn" id="mobLeftBtn">â˜° Controls</button>
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;min-width:0;">
    <div class="mob-price" id="mobPrice">â€”</div>
    <div id="mobPnlRow" style="display:none;font-size:9px;font-weight:700;color:var(--green);">â€”</div>
  </div>
  <div class="mob-bal-pill" id="mobBalPill" style="display:none;background:#0a0d12;border:1px solid #ffd60044;border-radius:6px;padding:3px 7px;font-size:10px;font-weight:700;color:var(--gold);white-space:nowrap;flex-shrink:0;">ðŸ’° <span id="mobBalance">â€”</span></div>
  <button class="mob-btn" id="mobRightBtn">ðŸ“Š Stats</button>
</div>

<div class="layout">
  <div class="panel-overlay" id="panelOverlay"></div>

  <!-- LEFT PANEL -->
  <div class="left" id="leftPanel">
    <!-- AI TOGGLE fixed at top -->
    <div class="ai-wrap">
      <div class="ai-toggle-row">
        <div class="ai-lbl"><span style="font-size:16px;">ðŸ¤–</span> AI Sniper Engine</div>
        <label class="toggle"><input type="checkbox" id="aiToggle"><div class="tslider"></div></label>
      </div>
      <div class="ai-body" id="aiBody">
        <div class="ai-head-row">
          <div class="brain">ðŸ§ </div>
          <div class="brain-info">
            <div class="t">Neural Sniper v11 â€” Pure Analysis</div>
            <div class="s">100-tick pattern Â· barrier prediction</div>
          </div>
        </div>
        <div class="pattern-box">
          <div class="lbl">ðŸ“Š Pattern Analysis</div>
          <div class="pattern-row"><span>Avg break tick</span><span id="pAvgBreak" style="color:var(--gold);">â€”</span></div>
          <div class="pattern-row"><span>Min break tick</span><span id="pMinBreak" style="color:var(--red);">â€”</span></div>
          <div class="pattern-row"><span>Safe exit tick</span><span id="pSafeExit" style="color:var(--purple);">â€”</span></div>
          <div class="pattern-row"><span>Vol score</span><span id="pVolScore" style="color:var(--blue);">â€”</span></div>
        </div>
        <div class="ind-grid">
          <div class="ind-card"><div class="lbl">Trend</div><div class="val" id="iTrend" style="color:var(--sub);">â€”</div></div>
          <div class="ind-card"><div class="lbl">Momentum</div><div class="val" id="iMom" style="color:var(--sub);">â€”</div></div>
          <div class="ind-card"><div class="lbl">RSI-14</div><div class="val" id="iRsi" style="color:var(--sub);">â€”</div></div>
          <div class="ind-card"><div class="lbl">Volatility</div><div class="val" id="iVol" style="color:var(--sub);">â€”</div></div>
          <div class="ind-card"><div class="lbl">Break Risk</div><div class="val" id="iExit" style="color:var(--sub);">â€”</div></div>
          <div class="ind-card"><div class="lbl">Hold Score</div><div class="val" id="iHold" style="color:var(--sub);">â€”</div></div>
        </div>
        <div class="sig-box SCAN" id="sigBox">
          <div class="sig-txt SCAN" id="sigTxt">SCANNINGâ€¦</div>
          <div class="sig-sub" id="sigSub">Collecting tick dataâ€¦</div>
        </div>
        <div class="vol-scanner">
          <div class="vol-scan-hdr">
            <div class="vol-scan-lbl">ðŸ”­ Volatility Scanner</div>
            <button class="vol-scan-btn" id="scanVolBtn">âš¡ SCAN</button>
          </div>
          <div class="vol-list" id="volScanList"><div style="text-align:center;color:var(--sub);font-size:10px;padding:6px;">Click SCAN to analyzeâ€¦</div></div>
        </div>
        <div class="scan-bar"><div class="scan-fill" id="scanFill"></div></div>
        <div class="ai-stats">
          <div class="aistat" style="text-align:center;"><div class="n" id="stWins" style="color:var(--green);">0</div><div class="l">Wins</div></div>
          <div class="aistat" style="text-align:center;"><div class="n" id="stLoss" style="color:var(--red);">0</div><div class="l">Loss</div></div>
          <div class="aistat" style="text-align:center;"><div class="n" id="stWR" style="color:var(--gold);">â€”</div><div class="l">Win%</div></div>
          <div class="aistat" style="text-align:center;"><div class="n" id="stPnl" style="color:var(--green);">$0</div><div class="l">P&L</div></div>
        </div>
      </div>
    </div>

    <!-- scrollable below AI toggle -->
    <div class="left-scroll">
      <div id="userSection" style="display:none;">
        <div class="user-card">
          <div class="user-row">
            <div class="user-avatar">ðŸ‘¤</div>
            <div class="user-info">
              <div class="name" id="userName">â€”</div>
              <div class="uid" id="userUid">â€”</div>
            </div>
          </div>
          <div class="user-bal-lbl" style="margin-top:6px;">Balance</div>
          <div class="user-bal" id="userBal">â€”</div>
          <div class="acct-switcher" id="acctSwitcher" style="display:none;">
            <div class="acct-switcher-lbl">ðŸ”„ Switch Account</div>
            <div class="acct-drop-wrap" style="position:relative;">
              <button class="acct-drop-btn" id="acctDropBtn" type="button" onclick="toggleAcctMenu()">
                <div class="acct-cur">
                  <span class="acct-cur-tag" id="acctCurTag" style="background:#003d1a;color:var(--green);">REAL</span>
                  <span class="acct-cur-name" id="acctCurName">â€”</span>
                </div>
                <div style="display:flex;align-items:center;gap:5px;">
                  <span class="acct-cur-bal" id="acctCurBal">â€”</span>
                  <span class="acct-arrow" id="acctArrow">â–¼</span>
                </div>
              </button>
              <div class="acct-menu" id="acctMenu"></div>
            </div>
          </div>
          <button class="btn-logout" id="logoutBtn">âœ• Logout</button>
        </div>
      </div>

      <!-- SYMBOL -->
      <div class="sec">
        <div class="sec-title">Volatility Index</div>
        <div class="sym-list" id="symList">
          <button class="sym-btn active" data-sym="R_10" data-dp="3">Volatility 10 <span class="sym-badge">V10</span></button>
          <button class="sym-btn" data-sym="R_25" data-dp="3">Volatility 25 <span class="sym-badge">V25</span></button>
          <button class="sym-btn" data-sym="R_50" data-dp="4">Volatility 50 <span class="sym-badge">V50</span></button>
          <button class="sym-btn" data-sym="R_75" data-dp="4">Volatility 75 <span class="sym-badge">V75</span></button>
          <button class="sym-btn" data-sym="R_100" data-dp="2">Volatility 100 <span class="sym-badge">V100</span></button>
          <div style="font-size:9px;color:var(--gold);font-weight:700;padding:4px 0 2px;letter-spacing:.8px;">âš¡ 1-SECOND TICKS</div>
          <button class="sym-btn" data-sym="1HZ10V" data-dp="3">Volatility 10 (1s) <span class="sym-badge">V10Â·1s</span></button>
          <button class="sym-btn" data-sym="1HZ25V" data-dp="3">Volatility 25 (1s) <span class="sym-badge">V25Â·1s</span></button>
          <button class="sym-btn" data-sym="1HZ50V" data-dp="4">Volatility 50 (1s) <span class="sym-badge">V50Â·1s</span></button>
          <button class="sym-btn" data-sym="1HZ75V" data-dp="4">Volatility 75 (1s) <span class="sym-badge">V75Â·1s</span></button>
          <button class="sym-btn" data-sym="1HZ100V" data-dp="2">Volatility 100 (1s) <span class="sym-badge">V100Â·1s</span></button>
        </div>
      </div>

      <!-- GROWTH RATE -->
      <div class="sec">
        <div class="sec-title">Growth Rate</div>
        <div class="gr-grid" id="grGrid">
          <button class="gr-btn" data-r="1">1%</button>
          <button class="gr-btn active" data-r="2">2%</button>
          <button class="gr-btn" data-r="3">3%</button>
          <button class="gr-btn" data-r="4">4%</button>
          <button class="gr-btn" data-r="5">5%</button>
        </div>
      </div>

      <!-- STAKE -->
      <div class="sec">
        <div class="sec-title">Stake Amount</div>
        <div class="stake-row">
          <button class="sadj" id="stkDn">âˆ’</button>
          <input type="number" id="stkInput" value="10" min="1" max="50000" step="1"/>
          <button class="sadj" id="stkUp">+</button>
        </div>
        <input type="range" id="stkRange" min="1" max="1000" value="10"/>
      </div>

      <!-- TAKE PROFIT -->
      <div class="sec">
        <div class="tp-hdr">
          <div class="sec-title" style="margin:0;">Take Profit</div>
          <label class="sw2"><input type="checkbox" id="tpToggle"><div class="sl2"></div></label>
        </div>
        <input type="number" id="tpInput" value="50" min="1" disabled style="opacity:.4;"/>
      </div>

      <!-- CONTRACT INFO -->
      <div class="sec">
        <div class="sec-title">Contract Info</div>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <div style="display:flex;justify-content:space-between;font-size:11px;"><span style="color:var(--sub);">Barrier dist.</span><span id="infoBarrier">â€”</span></div>
          <div style="display:flex;justify-content:space-between;font-size:11px;"><span style="color:var(--sub);">Buffer</span><span id="infoBuf" style="color:var(--blue);">0/100</span></div>
          <div style="display:flex;justify-content:space-between;font-size:11px;"><span style="color:var(--sub);">Hold Score</span><span id="infoHold" style="color:var(--green);">â€”</span></div>
          <div style="display:flex;justify-content:space-between;font-size:11px;"><span style="color:var(--sub);">Pattern Exit</span><span id="infoPatExit" style="color:var(--purple);">â€”</span></div>
        </div>
      </div>

      <!-- BUY -->
      <div class="sec" style="border-bottom:none;">
        <button class="buy-btn" id="buyBtn">â–² Buy Accumulator</button>
      </div>
    </div>
  </div>

  <!-- CENTER -->
  <div class="center">
    <div class="chart-top">
      <div style="display:flex;align-items:center;gap:6px;min-width:0;">
        <span class="price-main" id="priceEl">â€”</span>
        <span class="price-chg" id="priceChg">â€”</span>
      </div>
      <div class="chart-meta">
        <span id="metaH">H:â€”</span><span>|</span>
        <span id="metaL">L:â€”</span><span>|</span>
        <span id="metaLat" style="color:var(--green);">â€”ms</span>
      </div>
    </div>
    <div class="chart-wrap" id="chartWrap">
      <div id="chart"></div>
      <div class="ai-ov" id="aiOv">
        <h5><div class="live-dot"></div> SNIPER AI</h5>
        <div class="ov-row"><span>Trend</span><span id="ovTrend">â€”</span></div>
        <div class="ov-row"><span>RSI</span><span id="ovRsi">â€”</span></div>
        <div class="ov-row"><span>Break Risk</span><span id="ovExitRisk">â€”</span></div>
        <div class="ov-row"><span>Hold</span><span id="ovHold">â€”</span></div>
        <div class="ov-row"><span>Signal</span><span id="ovSig" style="font-weight:800;">â€”</span></div>
        <hr class="ov-hr"/>
        <div class="sniper-st st-hunt" id="sniperSt">ðŸŽ¯ HUNTING</div>
      </div>
      <div class="bar-leg">
        <h5>Barriers</h5>
        <div class="bar-item"><div class="bar-dot" style="background:var(--green);"></div><span class="bar-lbl">Upper</span><span class="bar-val" id="bUpper">â€”</span></div>
        <div class="bar-item"><div class="bar-dot" style="background:var(--red);"></div><span class="bar-lbl">Lower</span><span class="bar-val" id="bLower">â€”</span></div>
        <div class="bar-item"><div class="bar-dot" style="background:var(--blue);opacity:.6;"></div><span class="bar-lbl">Entry</span><span class="bar-val" id="bEntry">â€”</span></div>
        <hr class="bar-sep"/>
        <div class="bar-item"><span style="font-size:9px;color:var(--sub);">Safety</span><span class="bar-val" id="bSafety" style="font-size:10px;">â€”</span></div>
      </div>
      <div class="exit-meter" id="exitMeter">
        <div class="em-title">âš¡ BREAK PREDICTOR</div>
        <div class="em-bar"><div class="em-fill" id="emFill" style="width:0%;background:var(--green);"></div></div>
        <div class="em-labels"><span>SAFE</span><span id="emPct" style="font-weight:700;font-size:10px;">0%</span><span>BREAK!</span></div>
        <div class="em-score" id="emScore" style="color:var(--green);">HOLD</div>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right" id="rightPanel">
    <div class="stat-grid">
      <div class="scard"><div class="sl">Ticks</div><div class="sv" id="sTicks" style="color:var(--blue);">0</div></div>
      <div class="scard"><div class="sl">Growth</div><div class="sv" id="sGrowth" style="color:var(--green);">2%</div></div>
      <div class="scard"><div class="sl">P&L</div><div class="sv" id="sPnl">$0.00</div></div>
      <div class="scard"><div class="sl">Payout</div><div class="sv" id="sPayout" style="color:var(--gold);">$0.00</div></div>
    </div>
    <div style="padding:0 8px 5px;"><div class="sec-title">Active Contract</div></div>
    <div id="conPanel"></div>
    <div style="padding:0 8px 5px;display:flex;align-items:center;gap:5px;">
      <span class="pulse" id="feedPulse" style="opacity:0;"></span>
      <div class="sec-title" style="margin:0;">AI Trade Log</div>
    </div>
    <div class="ai-hist" id="aiHist"><div style="text-align:center;color:var(--sub);font-size:11px;padding:8px;">No trades yetâ€¦</div></div>
    <div class="tick-wrap">
      <div class="sec-title" style="margin-bottom:5px;">Live Ticks</div>
      <div class="tick-box">
        <div class="tick-hdr"><span>Price</span><span>Change</span><span>Time</span></div>
        <div id="tickFeed" style="max-height:130px;overflow-y:auto;"></div>
      </div>
    </div>
  </div>
</div>

<!-- STATUS BAR -->
<div class="statusbar">
  <div class="sb-items">
    <span id="sbSym">R_10</span>
    <span id="sbPing">Ping:â€”</span>
    <span id="sbAuth" style="color:var(--sub);">Demo</span>
    <span id="sbAI" style="color:var(--sub);">AI:OFF</span>
  </div>
  <span id="sbTime">â€”</span>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav" id="bottomNav">
  <button class="bnav-btn" id="bnLeft"><span class="bnav-ico">â˜°</span><span>Controls</span></button>
  <button class="bnav-btn active" id="bnChart"><span class="bnav-ico">ðŸ“ˆ</span><span>Chart</span></button>
  <button class="bnav-btn" id="bnRight" style="position:relative;"><span class="bnav-ico">ðŸ“Š</span><span>Stats</span><span id="bnTradeDot" style="display:none;position:absolute;top:6px;right:18px;width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);animation:blink 1s infinite;"></span></button>
  <button class="bnav-btn" id="bnVoice"><span class="bnav-ico">ðŸŽ¤</span><span>ARIA</span></button>
</div>

<!-- VOICE PANEL -->
<div class="voice-panel" id="voicePanel">
  <div class="vp-hdr">
    <div class="vp-hdr-left">
      <div class="vp-avatar">ðŸ¤–<div class="vp-avatar-ring" id="avatarRing"></div></div>
      <div><div class="vp-name">ARIA Voice Assistant</div><div class="vp-status" id="vpStatus">Silent â€” tap mic to activate</div></div>
    </div>
    <button class="vp-close" id="vpClose">âœ•</button>
  </div>
  <div class="vp-chat" id="vpChat">
    <div class="vp-msg ai"><div>Habari! I am ARIA. I understand English and Kiswahili. Tap the mic or type below.</div><div class="vp-msg-time">Ready</div></div>
  </div>
  <div class="vp-wave">
    <div class="vp-bar" id="vb1"></div><div class="vp-bar" id="vb2"></div><div class="vp-bar" id="vb3"></div>
    <div class="vp-bar" id="vb4"></div><div class="vp-bar" id="vb5"></div><div class="vp-bar" id="vb6"></div>
    <div class="vp-bar" id="vb7"></div>
  </div>
  <div class="vp-input-row">
    <button class="vp-mic-btn" id="micBtn" title="Toggle microphone">ðŸŽ¤</button>
    <input class="vp-text-input" id="vpTextInput" placeholder="Type in English or Kiswahiliâ€¦" autocomplete="off"/>
    <button class="vp-send" id="vpSend">Send</button>
  </div>
</div>
<button class="voice-fab" id="voiceFab" title="Open ARIA">ðŸŽ¤</button>
<!-- MOBILE QUICK SELL BUTTON -->
<button id="mobSellBtn" onclick="if(con)closeContract('Manual',false)" style="display:none;position:fixed;bottom:70px;left:10px;background:linear-gradient(135deg,#b91c1c,#ff444f);color:#fff;border:none;border-radius:50px;padding:10px 18px;font-size:12px;font-weight:800;cursor:pointer;z-index:9989;box-shadow:0 4px 20px #ff3d7160;-webkit-tap-highlight-color:transparent;animation:exitPulse .8s infinite;">ðŸŸ¥ SELL NOW</button>

<!-- SCAN MODAL -->
<div class="scan-overlay" id="scanOverlay">
  <div class="scan-modal">
    <h3>ðŸ”­ Deep Market Scanner</h3>
    <p>Analyzing 100-tick patterns, barrier longevity & break statistics for all volatility indices</p>
    <div class="scan-progress"><div class="scan-progress-fill" id="scanProgressFill"></div></div>
    <div class="scan-results" id="scanResults"></div>
    <button class="scan-close" id="scanClose">âœ• Close</button>
  </div>
</div>

<div id="toast"></div>
<div class="flash" id="flashBuy"><span>ðŸŽ¯</span><span id="flashBuyTxt">AI ENTERINGâ€¦</span></div>
<div class="exit-flash" id="flashExit"><span>ðŸš¨</span><span id="flashExitTxt">SNIPER EXIT!</span></div>
<div class="win-flash" id="flashWin"><span>âœ…</span><span id="flashWinTxt">WIN!</span></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APP_ID='129093';
const WS_URL='wss://ws.binaryws.com/websockets/v3?app_id='+APP_ID;
const OAUTH_URL='https://oauth.deriv.com/oauth2/authorize?app_id='+APP_ID+'&l=EN&brand=deriv';
const TICK_BUF=100,MAX_FEED=40;
const ALL_SYMS=[
  {sym:'R_10',dp:3,name:'V10'},{sym:'R_25',dp:3,name:'V25'},
  {sym:'R_50',dp:4,name:'V50'},{sym:'R_75',dp:4,name:'V75'},
  {sym:'R_100',dp:2,name:'V100'},
  {sym:'1HZ10V',dp:3,name:'V10(1s)'},{sym:'1HZ25V',dp:3,name:'V25(1s)'},
  {sym:'1HZ50V',dp:4,name:'V50(1s)'},{sym:'1HZ75V',dp:4,name:'V75(1s)'},
  {sym:'1HZ100V',dp:2,name:'V100(1s)'}
];
const CRYPTO_CURRENCIES=['BTC','ETH','USDT','tUSDT','eUSDT','LTC','XRP'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $=id=>document.getElementById(id);
let ws=null,wsAlive=false,pingTimer=null,pingT=0,lat=0;
let reconnDelay=800,reconnTimer=null,connTO=null,appReady=false;
let heartbeatTimer=null,lastMsgTime=0;
let sym='R_10',dp=3,gr=2,stake=10,tp=null;
let activeToken='',authed=false,userInfo={},userCurrency='USD';
let isBuying=false,pendingProposal=null,proposalReqId=null;
let tokenStore={},accountList=[],activeLoginid='';
let priceHist=[],tickBuf=[],prevP=null;
let hi=-Infinity,lo=Infinity,symBufs={};
let chart=null,area=null,lineU=null,lineL=null,lineE=null;
let con=null,exitingNow=false,realBalance=null;
let aiOn=false,aiWins=0,aiLoss=0,aiTrades=0,aiPnl=0;
let aiCool=false,phase='IDLE',scanAnim=0,exitProbability=0;
let ticksHeld=0;
// Break history per symbol
let breakHistory={},volScores={},lastVolSwitch=0;
// VOICE
let voiceOpen=false,voiceRunning=false,isSpeaking=false;
let recognition=null,ariaVoice=null,voiceRestartTimer=null;
const synth=window.speechSynthesis;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAFE STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function lsGet(k){try{return localStorage.getItem(k);}catch(e){return null;}}
function lsSet(k,v){try{localStorage.setItem(k,v);}catch(e){}}
function lsDel(k){try{localStorage.removeItem(k);}catch(e){}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const now=()=>Date.now();
function toast(msg,col,dur){
  const t=$('toast');t.textContent=msg;
  t.style.borderColor=col==='g'?'var(--green)':col==='r'?'var(--red)':col==='p'?'var(--purple)':col==='y'?'var(--gold)':'var(--border)';
  t.classList.add('show');clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.classList.remove('show'),dur||3800);
}
function showFlash(id,msg,dur){
  const el=$(id);
  el.querySelector('span:last-child').textContent=msg;
  el.classList.add('show');clearTimeout(el._t);
  el._t=setTimeout(()=>el.classList.remove('show'),dur||2200);
}
function flashBalance(){
  [$('hBalance'),$('userBal'),$('mobBalance')].forEach(el=>{
    if(!el)return;
    el.classList.remove('bal-flash');
    void el.offsetWidth;
    el.classList.add('bal-flash');
    setTimeout(()=>el.classList.remove('bal-flash'),700);
  });
}
function setDot(s){$('wsDot').className='ws-dot '+(s==='on'?'on':s==='err'?'err':'rc');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OAUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseOAuthURL(){
  const p = new URLSearchParams(window.location.search);
  const found = {};
  let firstToken = null, firstLoginid = '';
  for (let i = 1; p.has('acct' + i); i++) {
    const loginid = p.get('acct' + i);
    const token = p.get('token' + i);
    const currency = p.get('cur' + i);
    if (token && loginid && token.length > 10) {
      found[loginid] = { token: token, currency: currency || 'USD' };
      if (!firstToken) {
        firstToken = token;
        firstLoginid = loginid;
      }
    }
  }
  return { tokens: found, first: firstToken, firstLoginid: firstLoginid };
}
function loadTokenStore(){try{const s=lsGet('deriv_ts');if(s)tokenStore=JSON.parse(s);}catch(e){tokenStore={};}}
function saveTokenStore(){lsSet('deriv_ts',JSON.stringify(tokenStore));}
function getStoredToken(loginid){
  if(!loginid)return'';
  const s=tokenStore[loginid];
  if(!s)return'';
  if(typeof s==='string'&&s.length>10)return s;
  if(typeof s==='object'&&s.token&&s.token.length>10)return s.token;
  return'';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init(){
  loadTokenStore();
  const{tokens,first,firstLoginid}=parseOAuthURL();
  if(first&&firstLoginid){
    Object.keys(tokens).forEach(lid=>{tokenStore[lid]=tokens[lid];});
    saveTokenStore();
    activeToken=first;activeLoginid=firstLoginid;
    lsSet('deriv_active',firstLoginid);
    try{const clean=location.protocol+'//'+location.host+location.pathname;window.history.replaceState({},'',clean);}catch(e){}
    hideLogin();return;
  }
  const storedActive=lsGet('deriv_active')||'';
  if(storedActive&&storedActive.length>2){
    const tok=getStoredToken(storedActive);
    if(tok&&tok.length>10){activeToken=tok;activeLoginid=storedActive;hideLogin();return;}
  }
  const keys=Object.keys(tokenStore).filter(k=>k&&k.length>2);
  for(let i=0;i<keys.length;i++){
    const tok=getStoredToken(keys[i]);
    if(tok&&tok.length>10){activeToken=tok;activeLoginid=keys[i];lsSet('deriv_active',keys[i]);hideLogin();return;}
  }
  showLogin();
})();

function showLogin(){$('loginOverlay').style.display='flex';}
function hideLogin(){$('loginOverlay').style.display='none';bootApp();}

// demoBtn is now an OAuth link â€” no click handler needed (handled by href redirect)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function bootApp(){
  if(appReady)return;
  appReady=true;
  initChart();initVoice();renderNoContract();
  $('sGrowth').textContent=gr+'%';
  updatePhaseUI();setupMobile();setupEvents();connect();
  setInterval(()=>{if(con)updateConUI();},800);
  setInterval(()=>$('sbTime').textContent=new Date().toLocaleTimeString(),1000);
  window.addEventListener('online',()=>{toast('ðŸŒ Back online','g');reconnDelay=800;connect();});
  window.addEventListener('offline',()=>{toast('ðŸ“µ Offline','r');setDot('err');});
  document.addEventListener('visibilitychange',()=>{if(!document.hidden&&(!wsAlive||!ws||ws.readyState!==1)){reconnDelay=800;connect();}});
  document.addEventListener('touchstart',()=>{if(!wsAlive&&appReady){reconnDelay=800;connect();}},{passive:true});
  // Auto vol scan every 12s when AI on and no active trade
  setInterval(()=>{if(aiOn&&!con&&now()-lastVolSwitch>12000)doVolScanAndSwitch(true);},12000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBSOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function connect(){
  clearTimeout(reconnTimer);clearTimeout(connTO);
  clearInterval(pingTimer);clearInterval(heartbeatTimer);
  if(ws){try{ws.onopen=ws.onmessage=ws.onerror=ws.onclose=null;ws.close();}catch(e){}ws=null;}
  wsAlive=false;setDot('rc');$('connBanner').classList.add('show');
  try{ws=new WebSocket(WS_URL);}catch(e){schedReconn();return;}
  connTO=setTimeout(()=>{if(!wsAlive){try{ws&&ws.close();}catch(e){}schedReconn();}},12000);
  lastMsgTime=now();
  ws.onopen=()=>{
    clearTimeout(connTO);wsAlive=true;reconnDelay=800;lastMsgTime=now();
    setDot('on');$('connBanner').classList.remove('show');
    // Subscribe all symbols first
    ALL_SYMS.forEach(s=>ws.send(JSON.stringify({ticks:s.sym,subscribe:1})));
    // Authorize after short delay
    if(activeToken)setTimeout(()=>{if(ws&&ws.readyState===1)ws.send(JSON.stringify({authorize:activeToken}));},300);
    pingTimer=setInterval(()=>{if(ws&&ws.readyState===1){pingT=now();ws.send(JSON.stringify({ping:1}));}else clearInterval(pingTimer);},5000);
    heartbeatTimer=setInterval(()=>{
      if(now()-lastMsgTime>25000){
        if(ws&&ws.readyState===1)ws.send(JSON.stringify({ping:1}));
        else{wsAlive=false;setDot('rc');schedReconn();}
      }
    },8000);
  };
  ws.onmessage=e=>{lastMsgTime=now();try{handle(JSON.parse(e.data));}catch(err){}};
  ws.onerror=()=>{clearTimeout(connTO);wsAlive=false;setDot('err');};
  ws.onclose=()=>{clearTimeout(connTO);clearInterval(pingTimer);clearInterval(heartbeatTimer);wsAlive=false;setDot('rc');$('connBanner').classList.add('show');schedReconn();};
}
function schedReconn(){clearTimeout(reconnTimer);reconnTimer=setTimeout(()=>{reconnDelay=Math.min(reconnDelay*1.5,15000);connect();},reconnDelay);}
function send(obj){if(ws&&ws.readyState===1){ws.send(JSON.stringify(obj));return true;}return false;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGE HANDLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handle(d){
  if(!d||!d.msg_type)return;
  const t=d.msg_type;
  if(t==='pong'){lat=now()-pingT;$('metaLat').textContent=lat+'ms';$('metaLat').style.color=lat<120?'var(--green)':lat<350?'var(--gold)':'var(--red)';$('sbPing').textContent='Ping:'+lat+'ms';return;}
  if(t==='authorize'){
    if(d.error){
      const ec=d.error.code||'',em=d.error.message||'';
      const hard=['InvalidToken','AuthorizationRequired','InvalidAppID'];
      if(hard.includes(ec)){
        toast('Auth failed: '+em,'r',5000);
        if(activeLoginid&&tokenStore[activeLoginid]){delete tokenStore[activeLoginid];saveTokenStore();lsDel('deriv_active');}
        if(!window._authRetried){window._authRetried=true;setTimeout(()=>connect(),2500);}
        else{window._authRetried=false;showLogin();}
      }else{setTimeout(()=>{if(ws&&ws.readyState===1&&activeToken)ws.send(JSON.stringify({authorize:activeToken}));else connect();},3000);}
      return;
    }
    authed=true;
    const a=d.authorize;
    const realLoginid=a.loginid||activeLoginid;
    activeLoginid=realLoginid;userCurrency=a.currency||'USD';
    userInfo={name:a.fullname||a.loginid||'Trader',loginid:realLoginid,currency:userCurrency};
    console.log('Authorized as:', userInfo.name, '(', activeLoginid, ')', 'Balance:', a.balance);
    realBalance=a.balance!==undefined?parseFloat(a.balance):null;
    if(realLoginid&&realLoginid.length>2&&activeToken&&activeToken.length>10){
      tokenStore[realLoginid]={token:activeToken,currency:userCurrency,is_virtual:!!a.is_virtual};
      lsSet('deriv_active',realLoginid);saveTokenStore();
    }
    if(a.account_list&&a.account_list.length){
      accountList=a.account_list.map(ac=>({loginid:ac.loginid,currency:ac.currency||'USD',is_virtual:!!ac.is_virtual,account_type:ac.account_type||'real',token:getStoredToken(ac.loginid),balance:ac.loginid===realLoginid?realBalance:null}));
    }else{accountList=[{loginid:realLoginid,currency:userCurrency,is_virtual:!!a.is_virtual,token:activeToken,balance:realBalance}];}
    updateBalanceUI();showUserCard();renderAcctMenu();
    $('sbAuth').textContent=(a.is_virtual?'Demo':'Live')+':'+a.loginid;
    $('sbAuth').style.color=a.is_virtual?'var(--gold)':'var(--green)';
    $('hPnlBadge').style.display='flex';
    // Subscribe to balance updates from Deriv
    send({balance:1,subscribe:1});
    // Check for any open ACCU contracts
    send({portfolio:1,contract_type:['ACCU']});
    // Re-subscribe all ticks
    ALL_SYMS.forEach(s=>send({ticks:s.sym,subscribe:1}));
    // Request fresh balance and re-subscribe to balance updates
    send({balance:1,subscribe:1});
    setTimeout(()=>send({balance:1}),500);
    const acctTypeLabel = a.is_virtual ? 'ðŸŽ® Demo Account' : 'ðŸ’° Real Account';
    toast('âœ… '+acctTypeLabel+' Â· '+userInfo.name+' Â· '+userCurrency+' '+(realBalance||0).toFixed(2),'g',5000);
    return;
  }
  if(t==='balance'){
    if(d.balance && d.balance.balance !== undefined){
      const nb = parseFloat(d.balance.balance);
      const ob = realBalance;
      realBalance = nb;
      const acct = accountList.find(a => a.loginid === activeLoginid);
      if(acct) acct.balance = nb;
      updateBalanceUI();
      if(accountList.length > 1) renderAcctMenu();
      
      // Visual feedback for balance changes (stake deduction or payout)
      if(ob !== null && ob !== undefined && Math.abs(nb - ob) > 0.001){
        const diff = parseFloat((nb - ob).toFixed(2));
        if(Math.abs(diff) > 0.01){
          flashBalance();
          const isGain = diff > 0;
          const msg = (isGain ? "ðŸ’° Payout: +" : "ðŸ’¸ Stake: -") + Math.abs(diff).toFixed(2);
          toast(msg + " | New Balance: " + userCurrency + " " + nb.toFixed(2), isGain ? "g" : "y", 4000);
        }
      }
    }
    return;
  }
  if(t==='tick'){
    const tk=d.tick;if(!tk)return;
    const ts=tk.symbol;
    if(!symBufs[ts])symBufs[ts]=[];
    symBufs[ts].push(parseFloat(tk.quote));
    if(symBufs[ts].length>TICK_BUF)symBufs[ts].shift();
    if(ts===sym)processTick(tk);
    return;
  }
  if(t==='history'){
    const h=d.history;
    if(h && h.prices && h.times){
      const ts=d.echo_req.ticks_history;
      if(!symBufs[ts])symBufs[ts]=[];
      
      // Clear current tickBuf if this is the active symbol
      if(ts===sym) {
        tickBuf=[];
        priceHist=[];
        hi=-Infinity; lo=Infinity;
      }

      h.prices.forEach((p,i)=>{
        const price=parseFloat(p);
        symBufs[ts].push(price);
        if(ts===sym){
          const tk={symbol:ts,quote:price,epoch:h.times[i]};
          processTick(tk,true); // Pass true to indicate historical tick
        }
      });
      
      if(ts===sym) {
        analyzeHistoricalBreaks(ts);
        updatePatternUI(ts);
        toast('Loaded 100 historical ticks for '+ts,'g');
      }
      
      if(symBufs[ts].length>TICK_BUF)symBufs[ts]=symBufs[ts].slice(-TICK_BUF);
    }
    return;
  }
  if(t==='portfolio'){
    if(d.error)return;
    const open=((d.portfolio&&d.portfolio.contracts)||[]).filter(c=>c.contract_type==='ACCU');
    if(open.length>0){toast('Found '+open.length+' open ACCU â€” clearingâ€¦','y',5000);open.forEach(c=>send({sell:c.contract_id,price:0}));con=null;clearBarriers();renderNoContract();isBuying=false;aiCool=false;}
    return;
  }
  if(t==='proposal'){
    if(d.error){
      isBuying=false;pendingProposal=null;
      const em=d.error.message||d.error.code||'Unknown error';
      toast('Proposal error: '+em,'r',5000);
      return;
    }
    const prop=d.proposal;
    if(!prop||!isBuying)return;
    pendingProposal=prop;
    
    // ONLY NOW we create the contract object because the server confirmed the parameters
    con = {
      entry: parseFloat(prop.spot),
      upper: parseFloat(prop.barrier),
      lower: parseFloat(prop.low_barrier),
      ticks: 0,
      stake: parseFloat(prop.ask_price),
      pnl: 0,
      payout: parseFloat(prop.ask_price),
      start: now(),
      byAI: !!(window._lastEntryFromAI),
      realId: null,
      isReal: true
    };
    
    ticksHeld = 0; drawBarriers(); updateConUI(); $('exitMeter').classList.add('on');
    
    // Execute the actual buy using the proposal id
    send({buy:prop.id,price:prop.ask_price});
    return;
  }
  if(t==='buy'){
    isBuying=false;pendingProposal=null;proposalReqId=null;
    if(d.error){
      const ec=d.error.code||'',em=d.error.message||'';
      if(ec==='TooManyOpenPositions'||em.toLowerCase().includes('too many')){
        toast('Clearing open positionâ€¦','y',4000);con=null;clearBarriers();renderNoContract();aiCool=true;
        send({portfolio:1,contract_type:['ACCU']});setTimeout(()=>{aiCool=false;isBuying=false;},8000);
      }else{toast('Buy error: '+em,'r',5000);con=null;clearBarriers();renderNoContract();}
      return;
    }
    const bd=d.buy;
    if(bd){
      // If for some reason con was cleared, re-create it from buy data
      if(!con){
        con = {
          entry: bd.start_time_spot ? parseFloat(bd.start_time_spot) : prevP,
          upper: bd.barrier ? parseFloat(bd.barrier) : (prevP + barrierDist(prevP)),
          lower: bd.low_barrier ? parseFloat(bd.low_barrier) : (prevP - barrierDist(prevP)),
          ticks: 0,
          stake: parseFloat(bd.buy_price || 0),
          pnl: 0,
          payout: parseFloat(bd.buy_price || 0),
          start: bd.start_time || now(),
          byAI: !!(window._lastEntryFromAI),
          realId: bd.contract_id,
          isReal: true
        };
      } else {
        con.realId=bd.contract_id;
        if(bd.barrier)con.upper=parseFloat(bd.barrier);
        if(bd.low_barrier)con.lower=parseFloat(bd.low_barrier);
        if(bd.start_time)con.start=bd.start_time;
      }
      send({proposal_open_contract:1,contract_id:con.realId,subscribe:1});
      drawBarriers();updateConUI();toast('âœ… Contract confirmed by Deriv Â· ID:'+bd.contract_id,'g',3000);
    }
    return;
  }
  if(t==='proposal_open_contract'){
    const poc = d.proposal_open_contract;
    if(!poc || !con) return;
    
    // ABSOLUTE SERVER TRUTH: Sync contract state ONLY from official data
    if(poc.profit !== undefined) con.pnl = parseFloat(poc.profit);
    if(poc.bid_price !== undefined) con.payout = parseFloat(poc.bid_price);
    if(poc.sell_price !== undefined && poc.sell_price > 0) con.payout = parseFloat(poc.sell_price);
    if(poc.buy_price !== undefined) con.stake = parseFloat(poc.buy_price);
    
    // Update UI strictly from the sync values
    updateConUI();

    // Settlement Logic: Only close when finalized
    if(poc.status === 'lost' || poc.status === 'sold') {
      closeContract('Deriv:' + poc.status, con.byAI);
    }
    return;
  }
  if(t==='sell'){
    isBuying=false;
    if(d.error){
      const ec=d.error.code||'';
      if(['InvalidSellContractProposal','AlreadySold','ContractAlreadySold'].includes(ec)){
        if(con){
          if(con.byAI){aiLoss++;aiTrades++;aiPnl-=con.stake;addHistItem({won:false,pnl:-con.stake,reason:'KO',ticks:con.ticks});}
          con=null;clearBarriers();renderNoContract();exitProbability=0;updateExitMeter(0);$('exitMeter').classList.remove('on');
        }
        // Refresh balance after error-sell
        setTimeout(()=>send({balance:1}),1000);
      }else toast('Sell error: '+(d.error.message||''),'y',4000);
      return;
    }
    toast('Sold â€” awaiting Deriv settlementâ€¦','g',2000);
    // Refresh balance after successful sell
    setTimeout(()=>send({balance:1}),1500);
    setTimeout(()=>send({balance:1}),4000);
    return;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BALANCE & USER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateBalanceUI(){
  const v=realBalance!==null?userCurrency+' '+realBalance.toFixed(2):'â€”';
  $('hBalance').textContent=v;
  $('userBal').textContent=v;
  // Mobile balance pill â€” always visible on phone
  if($('mobBalance'))$('mobBalance').textContent=v;
  if($('mobBalPill'))$('mobBalPill').style.display=realBalance!==null?'flex':'none';
}
function showUserCard(){$('userSection').style.display='block';$('userName').textContent=userInfo.name||'Trader';$('userUid').textContent=userInfo.loginid||'â€”';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACCOUNT SWITCHER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAcctMenu(){
  if(!accountList||accountList.length<2){
    $('acctSwitcher').style.display='none';
    return;
  }
  $('acctSwitcher').style.display='block';
  const cur=accountList.find(a=>a.loginid===activeLoginid)||accountList[0];
  if(!cur)return;
  const isV=cur.is_virtual;
  const isCr=CRYPTO_CURRENCIES.includes(cur.currency);
  const curTag=$('acctCurTag');
  const curName=$('acctCurName');
  const curBal=$('acctCurBal');
  if(curTag){
    curTag.textContent=isV?'DEMO':isCr?'CRYPTO':'REAL';
    curTag.style.background=isV?'#1e2736':isCr?'#1a0d2e':'#003d1a';
    curTag.style.color=isV?'#7d8fa3':isCr?'var(--purple)':'var(--green)';
  }
  if(curName)curName.textContent=cur.loginid||'â€”';
  if(curBal)curBal.textContent=cur.balance!=null?cur.currency+' '+parseFloat(cur.balance).toFixed(2):'â€”';
  const menu=$('acctMenu');
  if(!menu)return;
  menu.innerHTML='';
  accountList.forEach(function(a){
    const iv=a.is_virtual;
    const ic=CRYPTO_CURRENCIES.includes(a.currency);
    const tc=iv?'tag-demo':ic?'tag-crypto':'tag-real';
    const tn=iv?'DEMO':ic?'CRYPTO':'REAL';
    const isAct=a.loginid===activeLoginid;
    const hasTok=!!getStoredToken(a.loginid);
    const bal=a.balance!=null?a.currency+' '+parseFloat(a.balance).toFixed(2):'â€”';
    const item=document.createElement('div');
    item.className='acct-menu-item'+(isAct?' active-acct':'');
    item.innerHTML='<span class="acct-menu-tag '+tc+'">'+tn+'</span>'
      +'<div class="acct-menu-info">'
      +'<div class="acct-menu-id">'+a.loginid+'</div>'
      +'<div class="acct-menu-cur">'+a.currency+(hasTok?'':' Â· tap to re-login')+'</div>'
      +'</div>'
      +'<span class="acct-menu-bal">'+bal+'</span>'
      +'<span class="acct-check">âœ“</span>';
    item.addEventListener('click',function(){
      switchAccount(a.loginid);
    });
    item.addEventListener('touchend',function(e){
      e.preventDefault();
      switchAccount(a.loginid);
    });
    menu.appendChild(item);
  });
}
function toggleAcctMenu(){
  const m=$('acctMenu');
  const isOpen=m.classList.contains('open');
  if(isOpen){closeAcctMenu();}
  else{
    m.classList.add('open');
    $('acctArrow').classList.add('open');
    // Close when clicking outside
    setTimeout(()=>{
      document.addEventListener('click',function handler(e){
        if(!m.contains(e.target)&&e.target.id!=='acctDropBtn'){
          closeAcctMenu();
          document.removeEventListener('click',handler,true);
        }
      },true);
    },50);
  }
}
function closeAcctMenu(){
  $('acctMenu').classList.remove('open');
  $('acctArrow').classList.remove('open');
}
function switchAccount(loginid){
  closeAcctMenu();
  if(loginid===activeLoginid){toast('Already on this account','y');return;}
  const tok=getStoredToken(loginid);
  if(!tok||tok.length<10){
    toast('Re-login needed for '+loginid,'p',4000);
    setTimeout(()=>{window.location.href=OAUTH_URL;},1500);
    return;
  }
  if(con)closeContract('Account switch',false);
  activeToken=tok;
  activeLoginid=loginid;
  authed=false;
  realBalance=null;
  window._authRetried=false;
  lsSet('deriv_active',loginid);
  $('hBalance').textContent='Switchingâ€¦';
  $('userBal').textContent='Switchingâ€¦';
  toast('ðŸ”„ Switching to '+loginid+'â€¦','p',3000);
  if(ws&&ws.readyState===1){
    ws.send(JSON.stringify({authorize:activeToken}));
  }else{
    connect();
  }
}
function logout(){
  lsDel('deriv_active');lsDel('deriv_ts');
  try{localStorage.clear();}catch(e){}
  tokenStore={};activeToken='';authed=false;userInfo={};realBalance=null;accountList=[];activeLoginid='';window._authRetried=false;
  if(con)closeContract('Logout',false);
  clearTimeout(reconnTimer);clearTimeout(connTO);clearInterval(pingTimer);clearInterval(heartbeatTimer);
  if(ws){try{ws.onopen=ws.onmessage=ws.onerror=ws.onclose=null;ws.close();}catch(e){}}
  ws=null;wsAlive=false;appReady=false;
  $('userSection').style.display='none';$('acctSwitcher').style.display='none';
  $('hBalance').textContent='â€”';$('sbAuth').textContent='Demo';$('sbAuth').style.color='var(--sub)';
  setDot('rc');showLogin();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initChart(){
  const el=$('chart');
  if(chart){try{chart.remove();}catch(e){}}
  chart=LightweightCharts.createChart(el,{
    layout:{background:{color:'#0a0d12'},textColor:'#7d8fa3'},
    grid:{vertLines:{color:'#1e273606'},horzLines:{color:'#1e273614'}},
    crosshair:{mode:LightweightCharts.CrosshairMode.Normal},
    rightPriceScale:{borderColor:'#1e2736',scaleMargins:{top:0.1,bottom:0.1}},
    timeScale:{borderColor:'#1e2736',timeVisible:true,secondsVisible:true,rightOffset:10},
    handleScroll:true,handleScale:true
  });
  area=chart.addAreaSeries({lineColor:'#00b0ff',topColor:'#00b0ff22',bottomColor:'#00b0ff00',lineWidth:2,priceFormat:{type:'price',precision:dp,minMove:Math.pow(10,-dp)},lastValueVisible:true,priceLineVisible:true});
  const ro=new ResizeObserver(()=>{if(chart&&el)chart.applyOptions({width:el.clientWidth,height:el.clientHeight});});
  ro.observe(el);
  setTimeout(()=>{if(chart&&el)chart.applyOptions({width:el.clientWidth,height:el.clientHeight});},100);
}
function mkLine(color,title,style,width){
  return chart.addLineSeries({color,lineWidth:width||1,lineStyle:style!==undefined?style:LightweightCharts.LineStyle.Solid,lastValueVisible:true,priceLineVisible:false,crosshairMarkerVisible:false,title,priceFormat:{type:'price',precision:dp,minMove:Math.pow(10,-dp)}});
}
function drawBarriers(){
  clearBarriers();if(!con||!chart)return;
  lineU=mkLine('#00e676','Upper',LightweightCharts.LineStyle.Solid,2);
  lineL=mkLine('#ff3d71','Lower',LightweightCharts.LineStyle.Solid,2);
  lineE=mkLine('#00b0ff55','Entry',LightweightCharts.LineStyle.Dashed,1);
  if(priceHist.length>0){
    const last=priceHist.slice(-50);
    lineU.setData(last.map(p=>({time:p.time,value:con.upper})));
    lineL.setData(last.map(p=>({time:p.time,value:con.lower})));
    lineE.setData(last.map(p=>({time:p.time,value:con.entry})));
  }
}
function appendBarrierPts(t){
  if(!con)return;
  try{if(lineU)lineU.update({time:t,value:con.upper});}catch(e){}
  try{if(lineL)lineL.update({time:t,value:con.lower});}catch(e){}
  try{if(lineE)lineE.update({time:t,value:con.entry});}catch(e){}
}
function clearBarriers(){[lineU,lineL,lineE].forEach(s=>{if(s)try{chart.removeSeries(s);}catch(e){}});lineU=lineL=lineE=null;}
function barrierDist(p){const m={1:0.01516,2:0.02326,3:0.03121,4:0.03900,5:0.04663};return p*(m[gr]||0.02326);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATTERN ENGINE â€” learns from real barrier breaks
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function recordBreak(symKey,tickCount){
  if(!breakHistory[symKey])breakHistory[symKey]=[];
  breakHistory[symKey].push(tickCount);
  if(breakHistory[symKey].length>60)breakHistory[symKey].shift();
}
function getPatternStats(symKey){
  const hist=breakHistory[symKey]||[];
  if(hist.length<2)return{avg:999,min:999,safeExit:999,count:0};
  const avg=hist.reduce((a,b)=>a+b,0)/hist.length;
  const min=Math.min(...hist);
  const sorted=[...hist].sort((a,b)=>a-b);
  const p15idx=Math.floor(sorted.length*0.15);
  const safeExit=Math.max(2,Math.floor(sorted[p15idx]*0.65));
  return{avg:Math.round(avg),min,safeExit,count:hist.length};
}
function updatePatternUI(symKey){
  const s=getPatternStats(symKey);
  if(s.count<2){
    $('pAvgBreak').textContent='Learningâ€¦';$('pMinBreak').textContent='â€”';$('pSafeExit').textContent='â€”';
    $('pVolScore').textContent=volScores[symKey]?volScores[symKey].score+'%':'â€”';
    $('infoPatExit').textContent='Learningâ€¦';return;
  }
  $('pAvgBreak').textContent=s.avg+' ticks';
  $('pMinBreak').textContent=s.min+' ticks';
  $('pSafeExit').textContent=s.safeExit+' ticks';
  $('pVolScore').textContent=volScores[sym]?volScores[sym].score+'%':'â€”';
  $('infoPatExit').textContent='Exit@'+s.safeExit+'t';
}

function analyzeHistoricalBreaks(symKey) {
  if (tickBuf.length < 20) return;
  const hist = [];
  // Simulate 10 random entries in the last 100 ticks to see where they would have broken
  for (let i = 0; i < 10; i++) {
    const startIdx = Math.floor(Math.random() * (tickBuf.length - 15));
    const entryPrice = tickBuf[startIdx].p;
    const dist = barrierDist(entryPrice);
    const upper = entryPrice + dist;
    const lower = entryPrice - dist;
    
    let ticks = 0;
    for (let j = startIdx + 1; j < tickBuf.length; j++) {
      ticks++;
      if (tickBuf[j].p >= upper || tickBuf[j].p <= lower) {
        hist.push(ticks);
        break;
      }
      // If it didn't break by the end of history, assume it lasted at least this long
      if (j === tickBuf.length - 1) hist.push(ticks + 5); 
    }
  }
  if (hist.length > 0) {
    breakHistory[symKey] = hist;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TICK PROCESSING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function processTick(tick, isHistory){
  const p=parseFloat(tick.quote),t=tick.epoch;
  if(p>hi)hi=p;if(p<lo)lo=p;
  const chg=prevP!==null?p-prevP:0;
  const pct=prevP!==null?(chg/prevP)*100:0;
  const up=chg>=0;

  if(!isHistory){
    $('priceEl').textContent=p.toFixed(dp);
    $('priceEl').className='price-main '+(up?'up':'dn');
    $('priceChg').textContent=(up?'+':'')+pct.toFixed(4)+'%';
    $('priceChg').className='price-chg '+(up?'ub':'db');
    $('metaH').textContent='H:'+hi.toFixed(dp);
    $('metaL').textContent='L:'+lo.toFixed(dp);
    $('mobPrice').textContent=sym+' '+p.toFixed(dp);
  }

  const pt={time:t,value:p};
  priceHist.push(pt);if(priceHist.length>TICK_BUF*5)priceHist.shift();
  if(!isHistory){
    try{area.update(pt);}catch(e){}
    appendBarrierPts(t);
  }

  tickBuf.push({p,t,chg,up});
  if(tickBuf.length>TICK_BUF)tickBuf.shift();
  
  if(!isHistory){
    $('infoBuf').textContent=tickBuf.length+'/100';
    $('feedPulse').style.opacity='1';
    setTimeout(()=>$('feedPulse').style.opacity='0.3',150);
  }

  if(!con&&prevP!==null&&!isHistory){
    const bd=barrierDist(p);
    $('bUpper').textContent=(p+bd).toFixed(dp);$('bLower').textContent=(p-bd).toFixed(dp);
    $('bEntry').textContent='â€”';$('infoBarrier').textContent='Â±'+bd.toFixed(dp);
  }

  // â”€â”€ ACTIVE CONTRACT â”€â”€
  // Only process the active contract if it has been confirmed by Deriv (has realId)
  if(con && con.realId && !exitingNow && !isHistory){
    con.ticks++; ticksHeld++;
    // P&L is updated strictly from Deriv API (proposal_open_contract)
    // No local simulation fallback here to ensure account sync.

    const dU=con.upper-p,dL=p-con.lower;
    const half=(con.upper-con.lower)/2;
    const nearDist=Math.min(dU,dL);
    const nearBar=dU<dL?con.upper:con.lower;
    const safetyPct=(nearDist/half)*100;

    $('bUpper').textContent=con.upper.toFixed(dp);$('bLower').textContent=con.lower.toFixed(dp);
    $('bEntry').textContent=con.entry.toFixed(dp);
    $('bSafety').textContent=safetyPct.toFixed(1)+'%';
    $('bSafety').style.color=safetyPct>55?'var(--green)':safetyPct>25?'var(--gold)':'var(--red)';

    const bp=computeBreakProb(p,con,tickBuf);
    exitProbability=bp;updateExitMeter(bp);

    const hs=computeHoldScore(p,con,tickBuf);
    $('iHold').textContent=hs+'%';$('iHold').style.color=hs>60?'var(--green)':hs>30?'var(--gold)':'var(--red)';
    $('ovHold').textContent=hs+'%';$('infoHold').textContent=hs+'% safe';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 11-LAYER PURE MARKET-ANALYSIS SNIPER EXIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const n=tickBuf.length;

    // QUANTUM-SHIELD ABSOLUTE ZERO-LOSS EXIT
    // L1: GHOST-TICK PREDICTION â€” Predicts next 3 ticks. Exit if ANY path is dangerous.
    const last3 = tickBuf.slice(-3).map(b=>b.p);
    const v1 = last3[2]-last3[1], v2 = last3[1]-last3[0];
    const accel = v1 - v2;
    const nextP1 = p + v1 + accel;
    const nextP2 = nextP1 + v1 + (accel * 1.5);
    const nextP3 = nextP2 + v1 + (accel * 2.0);
    const L1 = (nearBar===con.upper && (nextP1 > con.upper*0.999 || nextP2 > con.upper*0.999 || nextP3 > con.upper*0.999)) ||
               (nearBar===con.lower && (nextP1 < con.lower*1.001 || nextP2 < con.lower*1.001 || nextP3 < con.lower*1.001));

    // L2: BOLLINGER-ATR HYBRID â€” Exit if price touches bands OR ATR expands 20%
    const prices = tickBuf.slice(-20).map(b=>b.p);
    const sma = prices.reduce((a,b)=>a+b,0)/20;
    const std = Math.sqrt(prices.reduce((a,b)=>a+Math.pow(b-sma,2),0)/20);
    const ranges = tickBuf.slice(-20).map((b,i,ar)=>i===0?0:Math.abs(b.p-ar[i-1].p));
    const atr = ranges.reduce((a,b)=>a+b,0)/20;
    const prevAtr = ranges.slice(0,15).reduce((a,b)=>a+b,0)/15;
    const L2 = (nearBar===con.upper && p > (sma + std*1.8)) || (nearBar===con.lower && p < (sma - std*1.8)) || (atr > prevAtr * 1.2);

    // L3: PROACTIVE BREAK RISK â€” Exit if BP hits 25% (Maximum safety)
    const L3=bp>=25&&safetyPct<80;

    // L4: INSTITUTIONAL STOP-RUN DETECTION â€” Sudden volume/momentum burst
    let L4=false;
    if(n>=5){
      const microV = Math.abs(tickBuf[n-1].p - tickBuf[n-5].p);
      if(microV > atr * 3.5 && safetyPct < 85) L4=true;
    }

    // L5: INSTANT REVERSAL GUARD â€” Exit on ANY tick toward barrier if safety < 80%
    let L5=false;
    if(n>=2&&safetyPct<80){
      const toBar = (nearBar===con.upper && tickBuf[n-1].p > tickBuf[n-2].p) || (nearBar===con.lower && tickBuf[n-1].p < tickBuf[n-2].p);
      L5=toBar;
    }

    // L6: NEURAL CONFIDENCE SHIELD â€” Exit if AI confidence drops below 75%
    const L6=hs<75||safetyPct<60;

    let L7=false;
    if(n>=4&&safetyPct<30){
      const last4=tickBuf.slice(-4).map(b=>b.p);
      const testU=Math.max(...last4)/con.upper;
      const testL=con.lower/Math.min(...last4);
      L7=testU>0.9992||testL>0.9992;
    }

    let L8=false;
    if(n>=7&&safetyPct<50){
      const moves=[];
      for(let i=n-6;i<n;i++)moves.push(tickBuf[i].p-tickBuf[i-1].p);
      const toBar=nearBar===con.upper;
      const allToBar=moves.every(m=>toBar?m>0:m<0);
      const accelerating=moves.every((m,i)=>i===0||Math.abs(m)>=Math.abs(moves[i-1])*0.75);
      L8=allToBar&&accelerating;
    }

    let L9=false;
    if(n>=8&&bp>=55&&safetyPct<25){
      const vel5=(tickBuf[n-1].p-tickBuf[n-5].p);
      const toBar=(nearBar===con.upper&&vel5>0)||(nearBar===con.lower&&vel5<0);
      const velPct=Math.abs(vel5)/half;
      L9=toBar&&velPct>0.15;
    }

    let L10=false;
    if(n>=10&&safetyPct<35){
      let g=0,l=0;
      for(let i=n-9;i<n;i++){const c=tickBuf[i].p-tickBuf[i-1].p;if(c>0)g+=c;else l+=Math.abs(c);}
      const rsiVal=100-100/(1+((g/9)||0.001)/((l/9)||0.001));
      const extremeUp=nearBar===con.upper&&rsiVal>75;
      const extremeDn=nearBar===con.lower&&rsiVal<25;
      L10=extremeUp||extremeDn;
    }

    let L11=false;
    if(n>=12&&safetyPct<45){
      const avgSz=tickBuf.slice(n-12,n-4).reduce((a,b)=>a+Math.abs(b.chg),0)/8||0.0001;
      const last4=tickBuf.slice(-4);
      const allDir=last4.every(b=>nearBar===con.upper?b.up:!b.up);
      const allBig=last4.every(b=>Math.abs(b.chg)>avgSz*1.5);
      L11=allDir&&allBig;
    }

    const shouldExit=aiOn&&con.byAI&&(L1||L2||L3||L4||L5||L6||L7||L8||L9||L10||L11);
    if(shouldExit){
      const reason=L1?'Edge<0.04%':L2?'Accel burst<20%':L3?'Score '+bp+'%+prox':L4?'Vel surge 30%':L5?'4-streak<40%':L6?'Hold '+hs+'%':L7?'Bar test<30%':L8?'AccelÃ—6 pattern':L9?'Triple alarm':L10?'RSI ext<35%':'MicroBurstÃ—4';
      sniperExit(p,bp,reason);
      prevP=p;addTickRow(p,chg,t);
      $('sbTime').textContent=new Date(t*1000).toLocaleTimeString();
      return;
    }

    updateConUI();
    if(p>=con.upper||p<=con.lower){recordBreak(sym,con.ticks);updatePatternUI(sym);onKO(p);prevP=p;addTickRow(p,chg,t);return;}
    if(tp&&con.pnl>=tp)sniperExit(p,0,'Take Profit');
  }

  if(!isHistory){
    addTickRow(p,chg,t);
    prevP=p;
    $('sbTime').textContent=new Date(t*1000).toLocaleTimeString();
    if(aiOn&&tickBuf.length>=5)runAI(p);
    updatePatternUI(sym);
  } else {
    prevP=p; // Still update prevP for historical chain
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BREAK PROBABILITY â€” pure market analysis, 10 factors
// CRITICAL: Distance clamp ensures score can ONLY be high near barrier
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function computeBreakProb(price,contract,buf){
  if(!contract||!contract.upper||!contract.lower||buf.length<20)return 0;
  let score=0;
  const n=buf.length;
  const upper=contract.upper,lower=contract.lower;
  const half=(upper-lower)/2;
  const dU=upper-price,dL=price-lower;
  const nearDist=Math.min(dU,dL);
  const nearBar=dU<dL?upper:lower;
  const proxRatio=1-(nearDist/half);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INDICATOR MATRIX: Bollinger Bands & Keltner Channels
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const prices = buf.slice(-20).map(b=>b.p);
  const sma = prices.reduce((a,b)=>a+b,0)/20;
  const std = Math.sqrt(prices.reduce((a,b)=>a+Math.pow(b-sma,2),0)/20);
  const bbUpper = sma + (std * 2);
  const bbLower = sma - (std * 2);
  
  // Keltner Channels (using simple range for ATR approximation)
  const ranges = buf.slice(-20).map((b,i,ar)=>i===0?0:Math.abs(b.p-ar[i-1].p));
  const atr = ranges.reduce((a,b)=>a+b,0)/20;
  const kcUpper = sma + (atr * 2.5);
  const kcLower = sma - (atr * 2.5);

  // F1: Bollinger Band Breach (Predictive), 30pts
  if(nearBar===upper && price > bbUpper) score += 30;
  if(nearBar===lower && price < bbLower) score += 30;

  // F2: Keltner Channel Extreme, 20pts
  if(nearBar===upper && price > kcUpper) score += 20;
  if(nearBar===lower && price < kcLower) score += 20;

  // F3: Proximity â€” exponential, 25pts max
  score+=Math.max(0,Math.pow(proxRatio,1.8)*25);

  // F4: Velocity toward barrier, 15pts
  const vWin=Math.min(5,n-1);
  const vel=(buf[n-1].p-buf[n-1-vWin].p)/vWin;
  const velToBar=(nearBar===upper&&vel>0)||(nearBar===lower&&vel<0);
  if(velToBar)score+=Math.min(15,Math.abs(vel)/half*1500);

  // F5: Neural Spike-Guard (Predictive Analysis)
  const microVol=Math.sqrt(prices.slice(-5).reduce((a,b,i,arr)=>a+Math.pow(b-(arr.reduce((x,y)=>x+y,0)/5),2),0)/5);
  if(microVol > std * 1.5 || microVol < std * 0.2) score += 25;

  // â•â•â• CRITICAL DISTANCE CLAMP â•â•â•
  // This is the KEY to preventing early exits:
  // Score is physically impossible to be high when price is far from barrier
  const distRatio=nearDist/half; // 1=center(safe), 0=at barrier(danger)
  if(distRatio>0.85)score=Math.min(score,2);
  else if(distRatio>0.70)score=Math.min(score,8);
  else if(distRatio>0.55)score=Math.min(score,20);
  else if(distRatio>0.40)score=Math.min(score,38);
  else if(distRatio>0.25)score=Math.min(score,60);
  // Only when within 25% of barrier can score exceed 60%

  return Math.min(100,Math.max(0,Math.round(score)));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOLD SCORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function computeHoldScore(price,contract,buf){
  if(!contract||buf.length<3)return 50;
  const n=buf.length;
  const upper=contract.upper,lower=contract.lower;
  const half=(upper-lower)/2;
  const dU=upper-price,dL=price-lower;
  const nearDist=Math.min(dU,dL);
  const nearBar=dU<dL?upper:lower;
  const distRatio=nearDist/half;
  let score=100;
  score-=Math.pow(1-distRatio,1.5)*65;
  if(n>=3){const v1=buf[n-1].p-buf[n-2].p;const toBar=(nearBar===upper&&v1>0)||(nearBar===lower&&v1<0);if(toBar)score-=Math.min(25,Math.abs(v1)/half*1000);}
  if(n>=14){const r=buf.slice(n-14).map(b=>b.p);const m=r.reduce((a,b)=>a+b,0)/14;const std=Math.sqrt(r.reduce((a,b)=>a+Math.pow(b-m,2),0)/14);const rv=(std/price)*100;if(rv<0.07)score+=8;else if(rv>0.22)score-=12;}
  return Math.min(100,Math.max(0,Math.round(score)));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXIT METER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateExitMeter(bp){
  const fill=$('emFill'),pct=$('emPct'),sc=$('emScore'),cw=$('chartWrap');
  fill.style.width=bp+'%';
  fill.style.background=bp<30?'var(--green)':bp<50?'var(--gold)':bp<70?'var(--orange)':'var(--red)';
  pct.textContent=bp+'%';
  if(bp<30){sc.textContent='HOLD SAFE';sc.style.color='var(--green)';}
  else if(bp<50){sc.textContent='CAUTION';sc.style.color='var(--gold)';}
  else if(bp<70){sc.textContent='DANGER';sc.style.color='var(--orange)';}
  else{sc.textContent='BREAK IMMINENT!';sc.style.color='var(--red)';}
  $('exitMeter').classList.toggle('on',!!con);
  cw.classList.toggle('danger',bp>=72&&!!con);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOLATILITY SCANNER â€” all 10 symbols
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function scoreSymDeep(sSym){
  const buf=symBufs[sSym]||[];
  if(buf.length<10)return{score:0,stability:0,momentum:0,longevity:0,breakRisk:0};
  const m=Math.min(100,buf.length);
  const prices=buf.slice(-m);
  const mean=prices.reduce((a,b)=>a+b,0)/m;
  const std=Math.sqrt(prices.reduce((a,b)=>a+Math.pow(b-mean,2),0)/m);
  const stability=Math.max(0,Math.min(100,100-(std/mean)*100*380));
  let sameDir=0;
  for(let i=1;i<m;i++){if((prices[i]>prices[i-1])===(i>=2?prices[i-1]>prices[i-2]:true))sameDir++;}
  const trendConsistency=Math.round((sameDir/(m-1))*100);
  const rec=prices.slice(-10).reduce((a,b)=>a+b,0)/10;
  const old=prices.slice(0,10).reduce((a,b)=>a+b,0)/10;
  const momentum=Math.max(0,Math.min(100,100-Math.abs((rec-old)/old*100)*20));
  const hist=breakHistory[sSym]||[];
  let longevity=55;
  if(hist.length>=2){const avgBreak=hist.reduce((a,b)=>a+b,0)/hist.length;longevity=Math.min(100,Math.max(0,avgBreak*1.8));}
  const recentStd=Math.sqrt(prices.slice(-15).reduce((a,b)=>a+Math.pow(b-mean,2),0)/Math.min(15,prices.length));
  const breakRisk=Math.min(100,Math.round((recentStd/mean)*100*580));
  const score=Math.min(100,Math.round(stability*0.35+trendConsistency*0.20+momentum*0.20+longevity*0.15+(100-breakRisk)*0.10));
  return{score,stability:Math.round(stability),momentum:Math.round(momentum),longevity:Math.round(longevity),breakRisk};
}

function doVolScanAndSwitch(silent){
  if(!silent)$('scanOverlay').classList.add('open');
  $('scanResults').innerHTML='';$('scanProgressFill').style.width='0%';
  let prog=0;
  const pi=setInterval(()=>{prog=Math.min(95,prog+5);$('scanProgressFill').style.width=prog+'%';},120);
  setTimeout(()=>{
    clearInterval(pi);$('scanProgressFill').style.width='100%';
    const results=ALL_SYMS.map(s=>{
      const sc=scoreSymDeep(s.sym);volScores[s.sym]=sc;
      return Object.assign({},s,sc);
    }).sort((a,b)=>b.score-a.score);

    if(!silent){
      results.forEach((r,i)=>{
        const isW=i===0;
        const el=document.createElement('div');
        el.className='scan-result-item'+(isW?' winner':'');
        el.innerHTML='<div style="min-width:44px;">'
          +'<div style="font-size:12px;font-weight:800;color:'+(isW?'var(--green)':'var(--text)')+';">'+(isW?'ðŸ† ':'')+r.name+'</div>'
          +'<div style="font-size:9px;color:var(--sub);">'+r.sym+'</div></div>'
          +'<div style="flex:1;padding:0 7px;">'
          +'<div class="sri-bar-row"><span class="sri-bar-lbl">Stability</span><div class="sri-bar-bg"><div class="sri-bar-fill" style="width:'+r.stability+'%;background:var(--green);"></div></div><span style="font-size:9px;margin-left:3px;">'+r.stability+'%</span></div>'
          +'<div class="sri-bar-row"><span class="sri-bar-lbl">Longevity</span><div class="sri-bar-bg"><div class="sri-bar-fill" style="width:'+r.longevity+'%;background:var(--blue);"></div></div><span style="font-size:9px;margin-left:3px;">'+r.longevity+'%</span></div>'
          +'<div class="sri-bar-row"><span class="sri-bar-lbl">Momentum</span><div class="sri-bar-bg"><div class="sri-bar-fill" style="width:'+r.momentum+'%;background:var(--purple);"></div></div><span style="font-size:9px;margin-left:3px;">'+r.momentum+'%</span></div>'
          +'</div><div style="text-align:right;">'
          +'<div class="sri-score" style="color:'+(isW?'var(--green)':r.score>60?'var(--gold)':'var(--red)')+';">'+r.score+'</div>'
          +'<div class="vol-badge '+(isW?'best':r.score>60?'good':'bad')+'">'+(isW?'BEST':r.score>60?'GOOD':'WEAK')+'</div></div>';
        el.addEventListener('click',()=>{switchSym(r.sym,r.dp);$('scanOverlay').classList.remove('open');toast('Switched to '+r.name,'g');});
        $('scanResults').appendChild(el);
      });
    }

    renderVolSide(results);

    // FAST-QUANTUM PARALLEL SCANNING: Rapidly hop to the best market
    if(!con && results.length > 0){
      const best = results[0];
      const currentScore = volScores[sym] ? volScores[sym].score : 0;
      // Faster switching (every 2.5s) and lower threshold for hopping
      if(now() - lastVolSwitch > 2500 && (best.score > currentScore + 8 || currentScore < 70)){
        lastVolSwitch = now();
        if(best.sym !== sym){
          switchSym(best.sym, best.dp);
          toast('âš¡ AI JUMP â†’ ' + best.name + ' (' + best.score + '%)', 'p');
        }
      }
    }
  },1500);
}

function renderVolSide(results){
  const el=$('volScanList');
  if(!results||!results.length){el.innerHTML='<div style="text-align:center;color:var(--sub);font-size:10px;padding:6px;">Click SCANâ€¦</div>';return;}
  el.innerHTML=results.map((r,i)=>
    '<div class="vol-item'+(i===0?' best':'')+(r.sym===sym?' active-sym':'')+'" onclick="switchSym(\''+r.sym+'\','+r.dp+');closeAllPanels();">'
    +'<span class="vol-name">'+(i===0?'ðŸ† ':'')
    +'<span style="color:'+(i===0?'var(--green)':r.sym===sym?'var(--blue)':'var(--text)')+';">'+r.name+'</span></span>'
    +'<div class="vol-score-bar"><div class="vol-score-fill" style="width:'+r.score+'%;"></div></div>'
    +'<span class="vol-score-num" style="color:'+(i===0?'var(--green)':r.score>60?'var(--gold)':'var(--red)')+';">'+r.score+'</span>'
    +'<span class="vol-badge '+(i===0?'best':r.score>60?'good':'bad')+'">'+(i===0?'BEST':r.score>60?'OK':'WEAK')+'</span></div>'
  ).join('');
}

function switchSym(newSym,newDp){
  sym=newSym;dp=newDp||3;
  document.querySelectorAll('.sym-btn').forEach(b=>b.classList.toggle('active',b.dataset.sym===sym));
  if(area)area.applyOptions({priceFormat:{type:'price',precision:dp,minMove:Math.pow(10,-dp)}});
  if(con)closeContract('Symbol switch',false);
  tickBuf=[];priceHist=[];prevP=null;hi=-Infinity;lo=Infinity;
  $('tickFeed').innerHTML='';$('sbSym').textContent=sym;
  updatePatternUI(sym);
  if(ws&&ws.readyState===1){
    ws.send(JSON.stringify({forget_all:'ticks'}));
    // Request 100 historical ticks immediately
    send({ticks_history:sym,count:100,end:'latest',style:'ticks'});
    setTimeout(()=>{if(ws&&ws.readyState===1)ALL_SYMS.forEach(s=>ws.send(JSON.stringify({ticks:s.sym,subscribe:1})));},400);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI ENGINE â€” fast hunting, smart entry
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runAI(price){
  const buf=tickBuf,n=buf.length;
  // SCALPING START: Need 5 ticks for micro-trend analysis
  if(n<5)return;
  const sh=Math.min(8,n),lg=Math.min(50,n);
  const shAvg=buf.slice(n-sh).reduce((a,b)=>a+b.p,0)/sh;
  const lgAvg=buf.slice(n-lg).reduce((a,b)=>a+b.p,0)/lg;
  const trendUp=shAvg>lgAvg;
  const rocP=Math.min(5,n-1);
  const roc=((buf[n-1].p-buf[n-1-rocP].p)/buf[n-1-rocP].p)*100;
  const momUp=roc>0;
  const rsiP=Math.min(14,n-1);
  let g=0,l=0;
  for(let i=n-rsiP;i<n;i++){const c=buf[i].p-buf[i-1].p;if(c>0)g+=c;else l+=Math.abs(c);}
  const rs=(g/rsiP)/((l/rsiP)||0.0001);
  const rsi=100-100/(1+rs);
  const rsiOS=rsi<38,rsiOB=rsi>62;
  const vp=Math.min(20,n),vPrices=buf.slice(n-vp).map(b=>b.p);
  const mean=vPrices.reduce((a,b)=>a+b,0)/vp;
  const stdDev=Math.sqrt(vPrices.reduce((a,b)=>a+Math.pow(b-mean,2),0)/vp);
  const lowVol=(stdDev/price)*100<0.15;
  const hs=con?computeHoldScore(price,con,buf):0;
  const er=con?exitProbability:0;

  let entryScore=0;
  // NEURAL-NETWORK PROBABILITY SHIELD: Triple-Confirmation Entry
  const last5 = buf.slice(-5);
  const microTrendUp = last5.every((b,i,ar)=>i===0||b.p >= ar[i-1].p);
  const microTrendDn = last5.every((b,i,ar)=>i===0||b.p <= ar[i-1].p);
  
  // Quantum Stability Check: Tick density and jitter analysis
  const intervals = last5.map((b,i,ar)=>i===0?0:b.t-ar[i-1].t);
  const avgInterval = intervals.reduce((a,b)=>a+b,0)/4;
  const jitter = Math.sqrt(intervals.reduce((a,b)=>a+Math.pow(b-avgInterval,2),0)/4);
  const quantumStable = jitter < 0.5; // Low jitter means predictable tick flow

  // Entry Score based on stability, micro-trend, and quantum flow
  const symScore = volScores[sym] ? volScores[sym].score : 50;
  const trendStrength = (microTrendUp || microTrendDn) ? 50 : 0;
  entryScore = (symScore * 0.4) + trendStrength + (quantumStable ? 10 : 0);

  let sig='WAIT',reason='Analyzingâ€¦';
  if(con&&con.byAI){sig='IN TRADE';reason='Hold:'+hs+'% Break:'+er+'%';}
  // FAST-QUANTUM ENTRY: Optimized for speed without losing accuracy
  else if(!con && !isBuying && (entryScore >= 70 || (symScore > 65 && (microTrendUp || microTrendDn)))){
    sig='BUY';
    reason='FAST-Q:'+entryScore.toFixed(0)+'%';
  }
  else{sig='WAIT';reason='Hunting Quantum Flow...';}

  const tl=trendUp?'â–² BULL':'â–¼ BEAR';
  $('iTrend').textContent=tl;$('iTrend').style.color=trendUp?'var(--green)':'var(--red)';
  $('iMom').textContent=(roc>=0?'+':'')+roc.toFixed(3)+'%';$('iMom').style.color=momUp?'var(--green)':'var(--red)';
  const rl=rsi.toFixed(1)+(rsiOS?' OS':rsiOB?' OB':'');
  $('iRsi').textContent=rl;$('iRsi').style.color=rsiOS?'var(--green)':rsiOB?'var(--red)':'var(--gold)';
  $('iVol').textContent=lowVol?'LOW':'MED/HI';$('iVol').style.color=lowVol?'var(--green)':'var(--red)';
  $('iExit').textContent=er+'%';$('iExit').style.color=er<30?'var(--green)':er<55?'var(--gold)':'var(--red)';

  const boxCls=sig==='BUY'||sig==='IN TRADE'?'BUY':'WAIT';
  $('sigBox').className='sig-box '+boxCls;$('sigTxt').className='sig-txt '+boxCls;
  $('sigTxt').textContent=sig;$('sigSub').textContent=reason;
  scanAnim=(scanAnim+8)%105;$('scanFill').style.width=Math.min(100,scanAnim)+'%';

  const wr=aiTrades>0?((aiWins/aiTrades)*100).toFixed(0)+'%':'â€”';
  $('stWins').textContent=aiWins;$('stLoss').textContent=aiLoss;$('stWR').textContent=wr;
  $('stPnl').textContent=(aiPnl>=0?'+':'')+aiPnl.toFixed(2);$('stPnl').style.color=aiPnl>=0?'var(--green)':'var(--red)';
  $('hWins').textContent=aiWins+'W';
  $('hPnl').textContent=(aiPnl>=0?'+$':'-$')+Math.abs(aiPnl).toFixed(2);$('hPnl').style.color=aiPnl>=0?'var(--green)':'var(--red)';
  $('ovTrend').textContent=tl;$('ovTrend').style.color=trendUp?'var(--green)':'var(--red)';
  $('ovRsi').textContent=rl;$('ovRsi').style.color=rsiOS?'var(--green)':rsiOB?'var(--red)':'var(--gold)';
  $('ovExitRisk').textContent=er+'%';$('ovExitRisk').style.color=er<30?'var(--green)':er<55?'var(--gold)':'var(--red)';
  $('ovSig').textContent=sig;$('ovSig').style.color=sig==='BUY'||sig==='IN TRADE'?'var(--green)':'var(--gold)';
  $('sbAI').textContent='AI:'+aiTrades+'t';$('sbAI').style.color=aiOn?'var(--green)':'var(--sub)';

  if(sig==='BUY'&&!con&&!aiCool&&!isBuying)doEntry(price,entryScore);
  // Scan vol every 15s when no trade
  if(now()-lastVolSwitch>15000&&!con)doVolScanAndSwitch(true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENTRY & EXIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doEntry(price,score){
  if(con||exitingNow||isBuying)return;
  // REMOVED COOLDOWN: No more aiCool delay
  ticksHeld=0;
  phase='FIRE';updatePhaseUI();
  showFlash('flashBuy','AI ENTRY @ '+price.toFixed(dp),1000);
  toast('ðŸŽ¯ AI FORCE ENTRY @ '+price.toFixed(dp),'p');
  buyContract(true);phase='IN_TRADE';updatePhaseUI();
}

function sniperExit(price,bp,reason){
  if(!con||exitingNow)return;
  exitingNow=true;phase='EXITING';updatePhaseUI();
  showFlash('flashExit','SNIPER EXIT @ '+price.toFixed(dp)+' | '+reason,2500);
  closeContract(reason,true);
  setTimeout(()=>{
    phase='HUNTING';exitingNow=false;updatePhaseUI();
    // Force immediate vol scan after exit
    if(aiOn){lastVolSwitch=0;setTimeout(()=>doVolScanAndSwitch(true),400);}
  },400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUY CONTRACT â€” Proper Deriv API flow: proposal â†’ buy
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buyContract(fromAI){
    if(!wsAlive){toast('Not connected','r');return;}
    if(!authed || !activeToken){toast('âš ï¸ Please login to your Deriv account first','y',5000);showLogin();return;}
    if(con){toast('Already in trade','r');return;}
    if(!prevP){toast('No price yet â€” wait for tick data','y');return;}
    if(isBuying){toast('Trade pendingâ€¦','y');return;}

    window._lastEntryFromAI = !!fromAI;
    const currentStake = parseFloat($('stkInput').value) || stake;
    const isVirtual = accountList.find(a=>a.loginid===activeLoginid);
    const acctType = (isVirtual && isVirtual.is_virtual) ? 'DEMO' : 'REAL';

    isBuying = true;
    const label = fromAI ? 'ðŸ¤– AI Sniper' : 'ðŸš€ Manual';
    toast(label + ' [' + acctType + '] Requesting proposalâ€¦', 'p', 2000);
    console.log('[Deriv] Sending proposal request:', {symbol: sym, amount: currentStake, growth_rate: gr/100, currency: userCurrency});

    // STEP 1: Request a proposal from Deriv to get real barriers and price
    send({
      proposal: 1,
      contract_type: 'ACCU',
      symbol: sym,
      amount: currentStake,
      basis: 'stake',
      growth_rate: gr / 100,
      currency: userCurrency
    });

    // Safety timeout: cancel if no response within 12 seconds
    setTimeout(() => {
      if(isBuying && (!con || !con.realId)){
        isBuying = false; pendingProposal = null;
        if(con) { con = null; clearBarriers(); renderNoContract(); }
        toast('Deriv proposal timed out â€” please check connection', 'r', 5000);
      }
    }, 12000);
  }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOSE CONTRACT â€” properly adds profit to balance
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function closeContract(reason,fromAI){
    if(!con)return;
    const stk = con.stake;
    const tks = con.ticks;
    const byAI = con.byAI, realId = con.realId, isReal = con.isReal;

    const won = !['Deriv:lost', 'KO'].includes(reason) && !reason.includes('lost') && !reason.includes('KO');
    
    let finalProfit = won ? parseFloat((con.pnl || 0).toFixed(2)) : -stk;
    let finalPayout = won ? parseFloat((con.payout || stk).toFixed(2)) : 0;

    if(byAI || fromAI){
      if(won) aiWins++; else aiLoss++;
      aiTrades++;
      aiPnl = parseFloat((aiPnl + finalProfit).toFixed(2));
      addHistItem({won, pnl: finalProfit, reason, ticks: tks});
      if(won) showFlash('flashWin', 'WIN +$' + finalProfit.toFixed(2) + ' (' + tks + 't)', 2500);
    }

    // Always send sell to Deriv if we have a real contract ID (real or demo account)
    if(realId && !reason.startsWith('Deriv:')){
      console.log('[Deriv] Selling contract:', realId, '| Reason:', reason);
      send({sell: realId, price: 0});
    }
    // Request balance refresh after settlement
    setTimeout(() => { if(ws && ws.readyState === 1) send({balance: 1}); }, 1500);
    setTimeout(() => { if(ws && ws.readyState === 1) send({balance: 1}); }, 4000);

    isBuying = false; con = null; clearBarriers();
    exitProbability = 0; updateExitMeter(0); $('exitMeter').classList.remove('on');
    renderNoContract(); resetBarrierUI();
    $('sTicks').textContent = '0'; $('sPnl').textContent = '$0.00'; $('sPnl').style.color = 'var(--text)'; $('sPayout').textContent = '$0.00';
    toast((won ? 'âœ… WIN +$' + finalProfit.toFixed(2) : 'âŒ LOSS -$'+stk.toFixed(2)) + ' | ' + reason, won ? 'g' : 'r', 5000);
  }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KNOCK OUT â€” barrier physically hit
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onKO(price){
    if(!con)return;
    const dir=price>=con.upper?'UPPER':'LOWER';
    const loss=con.stake,isReal=con.isReal,ticks=con.ticks,realId=con.realId;
    recordBreak(sym,ticks);updatePatternUI(sym);
    showFlash('flashExit','KO! '+dir+' -$'+loss.toFixed(2),4000);
    $('chartWrap').classList.add('danger');setTimeout(()=>$('chartWrap').classList.remove('danger'),2500);
    if(con.byAI){
      aiLoss++;aiTrades++;
      const actualProfit = -loss;
      aiPnl=parseFloat((aiPnl+actualProfit).toFixed(2));
      addHistItem({won:false,pnl:actualProfit,reason:'BARRIER '+dir+' @'+ticks+'t',ticks});
      // REMOVED KO COOLDOWN: Can re-enter immediately after a loss
      aiCool=false;
    }
    // Always sell to Deriv on KO (real or demo account)
    if(realId){
      console.log('[Deriv] KO sell contract:', realId);
      send({sell:realId,price:0});
    }
    toast('âŒ Barrier hit! -$'+loss.toFixed(2),'r',6000);
    setTimeout(() => { if(ws && ws.readyState === 1) send({balance: 1}); }, 1500);
    isBuying=false;con=null;clearBarriers();
    exitProbability=0;updateExitMeter(0);$('exitMeter').classList.remove('on');
    renderNoContract();resetBarrierUI();
    $('sTicks').textContent='0';$('sPnl').textContent='$0.00';$('sPnl').style.color='var(--text)';$('sPayout').textContent='$0.00';
    // Force vol scan after KO
    if(aiOn){lastVolSwitch=0;setTimeout(()=>doVolScanAndSwitch(true),800);}
  }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTRACT UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateConUI(){
  if(!con){renderNoContract();return;}
  // Ensure we are using 2 decimal places for financial data to match Deriv
  const displayPnl = parseFloat((con.pnl || 0).toFixed(2));
  const displayPayout = parseFloat((con.payout || con.stake).toFixed(2));

  if($('bnTradeDot'))$('bnTradeDot').style.display='block';
  if($('mobSellBtn'))$('mobSellBtn').style.display='block';
  if($('mobPnlRow')){
    const pnlSign = displayPnl >= 0 ? '+' : '-';
    $('mobPnlRow').textContent = 'ðŸ“ˆ P&L: ' + pnlSign + '$' + Math.abs(displayPnl).toFixed(2) + ' | ' + con.ticks + 't';
    $('mobPnlRow').style.color = displayPnl >= 0 ? 'var(--green)' : 'var(--red)';
    $('mobPnlRow').style.display = 'block';
  }
  const pnlColor = displayPnl >= 0 ? 'var(--green)' : 'var(--red)';
  $('sTicks').textContent = con.ticks;
  $('sPnl').textContent = (displayPnl >= 0 ? '+$' : '-$') + Math.abs(displayPnl).toFixed(2);
  $('sPnl').style.color = pnlColor;
  $('sPayout').textContent = '$' + displayPayout.toFixed(2);
  const acctLabel=(()=>{const a=accountList.find(x=>x.loginid===activeLoginid);return a?(a.is_virtual?'DEMO':'REAL'):'REAL';})();
  $('conPanel').innerHTML=
    '<div class="contract-box">'
    +'<div class="con-hdr"><h4>'+(con.byAI?'ðŸ¤– AI ':'')+'ACTIVE ['+acctLabel+']</h4><span class="pulse"></span></div>'
    +'<div class="con-body">'
    +'<div class="con-row"><span>Entry</span><span style="color:var(--blue);">'+con.entry.toFixed(dp)+'</span></div>'
    +'<div class="con-row"><span>Upper</span><span style="color:var(--green);">'+con.upper.toFixed(dp)+'</span></div>'
    +'<div class="con-row"><span>Lower</span><span style="color:var(--red);">'+con.lower.toFixed(dp)+'</span></div>'
    +'<div class="con-row"><span>Ticks</span><span style="color:var(--blue);">'+con.ticks+'</span></div>'
    +'<div class="con-row"><span>Hold Safety</span><span style="color:'+(hs>60?'var(--green)':hs>30?'var(--gold)':'var(--red)')+';font-weight:800;">'+hs+'%</span></div>'
    +'<div class="con-row"><span>Break Risk</span><span style="color:'+rc+';font-weight:800;">'+ep+'%</span></div>'
    +'<div class="pnl-bar"><div class="pnl-fill" style="width:'+barW+'%;background:'+pnlColor+';"></div></div>'
    +'<div class="con-row"><span>P&L</span><span style="color:'+pnlColor+';font-size:14px;font-weight:800;">'+(con.pnl>=0?'+':'-')+'$'+Math.abs(con.pnl).toFixed(2)+'</span></div>'
    +'<div class="con-row"><span>Payout</span><span style="color:var(--gold);font-weight:700;">$'+(con.payout||con.stake).toFixed(2)+'</span></div>'
    +'<div class="con-row"><span>Time</span><span>'+elapsed+'s</span></div>'
    +'<button class="sell-btn" onclick="closeContract(\'Manual\',false)">Sell Now</button>'
    +'</div></div>';
}
function renderNoContract(){
  $('conPanel').innerHTML='<div class="no-con"><div class="ico">ðŸŽ¯</div><div>'+(aiOn?'AI Sniper huntingâ€¦':'No active contract')+'</div><div style="font-size:10px;margin-top:3px;">'+(aiOn?'Analyzing marketsâ€¦':'Click Buy Accumulator')+'</div></div>';
  if($('bnTradeDot'))$('bnTradeDot').style.display='none';
  if($('mobSellBtn'))$('mobSellBtn').style.display='none';
  if($('mobPnlRow'))$('mobPnlRow').style.display='none';
}
function resetBarrierUI(){if(prevP){const bd=barrierDist(prevP);$('bUpper').textContent=(prevP+bd).toFixed(dp);$('bLower').textContent=(prevP-bd).toFixed(dp);}$('bEntry').textContent='â€”';$('bSafety').textContent='â€”';$('infoHold').textContent='â€”';}
function updatePhaseUI(){
  const el=$('sniperSt');el.className='sniper-st';
  if(phase==='HUNTING'){el.classList.add('st-hunt');el.textContent='ðŸŽ¯ HUNTING';}
  else if(phase==='FIRE'){el.classList.add('st-lock');el.textContent='âš¡ FIRING';}
  else if(phase==='IN_TRADE'){el.classList.add('st-lock');el.textContent='âœ… IN TRADE';}
  else if(phase==='EXITING'){el.classList.add('st-exit');el.textContent='ðŸš¨ EXITING!';}
  else{el.classList.add('st-hunt');el.textContent='IDLE';}
}
function addHistItem(obj){
  const h=$('aiHist');
  const empty=h.querySelector('div[style]');if(empty)empty.remove();
  const el=document.createElement('div');
  el.className='hist-item '+(obj.won?'w':'l');
  const dotCol=obj.won?'var(--green)':'var(--red)';
  const pnlCol=obj.won?'var(--green)':'var(--red)';
  const pnlStr=(obj.pnl>=0?'+':'-')+'$'+Math.abs(obj.pnl).toFixed(2);
  el.innerHTML='<div class="hist-dot" style="background:'+dotCol+';"></div>'
    +'<div style="flex:1;">'
    +'<div style="font-weight:700;color:'+pnlCol+';">'+pnlStr+'</div>'
    +'<div style="color:var(--sub);font-size:9px;">'+obj.reason.substring(0,30)+' Â· '+obj.ticks+'t</div></div>'
    +'<div style="font-size:9px;color:var(--sub);">'+new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'})+'</div>';
  h.insertBefore(el,h.firstChild);
  const all=h.querySelectorAll('.hist-item');
  if(all.length>20)all[all.length-1].remove();
}
function addTickRow(price,chg,epoch){
  const up=chg>=0;
  const time=new Date(epoch*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const row=document.createElement('div');row.className='tick-row';
  row.innerHTML='<span class="'+(up?'up':'dn')+'">'+price.toFixed(dp)+'</span>'
    +'<span class="'+(up?'up':'dn')+'">'+(up?'+':'')+chg.toFixed(dp)+'</span>'
    +'<span style="color:var(--sub);">'+time+'</span>';
  const feed=$('tickFeed');feed.insertBefore(row,feed.firstChild);
  const rows=feed.querySelectorAll('.tick-row');
  if(rows.length>MAX_FEED)rows[rows.length-1].remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICE AI â€” ARIA â€” silent by default
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initVoice(){
  function loadVoice(){
    const vs=synth.getVoices();
    ariaVoice=vs.find(v=>v.name.includes('Samantha')||v.name.includes('Google UK English Female')||v.name.includes('Microsoft Zira')||v.name.includes('Karen'))
      ||vs.find(v=>v.lang.startsWith('en')&&v.localService)||vs[0]||null;
  }
  loadVoice();
  if(synth.onvoiceschanged!==undefined)synth.onvoiceschanged=loadVoice;
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){$('vpStatus').textContent='Chrome/Edge needed for voice';return;}
  recognition=new SR();
  recognition.continuous=true;recognition.interimResults=false;recognition.lang='en-US';
  recognition.onstart=()=>{
    $('micBtn').classList.add('listening');$('micBtn').textContent='ðŸ”´';
    $('vpStatus').textContent='Listening â€” EN / Kiswahiliâ€¦';
    $('avatarRing').className='vp-avatar-ring listening';
    $('voiceFab').classList.add('listening');setWave(true);
  };
  recognition.onresult=e=>{
    const r=e.results[e.results.length-1];
    if(!r.isFinal)return;
    const text=r[0].transcript.trim();
    if(text){addVpMsg(text,'user');processVoiceCmd(text);}
  };
  recognition.onerror=e=>{
    if(e.error==='not-allowed'){
      voiceRunning=false;
      $('micBtn').classList.remove('listening');$('micBtn').textContent='ðŸŽ¤';
      $('vpStatus').textContent='Mic blocked â€” allow in browser';setWave(false);
    }
  };
  recognition.onend=()=>{
    if(voiceRunning&&!isSpeaking){
      clearTimeout(voiceRestartTimer);
      voiceRestartTimer=setTimeout(()=>{if(voiceRunning)try{recognition.start();}catch(e){}},300);
    }else if(!voiceRunning){
      $('micBtn').classList.remove('listening');$('micBtn').textContent='ðŸŽ¤';
      $('avatarRing').className='vp-avatar-ring';
      $('voiceFab').classList.remove('listening');setWave(false);
      $('vpStatus').textContent='Silent â€” tap mic to activate';
    }
  };
}

function startListen(){
  if(!recognition)return;voiceRunning=true;
  try{recognition.abort();setTimeout(()=>recognition.start(),200);}
  catch(e){try{recognition.start();}catch(e2){}}
  $('vpStatus').textContent='Listening â€” EN / Kiswahiliâ€¦';
}
function stopListen(){
  voiceRunning=false;clearTimeout(voiceRestartTimer);
  try{recognition.abort();}catch(e){}
  $('micBtn').classList.remove('listening');$('micBtn').textContent='ðŸŽ¤';
  $('avatarRing').className='vp-avatar-ring';$('voiceFab').classList.remove('listening');
  setWave(false);$('vpStatus').textContent='Silent â€” tap mic to activate';
}

function ariaSpeak(text){
  if(!synth||!text)return;
  synth.cancel();
  const utt=new SpeechSynthesisUtterance(text);
  if(ariaVoice)utt.voice=ariaVoice;
  utt.rate=1.05;utt.pitch=1.1;utt.volume=1.0;
  utt.onstart=()=>{
    isSpeaking=true;$('vpStatus').textContent='Speakingâ€¦';
    $('avatarRing').className='vp-avatar-ring speaking';setWave(true);
    if(voiceRunning)try{recognition.abort();}catch(e){}
  };
  utt.onend=utt.onerror=()=>{
    isSpeaking=false;
    $('avatarRing').className=voiceRunning?'vp-avatar-ring listening':'vp-avatar-ring';
    setWave(voiceRunning);
    if(voiceRunning){clearTimeout(voiceRestartTimer);voiceRestartTimer=setTimeout(()=>{$('vpStatus').textContent='Listeningâ€¦';try{recognition.start();}catch(e){}},400);}
    else $('vpStatus').textContent='Silent â€” tap mic to activate';
  };
  synth.speak(utt);addVpMsg(text,'ai');
}

function setWave(on){for(let i=1;i<=7;i++){const b=$('vb'+i);if(b)b.classList.toggle('active',on);}}
function addVpMsg(text,who){
  const chat=$('vpChat'),el=document.createElement('div');
  el.className='vp-msg '+who;
  el.innerHTML='<div>'+text+'</div><div class="vp-msg-time">'+new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'})+'</div>';
  chat.appendChild(el);chat.scrollTop=chat.scrollHeight;
}

function isSW(t){
  return['habari','mambo','salama','vipi','sawa','asante','tafadhali','ndiyo','hapana',
    'anza','simama','acha','weka','ongeza','punguza','badilisha','angalia','tafuta',
    'biashara','faida','salio','pesa','kiasi','soko','ninashikilia','ninatoka',
    'karibu','hujambo','niaje','sasa','nzuri','vizuri'].some(w=>t.includes(w));
}

function processVoiceCmd(text){
  const t=text.toLowerCase().trim();
  const sw=isSW(t);
  let reply='';
  if(/\b(stop|simama|zima|acha|sitisha)\b.*(ai|bot|sniper|trade|biashara)/i.test(t)){
    if(aiOn){$('aiToggle').checked=false;$('aiToggle').dispatchEvent(new Event('change'));}
    reply=sw?'AI imesimamishwa.':'AI Sniper stopped.';
  }else if(/\b(start|anza|washa|amsha|fungua)\b.*(ai|bot|sniper|trade|biashara)/i.test(t)){
    if(!aiOn){$('aiToggle').checked=true;$('aiToggle').dispatchEvent(new Event('change'));}
    reply=sw?'AI Sniper imeanzishwa!':'AI Sniper is now active!';
  }else if(/\b(scan|tafuta|angalia|best|bora)\b.*(market|soko|volatil)/i.test(t)){
    doVolScanAndSwitch(false);reply=sw?'Ninachunguza masoko yote.':'Scanning all markets now.';
  }else if(/\b(balance|salio|pesa|kuna ngapi|ninayo)\b/i.test(t)){
    const b=realBalance!=null?userCurrency+' '+realBalance.toFixed(2):'not available';
    const pt=aiPnl>=0?'up $'+aiPnl.toFixed(2):'down $'+Math.abs(aiPnl).toFixed(2);
    reply=sw?'Salio lako ni '+b+'. AI imefanya '+pt+'.':'Your balance is '+b+'. AI P&L is '+pt+'.';
  }else if(/\b(profit|faida|stats|takwimu|wins)\b/i.test(t)){
    const wr=aiTrades>0?((aiWins/aiTrades)*100).toFixed(0)+'%':'no trades yet';
    reply=sw?'Biashara: '+aiTrades+'. Ushindi: '+aiWins+'. Kiwango: '+wr+'. Faida: $'+aiPnl.toFixed(2)+'.'
      :'Total trades: '+aiTrades+'. Wins: '+aiWins+'. Win rate: '+wr+'. P&L: $'+aiPnl.toFixed(2)+'.';
  }else if(/\b(sell|uza|funga|toka|close|exit)\b/i.test(t)){
    if(con){closeContract('Voice',false);reply=sw?'Ninafunga biashara.':'Closing trade now.';}
    else reply=sw?'Hakuna biashara wazi.':'No active trade.';
  }else if(/\b(buy|nunua|open)\b/i.test(t)){
    if(con)reply=sw?'Biashara iko wazi tayari.':'Already in a trade.';
    else{buyContract(false);reply=sw?'Ninafungua biashara.':'Opening a trade now.';}
  }else if(/(\d+(\.\d+)?).*(stake|kiasi)|stake.*(\d+(\.\d+)?)/i.test(t)){
    const m=t.match(/\d+(\.\d+)?/);
    if(m){stake=Math.min(50000,Math.max(1,parseFloat(m[0])));$('stkInput').value=stake;$('stkRange').value=Math.min(stake,1000);reply=sw?'Kiasi kimewekwa $'+stake+'.':'Stake set to $'+stake+'.';}
    else reply=sw?'Sema nambari.':'Please say the amount.';
  }else if(/\b(stop listening|acha kusikiliza|zima sauti)\b/i.test(t)){
    stopListen();reply=sw?'Nimesimama kusikiliza.':'Stopped listening.';
  }else if(/\b(price|bei|thamani|quote)\b/i.test(t)){
    reply=sw?'Bei ya sasa ya '+sym+' ni '+(prevP?prevP.toFixed(dp):'haijulikani')+'.'
      :'Current price of '+sym+' is '+(prevP?prevP.toFixed(dp):'unknown')+'.';
  }else if(/\b(what|unafanya|nini|hali|doing|explain)\b/i.test(t)){
    if(aiOn){
      if(con){const hs=prevP?computeHoldScore(prevP,con,tickBuf):50;reply=sw?'Ninashikilia biashara. Usalama: '+hs+'%. Hatari: '+exitProbability+'%.'
        :'Holding trade on '+sym+'. Safety: '+hs+'%. Break risk: '+exitProbability+'%.';}
      else reply=sw?'Ninatafuta fursa nzuri kwenye '+sym+'.'
        :'Hunting for best entry on '+sym+'. '+tickBuf.length+' ticks analyzed.';
    }else reply=sw?'AI imezimwa.':'AI is off. Say start AI to begin.';
  }else if(/\b(hello|hi|hey|habari|mambo|salama|vipi|hujambo|niaje)\b/i.test(t)){
    reply=sw?'Habari! Mimi ni ARIA. Ninakusikia! Niambie unachohitaji.'
      :'Hello! I am ARIA. I understand English and Kiswahili. What do you need?';
  }else if(/\b(help|msaada|amri|commands)\b/i.test(t)){
    reply=sw?'Unaweza kusema: anza AI, simama AI, salio, tafuta soko, uza, bei, faida.'
      :'You can say: start AI, stop AI, balance, scan markets, sell, price, profit, or ask me anything!';
  }else if(/\b(thanks|asante|sawa|nzuri|vizuri|perfect|great|okay)\b/i.test(t)){
    reply=sw?'Karibu sana!':'You are welcome! Always here for you.';
  }else if(/\b(switch|badilisha|nenda)\b.*(v10|v25|v50|v75|v100|volatility)/i.test(t)){
    const symMatch=t.match(/v(10|25|50|75|100)/i);
    if(symMatch){const sv='R_'+symMatch[1];const sInfo=ALL_SYMS.find(s=>s.sym===sv);if(sInfo){switchSym(sInfo.sym,sInfo.dp);reply=sw?'Nimebadilisha hadi Volatility '+symMatch[1]+'.':'Switched to Volatility '+symMatch[1]+'.';}}
  }else if(/\b(growth|kiwango|rate)\b.*\b([1-5])\b/i.test(t)){
    const m=t.match(/\b([1-5])\b/);
    if(m){gr=parseInt(m[1]);document.querySelectorAll('.gr-btn').forEach(b=>b.classList.toggle('active',parseInt(b.dataset.r)===gr));$('sGrowth').textContent=gr+'%';reply=sw?'Kiwango '+gr+'%.':'Growth rate '+gr+'%.';}
  }else if(t.includes('?')){
    if(aiOn&&con)reply=sw?'Biashara ipo. Hatari: '+exitProbability+'%.':'Trade active. Break risk: '+exitProbability+'%.';
    else reply=sw?'Swali zuri! Niulize kingine.':'Good question! Ask me anything about trading.';
  }else{
    reply=sw?'Nimesikia! '+text.substring(0,35)+'. Niambie zaidi.':'Got it: '+text.substring(0,55)+'. How can I help?';
  }
  if(reply)setTimeout(()=>ariaSpeak(reply),200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLeft(){$('leftPanel').classList.add('open');$('panelOverlay').classList.add('on');}
function closeLeft(){$('leftPanel').classList.remove('open');$('panelOverlay').classList.remove('on');}
function openRight(){$('rightPanel').classList.add('open');$('panelOverlay').classList.add('on');}
function closeRight(){$('rightPanel').classList.remove('open');$('panelOverlay').classList.remove('on');}
function closeAllPanels(){closeLeft();closeRight();}

function setupMobile(){
  const mq860=window.matchMedia('(max-width:860px)');
  const mq1060=window.matchMedia('(max-width:1060px)');
  function apply(){
    $('menuBtn').style.display=mq860.matches?'block':'none';
    $('rightBtn').style.display=mq1060.matches?'flex':'none';
  }
  apply();mq860.addEventListener('change',apply);mq1060.addEventListener('change',apply);
  $('menuBtn').addEventListener('click',()=>$('leftPanel').classList.contains('open')?closeLeft():openLeft());
  $('mobLeftBtn').addEventListener('click',openLeft);
  $('mobRightBtn').addEventListener('click',openRight);
  $('rightBtn').addEventListener('click',()=>$('rightPanel').classList.contains('open')?closeRight():openRight());
  $('panelOverlay').addEventListener('click',closeAllPanels);
  $('bnLeft').addEventListener('click',()=>{closeRight();openLeft();setBnav('bnLeft');});
  $('bnChart').addEventListener('click',()=>{closeAllPanels();setBnav('bnChart');});
  $('bnRight').addEventListener('click',()=>{closeLeft();openRight();setBnav('bnRight');});
  $('bnVoice').addEventListener('click',()=>{toggleVP();setBnav('bnVoice');});
}
function setBnav(id){document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.toggle('active',b.id===id));}

function toggleVP(){
  voiceOpen=!voiceOpen;
  $('voicePanel').classList.toggle('open',voiceOpen);
  $('voiceFab').style.display=voiceOpen?'none':'flex';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupEvents(){
  $('aiToggle').addEventListener('change',function(){
    aiOn=this.checked;
    if(aiOn && (!authed || !activeToken)){
      this.checked=false;aiOn=false;
      toast('âš ï¸ Login to your Deriv account to enable AI trading','y',5000);
      showLogin();return;
    }
    $('aiBody').classList.toggle('on',aiOn);
    $('aiOv').classList.toggle('on',aiOn);
    if(aiOn){
      phase='HUNTING';aiCool=false;exitingNow=false;updatePhaseUI();
      const acctLbl=(()=>{const a=accountList.find(x=>x.loginid===activeLoginid);return a?(a.is_virtual?'Demo':'Real'):'Real';})();
      $('sbAI').style.color='var(--purple)';toast('ðŸ¤– AI Sniper ACTIVE on '+acctLbl+' Account','p');
      lastVolSwitch=0;setTimeout(()=>doVolScanAndSwitch(false),1500);
    }else{
      phase='IDLE';updatePhaseUI();
      $('sbAI').textContent='AI:OFF';$('sbAI').style.color='var(--sub)';
      if(con&&con.byAI)closeContract('AI disabled',false);
    }
  });

  $('symList').addEventListener('click',e=>{const b=e.target.closest('.sym-btn');if(!b)return;switchSym(b.dataset.sym,parseInt(b.dataset.dp));closeLeft();});

  $('grGrid').addEventListener('click',e=>{
    const b=e.target.closest('.gr-btn');if(!b)return;
    document.querySelectorAll('.gr-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');gr=parseInt(b.dataset.r);$('sGrowth').textContent=gr+'%';
  });

  $('stkInput').addEventListener('input',()=>{stake=parseFloat($('stkInput').value)||10;$('stkRange').value=Math.min(stake,1000);});
  $('stkRange').addEventListener('input',()=>{stake=parseInt($('stkRange').value);$('stkInput').value=stake;});
  $('stkUp').addEventListener('click',()=>{stake=Math.min(50000,stake+1);$('stkInput').value=stake;$('stkRange').value=Math.min(stake,1000);});
  $('stkDn').addEventListener('click',()=>{stake=Math.max(1,stake-1);$('stkInput').value=stake;$('stkRange').value=stake;});

  $('tpToggle').addEventListener('change',function(){const on=this.checked;$('tpInput').disabled=!on;$('tpInput').style.opacity=on?'1':'.4';tp=on?parseFloat($('tpInput').value):null;});
  $('tpInput').addEventListener('input',()=>{tp=$('tpToggle').checked?parseFloat($('tpInput').value):null;});

  $('buyBtn').addEventListener('click',()=>{
    if(!authed||!activeToken){toast('âš ï¸ Login to your Deriv account first','y',4000);showLogin();return;}
    if(con){toast('Sell first','r');return;}
    buyContract(false);
  });
  $('scanVolBtn').addEventListener('click',()=>doVolScanAndSwitch(false));
  $('scanClose').addEventListener('click',()=>$('scanOverlay').classList.remove('open'));
  $('scanOverlay').addEventListener('click',e=>{if(e.target===$('scanOverlay'))$('scanOverlay').classList.remove('open');});
  $('logoutBtn').addEventListener('click',logout);
  $('voiceFab').addEventListener('click',toggleVP);
  $('vpClose').addEventListener('click',()=>{voiceOpen=false;$('voicePanel').classList.remove('open');$('voiceFab').style.display='flex';});
  $('micBtn').addEventListener('click',()=>{
    if(voiceRunning){stopListen();toast('ðŸ”‡ ARIA paused','y');}
    else{startListen();toast('ðŸŽ¤ ARIA listening','p');}
  });
  $('vpSend').addEventListener('click',sendText);
  $('vpTextInput').addEventListener('keydown',e=>{if(e.key==='Enter')sendText();});
}
function sendText(){const v=$('vpTextInput').value.trim();if(!v)return;addVpMsg(v,'user');$('vpTextInput').value='';processVoiceCmd(v);}
</script>
</body>
</html>
